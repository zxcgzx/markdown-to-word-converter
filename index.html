<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarkdownËΩ¨WordÊ†ºÂºèËΩ¨Êç¢Âô®</title>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.0.0/marked.min.js"></script>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- KaTeXÊï∞Â≠¶ÂÖ¨ÂºèÊîØÊåÅ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
    <style>
        /* Ê∏©ÊöñÁê•ÁèÄ‰∏ªÈ¢ò‰Ωú‰∏∫ÈªòËÆ§‰∏ªÈ¢ò */
        :root {
            --bg-gradient-start: #ffeaa7;
            --bg-gradient-end: #fab1a0;
            --container-bg: rgba(255, 255, 255, 0.95);
            --header-gradient-start: #0984e3;
            --header-gradient-end: #00b894;
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --text-muted: #b2bec3;
            --text-white: #ffffff;
            --border-color: rgba(255, 234, 167, 0.6);
            --border-focus: #0984e3;
            --preview-bg: rgba(255, 255, 255, 0.8);
            --controls-bg: rgba(255, 255, 255, 0.9);
            --card-bg: rgba(255, 255, 255, 0.85);
            --accent-primary: #0984e3;
            --accent-secondary: #00b894;
            --success: #00b894;
            --warning: #e17055;
            --info: #74b9ff;
            --shadow: rgba(255, 177, 160, 0.2);
            --shadow-hover: rgba(9, 132, 227, 0.15);
            --shadow-focus: rgba(9, 132, 227, 0.25);
            --transition: all 0.18s ease-out;
            --blur: blur(15px);
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 234, 167, 0.3);
        }

        /* ÁªèÂÖ∏‰∏ªÈ¢ò - ÂéüÂßãÈÖçËâ≤ÊñπÊ°à */
        [data-theme="classic"] {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --container-bg: #ffffff;
            --header-gradient-start: #4CAF50;
            --header-gradient-end: #45a049;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #999999;
            --text-white: #ffffff;
            --border-color: #e0e0e0;
            --border-focus: #4CAF50;
            --preview-bg: #fafafa;
            --controls-bg: #f8f9fa;
            --card-bg: #ffffff;
            --accent-primary: #4CAF50;
            --accent-secondary: #2196F3;
            --success: #4CAF50;
            --warning: #ff9800;
            --info: #2196F3;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-hover: rgba(76, 175, 80, 0.3);
            --shadow-focus: rgba(76, 175, 80, 0.4);
            --transition: all 0.3s ease;
            --blur: blur(8px);
            --glass-bg: #ffffff;
            --glass-border: #e0e0e0;
        }

        /* ÁªèÂÖ∏‰∏ªÈ¢òÁâπÊÆäÊ†∑ÂºèÂ§ÑÁêÜ */
        [data-theme="classic"] .container {
            background: var(--container-bg);
            border-radius: 15px;
            box-shadow: 0 20px 40px var(--shadow);
            backdrop-filter: none;
            border: none;
        }

        [data-theme="classic"] .btn {
            backdrop-filter: none;
            border: none;
            box-shadow: 0 4px 15px var(--shadow-hover);
        }

        [data-theme="classic"] .btn-secondary {
            backdrop-filter: none;
            box-shadow: 0 1px 3px var(--shadow);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 10px;
            margin: 0;
            transition: var(--transition);
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            animation: float 20s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(10px, -10px) rotate(1deg); }
            66% { transform: translate(-5px, 5px) rotate(-1deg); }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--glass-bg);
            border-radius: 24px;
            box-shadow: 
                0 8px 32px var(--shadow),
                0 0 0 1px var(--glass-border),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: var(--blur);
            overflow: hidden;
            min-height: calc(100vh - 20px);
            transition: var(--transition);
            position: relative;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--glass-border), transparent);
        }

        .header {
            background: linear-gradient(135deg, var(--header-gradient-start), var(--header-gradient-end));
            color: var(--text-white);
            text-align: center;
            padding: 32px;
            position: relative;
            transition: var(--transition);
            backdrop-filter: var(--blur);
            box-shadow: 0 1px 0 0 rgba(255, 255, 255, 0.1) inset;
        }

        /* ‰∏ªÈ¢òÂàáÊç¢Âô®Ê†∑Âºè */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 8px 16px;
            color: var(--text-white);
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
            overflow: hidden;
            position: relative;
        }

        .theme-toggle::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px) scale(1.02);
        }

        .theme-toggle:hover::after {
            left: 100%;
        }

        .theme-toggle.switching {
            animation: themeSwitch 0.8s ease;
        }

        .theme-toggle::before {
            content: 'üé®';
            font-size: 16px;
            transition: transform 0.3s ease;
        }

        .theme-toggle:hover::before {
            transform: rotate(180deg);
        }

        @keyframes themeSwitch {
            0% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(90deg); }
            50% { transform: scale(1.05) rotate(180deg); }
            75% { transform: scale(1.1) rotate(270deg); }
            100% { transform: scale(1) rotate(360deg); }
        }

        /* ‰∏ªÈ¢òÂàáÊç¢ËøáÊ∏°ÊïàÊûú */
        .theme-transition {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), var(--new-bg) 0%, transparent 70%);
            pointer-events: none;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.6s ease;
        }

        .theme-transition.active {
            opacity: 1;
        }

        /* Êó†ÈöúÁ¢çÊîØÊåÅ */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* È´òÂØπÊØîÂ∫¶Ê®°ÂºèÊîØÊåÅ */
        @media (prefers-contrast: high) {
            :root {
                --text-primary: #000000;
                --text-secondary: #333333;
                --border-color: #000000;
                --border-focus: #0000ff;
                --accent-primary: #0000ff;
                --accent-secondary: #000080;
            }
        }

        /* ÂáèÂ∞ëÂä®ÁîªÊ®°ÂºèÊîØÊåÅ */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .theme-toggle.switching {
                animation: none;
            }
            
            .theme-transition {
                transition: none;
            }
        }

        /* ÈîÆÁõòÁÑ¶ÁÇπÊåáÁ§∫Âô® */
        .btn:focus-visible,
        .theme-toggle:focus-visible,
        #markdownInput:focus-visible,
        .password-input:focus-visible {
            outline: 3px solid var(--border-focus);
            outline-offset: 2px;
        }

        .quick-action-btn:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 1px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .author-info {
            font-size: 0.9em;
            opacity: 0.8;
            font-style: italic;
        }

        .author-info .author-name {
            font-weight: bold;
            color: #E8F5E8;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
            min-height: 500px;
        }

        .input-section, .preview-section {
            display: flex;
            flex-direction: column;
        }

        .section-title {
            font-size: 1.3em;
            color: var(--text-primary);
            margin-bottom: 15px;
            font-weight: 600;
            transition: var(--transition);
        }

        #markdownInput {
            width: 100%;
            height: 400px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: var(--transition);
            line-height: 1.5;
            background: var(--container-bg);
            color: var(--text-primary);
        }

        #markdownInput:focus {
            outline: none;
            border-color: var(--border-focus);
        }

        #preview {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            min-height: 400px;
            background: var(--preview-bg);
            overflow-y: auto;
            transition: var(--transition);
            color: var(--text-primary);
        }

        .controls {
            padding: 30px;
            background: var(--controls-bg);
            border-top: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .control-group {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: var(--blur);
            transition: var(--transition);
        }

        .control-group:hover {
            border-color: var(--border-focus);
            transform: translateY(-1px);
        }

        .control-group-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group-desc {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .control-buttons .btn {
            margin: 0;
            flex: 1;
            min-width: 90px;
            font-size: 13px;
            padding: 12px 16px;
        }

        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .control-buttons {
                flex-direction: column;
            }
            
            .control-buttons .btn {
                min-width: unset;
            }
        }

        .btn {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--text-white);
            border: none;
            padding: 14px 28px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            margin: 0 8px;
            transition: var(--transition);
            box-shadow: 
                0 4px 14px var(--shadow-hover),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            backdrop-filter: var(--blur);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 8px 24px var(--shadow-focus),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            filter: brightness(1.05) saturate(1.1);
        }

        .btn:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 14px var(--shadow-hover);
        }

        /* AI‰øÆÂ§çÊåâÈíÆÁâπÊÆäÊ†∑Âºè */
        .ai-fix-btn {
            background: linear-gradient(135deg, #ff6b6b, #ff8e53) !important;
            position: relative;
            overflow: hidden;
        }

        .ai-fix-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }

        .ai-fix-btn:hover::before {
            left: 100%;
        }

        .ai-fix-btn:hover {
            background: linear-gradient(135deg, #ff5252, #ff7043) !important;
            transform: translateY(-2px);
            box-shadow: 
                0 8px 24px rgba(255, 107, 107, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            filter: brightness(1.1) saturate(1.2);
        }

        .ai-fix-btn:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(255, 107, 107, 0.3);
        }

        /* AI‰øÆÂ§çÂäüËÉΩÁªÑÊ†∑Âºè */
        .ai-usage-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 6px;
            border-left: 3px solid #ff6b6b;
        }

        .ai-usage-info span {
            font-weight: 600;
            color: #ff6b6b;
        }

        /* AIÈÖçÁΩÆÊ®°ÊÄÅÊ°ÜÂä®Áîª */
        .ai-config-modal {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .example-section {
            margin: 20px 0;
        }

        .example-btn {
            background: #2196F3;
            font-size: 14px;
            padding: 8px 20px;
        }

        .example-btn:hover {
            background: #1976D2;
        }

        /* Âπ≥ÊùøÁ´Ø‰ºòÂåñ */
        @media (max-width: 1024px) {
            .container {
                margin: 5px;
                border-radius: 10px;
            }
            
            .main-content {
                padding: 15px;
                gap: 15px;
            }
            
            .controls-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
        }

        /* ÁßªÂä®Á´Ø‰ºòÂåñ */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .container {
                border-radius: 8px;
                min-height: calc(100vh - 10px);
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
                margin-bottom: 8px;
            }
            
            .header p {
                font-size: 1em;
                margin-bottom: 10px;
            }
            
            .author-info {
                font-size: 0.8em;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                padding: 15px;
                gap: 20px;
            }
            
            #markdownInput {
                height: 300px;
                font-size: 16px; /* Èò≤Ê≠¢iOSÁº©Êîæ */
                padding: 12px;
            }
            
            #preview {
                min-height: 300px;
                padding: 15px;
            }
            
            .controls {
                padding: 20px 15px;
                text-align: center;
            }
            
            .btn {
                margin: 5px;
                padding: 12px 20px;
                font-size: 14px;
                display: inline-block;
                min-width: 120px;
            }
            
            .btn-secondary {
                padding: 10px 16px;
                font-size: 13px;
                min-width: 100px;
            }
            
            .shortcut-info {
                font-size: 0.8em;
                margin-top: 10px;
                line-height: 1.4;
            }
            
            .word-count {
                position: static;
                margin-top: 5px;
                text-align: right;
                background: none;
                font-size: 11px;
            }
            
            .drag-hint::after {
                font-size: 11px;
                bottom: -20px;
            }
        }

        /* Â∞èÂ±èÊâãÊú∫‰ºòÂåñ */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .header p {
                font-size: 0.9em;
            }
            
            .author-info {
                font-size: 0.75em;
            }
            
            .main-content {
                padding: 10px;
            }
            
            #markdownInput {
                height: 250px;
                padding: 10px;
                font-size: 16px;
            }
            
            #preview {
                min-height: 250px;
                padding: 12px;
            }
            
            .controls {
                padding: 15px 10px;
            }
            
            .btn {
                width: calc(50% - 10px);
                margin: 3px 5px;
                padding: 10px 8px;
                font-size: 13px;
            }
            
            .btn-secondary {
                width: calc(50% - 10px);
                margin: 3px 5px;
                padding: 8px 6px;
                font-size: 12px;
            }
            
            .shortcut-info {
                font-size: 0.7em;
                padding: 0 5px;
            }
            
            .section-title {
                font-size: 1.1em;
                margin-bottom: 10px;
            }
        }

        /* È¢ÑËßàÊ†∑Âºè */
        #preview h1, #preview h2, #preview h3, #preview h4, #preview h5, #preview h6 {
            color: #333;
            margin: 20px 0 10px 0;
        }

        #preview h1 { font-size: 2em; }
        #preview h2 { font-size: 1.7em; }
        #preview h3 { font-size: 1.4em; }

        #preview p {
            margin: 10px 0;
            line-height: 1.6;
        }

        #preview ul, #preview ol {
            margin: 10px 0;
            padding-left: 30px;
        }

        #preview li {
            margin: 5px 0;
        }

        #preview code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }

        #preview pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
        }

        #preview blockquote {
            border-left: 4px solid #4CAF50;
            margin: 15px 0;
            padding: 10px 20px;
            background: #f9f9f9;
        }

        #preview table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
        }

        #preview th, #preview td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        #preview th {
            background-color: #f2f2f2;
        }

        /* È¢ÑËßàÂå∫Á©∫Áä∂ÊÄÅ */
        .preview-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 350px;
            text-align: center;
            color: var(--text-muted);
            background: linear-gradient(135deg, var(--preview-bg) 0%, rgba(255, 255, 255, 0.5) 100%);
            border-radius: 8px;
        }

        .preview-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.6;
            animation: float-gentle 3s ease-in-out infinite;
        }

        .preview-empty-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .preview-empty-subtitle {
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .preview-quick-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .quick-action-btn {
            padding: 8px 16px;
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
            backdrop-filter: var(--blur);
        }

        .quick-action-btn:hover {
            background: var(--accent-primary);
            color: var(--text-white);
            border-color: var(--accent-primary);
            transform: translateY(-1px);
        }

        @keyframes float-gentle {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        /* Ëá™ÂÆö‰πâÁ°ÆËÆ§ÂØπËØùÊ°Ü */
        .custom-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .custom-dialog.show {
            opacity: 1;
            visibility: visible;
        }

        .dialog-content {
            background: var(--glass-bg);
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.15),
                0 0 0 1px var(--glass-border);
            backdrop-filter: var(--blur);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .custom-dialog.show .dialog-content {
            transform: scale(1);
        }

        .dialog-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .dialog-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .dialog-message {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .dialog-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .dialog-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .dialog-btn-primary {
            background: var(--accent-primary);
            color: var(--text-white);
        }

        .dialog-btn-primary:hover {
            background: var(--accent-secondary);
            transform: translateY(-1px);
        }

        .dialog-btn-secondary {
            background: var(--glass-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .dialog-btn-secondary:hover {
            background: var(--preview-bg);
            border-color: var(--border-focus);
        }

        /* ToastÈÄöÁü•Ê†∑Âºè */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10002;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 12px 16px;
            max-width: 300px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            backdrop-filter: var(--blur);
            transform: translateX(320px);
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .toast-message {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .toast.success {
            border-color: var(--success);
        }

        .toast.success .toast-icon {
            color: var(--success);
        }

        .toast.error {
            border-color: var(--warning);
        }

        .toast.error .toast-icon {
            color: var(--warning);
        }

        .toast.info {
            border-color: var(--info);
        }

        .toast.info .toast-icon {
            color: var(--info);
        }

        /* ÊãñÊãΩÊèêÁ§∫Ê†∑Âºè */
        .drag-hint {
            position: relative;
        }

        .drag-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-white);
            font-size: 18px;
            font-weight: 600;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 10;
            backdrop-filter: blur(10px);
            border: 3px dashed rgba(255, 255, 255, 0.8);
        }

        .drag-overlay.show {
            opacity: 0.95;
            visibility: visible;
        }

        .drag-overlay-icon {
            font-size: 48px;
            margin-bottom: 12px;
            animation: bounce 1s infinite;
        }

        .drag-overlay-text {
            text-align: center;
            line-height: 1.4;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Êï∞Â≠¶ÂÖ¨ÂºèÊ∏≤ÊüìÁä∂ÊÄÅÊåáÁ§∫Âô® */
        .math-rendering-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--info);
            color: var(--text-white);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            display: none;
            align-items: center;
            gap: 4px;
            z-index: 5;
            animation: pulse 1.5s infinite;
        }

        .math-rendering-indicator.show {
            display: flex;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Êï∞Â≠¶ÂÖ¨ÂºèÊ∏≤ÊüìÈîôËØØÊèêÁ§∫ */
        .math-error {
            background: var(--warning);
            color: var(--text-white);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            margin: 5px 0;
            display: inline-block;
        }

        .drag-hint-text {
            position: absolute;
            bottom: -30px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            opacity: 0.8;
            transition: var(--transition);
        }

        .drag-hint-text::before {
            content: "üí° ";
        }

        /* Âø´Êç∑ÈîÆÊèêÁ§∫ */
        .shortcut-info {
            margin-top: 15px;
            font-size: 0.9em;
            color: #666;
            text-align: center;
        }

        .shortcut-info strong {
            color: #4CAF50;
        }

        /* Áä∂ÊÄÅÊåáÁ§∫Âô® */
        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 15px;
            background: #4CAF50;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .status-indicator.show {
            opacity: 1;
        }

        .status-indicator.error {
            background: #f44336;
        }

        .status-indicator.info {
            background: #2196F3;
        }

        /* ÊîπËøõÊåâÈíÆÊ†∑Âºè */
        .btn-secondary {
            background: var(--glass-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            box-shadow: 
                0 2px 8px var(--shadow),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            font-size: 14px;
            padding: 10px 20px;
        }

        .btn-secondary:hover {
            background: var(--preview-bg);
            border-color: var(--border-focus);
            color: var(--accent-primary);
            transform: translateY(-1px);
            box-shadow: 
                0 4px 12px var(--shadow-hover),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        /* Êñá‰ª∂ËæìÂÖ•Âå∫Âüü‰ºòÂåñ */
        .input-section {
            position: relative;
        }

        /* Â≠óÊï∞ÁªüËÆ° */
        .input-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding: 8px 12px;
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            backdrop-filter: var(--blur);
            transition: var(--transition);
        }

        .input-stats .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .input-stats .stat-value {
            font-weight: 600;
            color: var(--accent-primary);
            font-size: 14px;
        }

        .input-stats .stat-label {
            font-size: 11px;
            opacity: 0.8;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* ÈïøÊñáÊ°£Ëß£ÊûêËøõÂ∫¶ÊåáÁ§∫Âô®Ê†∑Âºè */
        .parse-progress-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            backdrop-filter: var(--blur);
            padding: 16px 20px;
            border-radius: 12px;
            min-width: 280px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.1),
                0 0 0 1px var(--glass-border);
            z-index: 10;
            display: none;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .parse-progress-indicator.show {
            display: block;
            opacity: 1;
        }

        .parse-progress-indicator .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .parse-progress-indicator .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
            animation: progressShimmer 2s infinite;
        }

        .parse-progress-indicator .progress-text {
            text-align: center;
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        @keyframes progressShimmer {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* WordËΩ¨Êç¢ËøõÂ∫¶ÊåáÁ§∫Âô®Ê†∑Âºè */
        .word-conversion-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            backdrop-filter: var(--blur);
            padding: 20px 24px;
            border-radius: 16px;
            min-width: 320px;
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.15),
                0 0 0 1px var(--glass-border);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .word-conversion-indicator.show {
            display: block;
            opacity: 1;
        }

        .word-conversion-indicator .conversion-icon {
            text-align: center;
            font-size: 32px;
            margin-bottom: 16px;
            animation: bounce 1.5s infinite;
        }

        .word-conversion-indicator .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .word-conversion-indicator .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 4px;
            transition: width 0.4s ease;
            width: 0%;
            position: relative;
            overflow: hidden;
        }

        .word-conversion-indicator .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        .word-conversion-indicator .progress-text {
            text-align: center;
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { 
                transform: translateY(0); 
            }
            40% { 
                transform: translateY(-8px); 
            }
            60% { 
                transform: translateY(-4px); 
            }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* ÂØÜÁ†ÅÁïåÈù¢Âä®ÁîªÊïàÊûú */
        @keyframes backgroundShift {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(20deg); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) scale(1); }
            33% { transform: translateY(-10px) scale(1.02); }
            66% { transform: translateY(5px) scale(0.98); }
        }

        @keyframes modalEntrance {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(40px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes titleSlideIn {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes errorShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }

        @keyframes fadeOut {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0.95);
            }
        }

        /* ÂØÜÁ†ÅÈ™åËØÅÁïåÈù¢Ê†∑Âºè - ÁéªÁíÉÊãüÊÄÅÂçáÁ∫ßÁâà */
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: backgroundShift 20s ease-in-out infinite;
        }

        .password-overlay::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
            animation: float 15s ease-in-out infinite;
        }

        .password-modal {
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            border: 1px solid var(--glass-border);
            padding: 48px;
            border-radius: 24px;
            box-shadow: 
                0 32px 64px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.05);
            text-align: center;
            max-width: 420px;
            width: 90%;
            position: relative;
            overflow: hidden;
            animation: modalEntrance 0.6s ease-out;
        }

        .password-modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        }

        .password-modal h2 {
            color: var(--text-primary);
            margin-bottom: 12px;
            font-size: 2em;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            animation: titleSlideIn 0.8s ease-out 0.2s both;
        }

        .password-modal .subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 1.1em;
            font-weight: 500;
            animation: titleSlideIn 0.8s ease-out 0.3s both;
        }

        .password-modal .beta-info {
            background: linear-gradient(135deg, rgba(255, 243, 205, 0.9), rgba(255, 234, 167, 0.8));
            border: 1px solid rgba(255, 234, 167, 0.6);
            color: #856404;
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 28px;
            font-size: 0.95em;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 12px rgba(255, 234, 167, 0.3);
            animation: fadeInUp 0.8s ease-out 0.4s both;
        }

        .password-input-wrapper {
            position: relative;
            margin-bottom: 20px;
            animation: fadeInUp 0.8s ease-out 0.5s both;
        }

        .password-input {
            width: 100%;
            padding: 18px 24px;
            border: 2px solid var(--border-color);
            border-radius: 16px;
            font-size: 16px;
            text-align: center;
            box-sizing: border-box;
            background: var(--glass-bg);
            backdrop-filter: blur(8px);
            color: var(--text-primary);
            transition: all 0.3s ease;
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .password-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 
                0 0 0 3px rgba(9, 132, 227, 0.2),
                0 8px 24px rgba(9, 132, 227, 0.15);
            transform: translateY(-1px);
        }

        .password-input::placeholder {
            color: var(--text-muted);
            transition: opacity 0.3s ease;
        }

        .password-input:focus::placeholder {
            opacity: 0.6;
        }

        .password-toggle {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .password-toggle:hover {
            color: var(--accent-primary);
            background: rgba(9, 132, 227, 0.1);
        }

        .password-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--text-white);
            border: none;
            border-radius: 16px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 
                0 8px 20px rgba(9, 132, 227, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            animation: fadeInUp 0.8s ease-out 0.6s both;
            position: relative;
            overflow: hidden;
        }

        .password-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .password-btn:hover::before {
            left: 100%;
        }

        .password-btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 12px 28px rgba(9, 132, 227, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.2);
        }

        .password-btn:active {
            transform: translateY(0);
        }

        .password-error {
            color: #d32f2f;
            background: linear-gradient(135deg, rgba(255, 235, 238, 0.9), rgba(255, 205, 210, 0.8));
            border: 1px solid rgba(244, 67, 54, 0.3);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            display: none;
            font-weight: 500;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.2);
            animation: errorShake 0.6s ease-out;
        }

        .password-hint {
            color: var(--text-secondary);
            font-size: 0.9em;
            line-height: 1.6;
            animation: fadeInUp 0.8s ease-out 0.7s both;
        }

        /* ÈöêËóè‰∏ªÂÜÖÂÆπ */
        .main-app {
            display: none;
        }

        .main-app.authenticated {
            display: block;
        }

        /* ÂØÜÁ†ÅÁïåÈù¢ÁßªÂä®Á´ØÈÄÇÈÖç */
        @media (max-width: 768px) {
            .password-overlay {
                padding: 10px;
            }
            
            .password-modal {
                padding: 30px 20px;
                margin: 0;
                max-width: none;
                width: 100%;
                max-height: 90vh;
                overflow-y: auto;
                position: relative;
                animation: slideUpMobile 0.4s ease-out;
            }
            
            .password-modal h2 {
                font-size: 1.5em;
                margin-bottom: 8px;
            }
            
            .password-modal .subtitle {
                font-size: 1em;
                margin-bottom: 20px;
            }
            
            .password-modal .beta-info {
                font-size: 0.85em;
                padding: 12px;
                margin-bottom: 20px;
                line-height: 1.4;
            }
            
            .password-input {
                font-size: 16px; /* Èò≤Ê≠¢iOSÁº©Êîæ */
                padding: 16px;
                margin-bottom: 16px;
            }
            
            .password-btn {
                padding: 16px;
                font-size: 16px;
                margin-bottom: 12px;
            }
            
            .password-hint {
                font-size: 12px;
                margin-top: 12px;
                line-height: 1.5;
            }
        }

        @media (max-width: 480px) {
            .password-overlay {
                padding: 5px;
            }
            
            .password-modal {
                padding: 25px 15px;
                border-radius: 12px;
                animation: slideUpMobile 0.3s ease-out;
            }
            
            .password-modal h2 {
                font-size: 1.3em;
                margin-bottom: 6px;
            }
            
            .password-modal .subtitle {
                font-size: 0.9em;
                margin-bottom: 16px;
            }
            
            .password-modal .beta-info {
                font-size: 0.8em;
                padding: 10px;
                margin-bottom: 16px;
                border-radius: 6px;
            }
            
            .password-input {
                padding: 14px;
                font-size: 16px;
                border-radius: 8px;
                margin-bottom: 14px;
            }
            
            .password-btn {
                padding: 14px;
                font-size: 15px;
                border-radius: 8px;
                margin-bottom: 10px;
            }
            
            .password-hint {
                font-size: 11px;
                margin-top: 10px;
                padding: 0 5px;
            }
        }

        @keyframes slideUpMobile {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* ÁßªÂä®Á´ØÈîÆÁõòÈÄÇÈÖç - Â¢ûÂº∫Áâà */
        @media (max-height: 600px) and (max-width: 768px) {
            .password-overlay {
                align-items: flex-start;
                padding-top: 10vh;
            }
            
            .password-modal {
                margin-top: 0;
                max-height: calc(100vh - 20vh);
                padding: 32px 24px;
                animation: modalEntranceMobile 0.6s ease-out;
            }
            
            .password-modal h2 {
                font-size: 1.4em;
                margin-bottom: 8px;
            }
            
            .password-modal .subtitle {
                font-size: 1em;
                margin-bottom: 20px;
            }
            
            .password-modal .beta-info {
                font-size: 0.8em;
                padding: 12px;
                margin-bottom: 16px;
            }
            
            .password-input-wrapper {
                margin-bottom: 16px;
            }
            
            .password-input {
                padding: 16px 20px;
                font-size: 16px; /* Èò≤Ê≠¢iOSÁº©Êîæ */
            }
            
            .password-btn {
                padding: 16px;
                font-size: 16px;
                margin-bottom: 16px;
            }
            
            .password-hint {
                font-size: 0.8em;
                margin-top: 8px;
                line-height: 1.4;
            }
        }

        /* ÊûÅÂ∞èÂ±èÂπïÈÄÇÈÖç */
        @media (max-height: 500px) {
            .password-overlay {
                padding: 10px;
                align-items: center;
            }
            
            .password-modal {
                max-height: calc(100vh - 20px);
                padding: 20px;
                overflow-y: auto;
            }
            
            .password-modal h2 {
                font-size: 1.2em;
                margin-bottom: 6px;
            }
            
            .password-modal .subtitle {
                font-size: 0.9em;
                margin-bottom: 16px;
            }
            
            .password-modal .beta-info {
                font-size: 0.75em;
                padding: 10px;
                margin-bottom: 12px;
            }
        }

        /* ÁßªÂä®Á´ØÂÖ•Âú∫Âä®Áîª */
        @keyframes modalEntranceMobile {
            0% {
                opacity: 0;
                transform: translateY(50px) scale(0.9);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* ÁÑ¶ÁÇπÁÆ°ÁêÜÂ¢ûÂº∫ */
        .password-input:focus,
        .password-btn:focus,
        .password-toggle:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        /* È´òÂØπÊØîÂ∫¶Ê®°ÂºèÊîØÊåÅ */
        @media (prefers-contrast: high) {
            .password-modal {
                border: 3px solid var(--text-primary);
                background: var(--container-bg);
                backdrop-filter: none;
            }
            
            .password-input {
                border-width: 3px;
                background: var(--container-bg);
                backdrop-filter: none;
            }
            
            .password-btn {
                border: 2px solid var(--accent-primary);
            }
        }

        /* ÂáèÂ∞ëÂä®ÁîªÊ®°ÂºèÊîØÊåÅ */
        @media (prefers-reduced-motion: reduce) {
            .password-overlay,
            .password-modal,
            .password-modal h2,
            .password-modal .subtitle,
            .password-modal .beta-info,
            .password-input-wrapper,
            .password-btn,
            .password-hint {
                animation: none !important;
            }
            
            .password-overlay::before {
                animation: none !important;
            }
            
            .password-btn::before {
                transition: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- ÂØÜÁ†ÅÈ™åËØÅÁïåÈù¢ -->
    <div id="passwordOverlay" class="password-overlay" role="dialog" aria-labelledby="passwordTitle" aria-describedby="passwordDesc">
        <div class="password-modal">
            <h2 id="passwordTitle">üîê ËÆøÈóÆÈ™åËØÅ</h2>
            <p class="subtitle" id="passwordDesc">MarkdownËΩ¨WordËΩ¨Êç¢Âô®</p>
            <div class="beta-info" role="alert">
                <strong>‚ö†Ô∏è ‰∏™‰∫∫ÂÜÖÊµãÁâàÊú¨</strong><br>
                Ê≠§ÁâàÊú¨‰ªÖ‰æõÂÜÖÈÉ®ÊµãËØï‰ΩøÁî®ÔºåËØ∑ËæìÂÖ•ËÆøÈóÆÂØÜÁ†Å
            </div>
            <div class="password-input-wrapper">
                <label for="passwordInput" class="visually-hidden">ËÆøÈóÆÂØÜÁ†Å</label>
                <input type="password" id="passwordInput" class="password-input" placeholder="ËØ∑ËæìÂÖ•ËÆøÈóÆÂØÜÁ†Å" maxlength="20" aria-describedby="passwordHint passwordError" autocomplete="current-password">
                <button type="button" class="password-toggle" id="passwordToggle" aria-label="ÊòæÁ§∫/ÈöêËóèÂØÜÁ†Å" title="ÊòæÁ§∫/ÈöêËóèÂØÜÁ†Å">üëÅÔ∏è</button>
            </div>
            <button onclick="verifyPassword()" class="password-btn" aria-describedby="passwordHint">üöÄ ËøõÂÖ•Â∫îÁî®</button>
            
            <!-- ÁÆÄÂåñÁöÑÂàÜ‰∫´Á†ÅÂØºÂÖ• -->
            <div style="margin-top: 15px; padding: 12px; background: rgba(116, 185, 255, 0.1); border-radius: 8px; border-left: 4px solid var(--info);">
                <div style="font-size: 14px; color: var(--text-primary); margin-bottom: 8px; font-weight: 600;">üì± ÊúãÂèãÂàÜ‰∫´‰∫ÜÂØÜÁ†ÅÔºü</div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">
                    Â¶ÇÊûúÊúãÂèãÁªô‰Ω†Âèë‰∫ÜÂàÜ‰∫´Á†ÅÔºåÁÇπÂáª‰∏ãÊñπÊåâÈíÆÂø´ÈÄüÂØºÂÖ•
                </div>
                <button onclick="pasteShareCode()" style="background: var(--accent-secondary); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%;">
                    üì± Á≤òË¥¥ÂàÜ‰∫´Á†Å
                </button>
                <div style="font-size: 10px; color: var(--text-muted); text-align: center; margin-top: 6px;">
                    ÂàÜ‰∫´Á†ÅÊ†ºÂºèÔºöPWD:abc123|advanced|2025-01-01
                </div>
            </div>
            
            <div id="passwordError" class="password-error" role="alert" aria-live="polite">ÂØÜÁ†ÅÈîôËØØÔºåËØ∑ÈáçËØï</div>
            <div class="password-hint" id="passwordHint">
                üí° ÊèêÁ§∫ÔºöÂ¶ÇÈúÄËé∑ÂèñËÆøÈóÆÂØÜÁ†ÅÔºåËØ∑ËÅîÁ≥ªÂºÄÂèëËÄÖ<br>
                <strong>Boning</strong> ¬∑ TJUT
            </div>
        </div>
    </div>

    <!-- ‰∏ªÂ∫îÁî®ÁïåÈù¢ -->
    <div id="mainApp" class="main-app">
        <div class="container">
            <header class="header">
                <button class="theme-toggle" onclick="toggleTheme(event)" title="ÂàáÊç¢‰∏ªÈ¢ò" aria-label="ÂàáÊç¢È¢úËâ≤‰∏ªÈ¢ò">
                    <span id="themeText">Ê∏©ÊöñÁê•ÁèÄ</span>
                </button>
                <h1>üìù MarkdownËΩ¨WordËΩ¨Êç¢Âô®</h1>
                <p>Â∞ÜÊÇ®ÁöÑMarkdownÊñáÊ°£Âø´ÈÄüËΩ¨Êç¢‰∏∫WordÊ†ºÂºè</p>
                <div class="author-info">
                    Áî± <span class="author-name">Boning</span> ÂºÄÂèë ¬∑ TJUT ¬∑ <span style="color: #E8F5E8;">ÂÜÖÊµãÁâà</span>
                </div>
                
                <!-- Áî®Êà∑ÊùÉÈôêÁä∂ÊÄÅÊòæÁ§∫ -->
                <div class="user-status" id="userStatus" style="margin-top: 10px; padding: 8px 12px; background: var(--glass-bg); border-radius: 8px; border: 1px solid var(--glass-border); backdrop-filter: var(--blur); display: none;">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px;">
                        <div class="user-info" style="display: flex; align-items: center; gap: 8px;">
                            <span id="userIcon">üë§</span>
                            <span id="userName" style="font-weight: 600;">Áî®Êà∑</span>
                            <span id="userLevel" style="background: var(--accent-primary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">Level</span>
                        </div>
                        <div class="quota-info" style="display: flex; align-items: center; gap: 12px; font-size: 14px;">
                            <button onclick="showUserPermissions()" style="background: none; border: none; color: var(--accent-primary); cursor: pointer; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--accent-primary);" title="Êü•ÁúãÊùÉÈôêËØ¶ÊÉÖ">ËØ¶ÊÉÖ</button>
                            <button id="adminButton" onclick="showAdminPanel()" style="background: var(--accent-primary); border: none; color: white; cursor: pointer; padding: 4px 8px; border-radius: 4px; display: none;" title="ÁÆ°ÁêÜÈù¢Êùø">ÁÆ°ÁêÜ</button>
                            <button onclick="showLogoutConfirm()" style="background: var(--warning); border: none; color: white; cursor: pointer; padding: 4px 8px; border-radius: 4px;" title="ÈÄÄÂá∫ÁôªÂΩï">ÈÄÄÂá∫</button>
                        </div>
                    </div>
                </div>
            </header>

        <main class="main-content">
            <section class="input-section drag-hint">
                <h2 class="section-title">üìù ËæìÂÖ•MarkdownÂÜÖÂÆπ</h2>
                <div style="position: relative;">
                    <label for="markdownInput" class="visually-hidden">MarkdownÂÜÖÂÆπËæìÂÖ•Ê°Ü</label>
                    <textarea id="markdownInput" placeholder="Âú®ËøôÈáåËæìÂÖ•ÊÇ®ÁöÑMarkdownÂÜÖÂÆπ..." aria-describedby="inputHelp"

‰æãÂ¶Ç:
# Ê†áÈ¢ò‰∏Ä
## Ê†áÈ¢ò‰∫å
### Ê†áÈ¢ò‰∏â

**Á≤ó‰ΩìÊñáÊú¨**
*Êñú‰ΩìÊñáÊú¨*

- ÂàóË°®È°π1
- ÂàóË°®È°π2
- ÂàóË°®È°π3

> ËøôÊòØ‰∏Ä‰∏™ÂºïÁî®Âùó

```javascript
console.log('Hello World!');
```

[ÈìæÊé•ÊñáÊú¨](https://example.com)

| Ë°®Ê†º | Á§∫‰æã |
|------|------|
| ÂçïÂÖÉÊ†º1 | ÂçïÂÖÉÊ†º2 |
| ÂçïÂÖÉÊ†º3 | ÂçïÂÖÉÊ†º4 |"></textarea>
                    
                    <!-- ÊãñÊãΩË¶ÜÁõñÂ±Ç -->
                    <div class="drag-overlay" id="dragOverlay">
                        <div class="drag-overlay-icon">üìÅ</div>
                        <div class="drag-overlay-text">
                            ÈáäÊîæ‰ª•‰∏ä‰º†MarkdownÊñá‰ª∂<br>
                            <small>ÊîØÊåÅ .md, .markdown, .txt Ê†ºÂºè</small>
                        </div>
                    </div>
                    
                    <!-- ÊãñÊãΩÊèêÁ§∫ÊñáÊú¨ -->
                    <div class="drag-hint-text" id="inputHelp">ÊîØÊåÅÊãñÊãΩ Markdown Êñá‰ª∂Âà∞Ê≠§Â§Ñ‰∏ä‰º†</div>
                </div>
                
                <!-- ËæìÂÖ•ÁªüËÆ°‰ø°ÊÅØ -->
                <div class="input-stats" role="region" aria-label="ÊñáÊ°£ÁªüËÆ°‰ø°ÊÅØ">
                    <div class="stat-item">
                        <div class="stat-value" id="charCount" aria-label="Â≠óÁ¨¶Êï∞">0</div>
                        <div class="stat-label">Â≠óÁ¨¶</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="wordCount" aria-label="ÂçïËØçÊï∞">0</div>
                        <div class="stat-label">ÂçïËØç</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="lineCount" aria-label="Ë°åÊï∞">1</div>
                        <div class="stat-label">Ë°åÊï∞</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="readTime" aria-label="È¢ÑËÆ°ÈòÖËØªÊó∂Èó¥">0</div>
                        <div class="stat-label">ÈòÖËØªÊó∂Èó¥(ÂàÜ)</div>
                    </div>
                </div>
                
                <div class="example-section" role="group" aria-label="Á§∫‰æãÂÜÖÂÆπ">
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                        <button class="btn example-btn" onclick="loadExample('simple')" aria-describedby="simpleDesc">üìÑ ÁÆÄÂçïÁ§∫‰æã</button>
                        <button class="btn example-btn" onclick="loadExample('advanced')" aria-describedby="advancedDesc">üöÄ È´òÁ∫ßÁ§∫‰æã</button>
                        <button class="btn example-btn" onclick="loadExample('math')" aria-describedby="mathDesc">üìê Êï∞Â≠¶ÂÖ¨Âºè</button>
                        <button class="btn example-btn" onclick="loadExample('table')" aria-describedby="tableDesc">üìä Ë°®Ê†ºÁ§∫‰æã</button>
                    </div>
                </div>
            </section>

            <section class="preview-section">
                <h2 class="section-title">üëÄ ÂÆûÊó∂È¢ÑËßà</h2>
                <div style="position: relative;">
                    <div id="preview" role="region" aria-label="MarkdownÈ¢ÑËßàÂÜÖÂÆπ" aria-live="polite" aria-atomic="false">
                    <div class="preview-empty">
                        <div class="preview-empty-icon">üìù</div>
                        <div class="preview-empty-title">ÂºÄÂßãÂàõ‰ΩúÊÇ®ÁöÑÊñáÊ°£</div>
                        <div class="preview-empty-subtitle">
                            Âú®Â∑¶‰æßËæìÂÖ•Ê°Ü‰∏≠ËæìÂÖ•MarkdownÂÜÖÂÆπ<br>
                            ÊàñËÄÖ‰ΩøÁî®‰∏ãÊñπÁöÑÂø´ÈÄüÊìç‰Ωú
                        </div>
                        <div class="preview-quick-actions" role="group" aria-label="Âø´ÈÄüÊìç‰Ωú">
                            <button class="quick-action-btn" onclick="loadExample('simple')" aria-label="Âä†ËΩΩÁÆÄÂçïÁ§∫‰æã">üìÑ ÁÆÄÂçïÁ§∫‰æã</button>
                            <button class="quick-action-btn" onclick="loadExample('advanced')" aria-label="Âä†ËΩΩÈ´òÁ∫ßÁ§∫‰æã">üöÄ È´òÁ∫ßÁ§∫‰æã</button>
                            <button class="quick-action-btn" onclick="uploadFile()" aria-label="‰∏ä‰º†MarkdownÊñá‰ª∂">üìÅ ‰∏ä‰º†Êñá‰ª∂</button>
                            <button class="quick-action-btn" onclick="loadFromLocal()" aria-label="Âä†ËΩΩÊú¨Âú∞ËçâÁ®ø">üìÇ Âä†ËΩΩËçâÁ®ø</button>
                        </div>
                    </div>
                    
                    <!-- Êï∞Â≠¶ÂÖ¨ÂºèÊ∏≤ÊüìÁä∂ÊÄÅÊåáÁ§∫Âô® -->
                    <div class="math-rendering-indicator" id="mathIndicator" aria-live="polite" aria-label="Êï∞Â≠¶ÂÖ¨ÂºèÊ∏≤ÊüìÁä∂ÊÄÅ">
                        <span>‚ö°</span>
                        <span>Ê∏≤ÊüìÊï∞Â≠¶ÂÖ¨Âºè...</span>
                    </div>
                    
                    <!-- ÈïøÊñáÊ°£Ëß£ÊûêËøõÂ∫¶ÊåáÁ§∫Âô® -->
                    <div class="parse-progress-indicator" id="parseIndicator" aria-live="polite" aria-label="ÊñáÊ°£Ëß£ÊûêËøõÂ∫¶">
                        <div class="progress-bar">
                            <div class="progress-bar-fill"></div>
                        </div>
                        <div class="progress-text">Ëß£Êûê‰∏≠...</div>
                    </div>
                    
                    <!-- WordËΩ¨Êç¢ËøõÂ∫¶ÊåáÁ§∫Âô® -->
                    <div class="word-conversion-indicator" id="wordConversionIndicator" aria-live="polite" aria-label="WordËΩ¨Êç¢ËøõÂ∫¶">
                        <div class="conversion-icon">üìÑ</div>
                        <div class="progress-bar">
                            <div class="progress-bar-fill"></div>
                        </div>
                        <div class="progress-text">ËΩ¨Êç¢‰∏≠...</div>
                    </div>
                </div>
            </section>
        </main>

        <section class="controls" role="group" aria-label="Êìç‰ΩúÊéßÂà∂Èù¢Êùø">
            <div class="controls-grid">
                <!-- ÂØºÂá∫ÂäüËÉΩÁªÑ -->
                <div class="control-group">
                    <div class="control-group-title">
                        <span>üì§</span>
                        <span>ÂØºÂá∫‰∏éÂàÜ‰∫´</span>
                    </div>
                    <div class="control-group-desc">
                        Â∞ÜÊÇ®ÁöÑMarkdownÂÜÖÂÆπÂØºÂá∫‰∏∫‰∏çÂêåÊ†ºÂºèÊàñÂ§çÂà∂Âà∞Ââ™Ë¥¥Êùø
                    </div>
                    <div class="control-buttons" role="group" aria-label="ÂØºÂá∫Êìç‰Ωú">
                        <button class="btn" onclick="downloadWord()" aria-label="‰∏ãËΩΩWordÊñáÊ°£">üìÑ ‰∏ãËΩΩWord</button>
                        <button class="btn" onclick="copyFormattedText()" aria-label="Â§çÂà∂ÂØåÊñáÊú¨Âà∞Ââ™Ë¥¥Êùø">üìã Â§çÂà∂ÂØåÊñáÊú¨</button>
                    </div>
                </div>

                <!-- Êñá‰ª∂‰∏éÁºñËæëÂ∑•ÂÖ∑ÁªÑ -->
                <div class="control-group">
                    <div class="control-group-title">
                        <span>üõ†Ô∏è</span>
                        <span>Êñá‰ª∂‰∏éÁºñËæë</span>
                    </div>
                    <div class="control-group-desc">
                        Êñá‰ª∂‰∏ä‰º†„ÄÅËçâÁ®øÁÆ°ÁêÜÂíåÁºñËæëËæÖÂä©Â∑•ÂÖ∑
                    </div>
                    <div class="control-buttons" role="group" aria-label="Êñá‰ª∂‰∏éÁºñËæëÊìç‰Ωú">
                        <button class="btn btn-secondary" onclick="uploadFile()" aria-label="‰∏ä‰º†MarkdownÊñá‰ª∂">üìÅ ‰∏ä‰º†Êñá‰ª∂</button>
                        <button class="btn btn-secondary" onclick="saveToLocal()" aria-label="‰øùÂ≠òÂΩìÂâçÂÜÖÂÆπ‰∏∫ËçâÁ®ø">üíæ ‰øùÂ≠òËçâÁ®ø</button>
                        <button class="btn btn-secondary" onclick="loadFromLocal()" aria-label="Âä†ËΩΩÊú¨Âú∞‰øùÂ≠òÁöÑËçâÁ®ø">üìÇ Âä†ËΩΩËçâÁ®ø</button>
                        <button class="btn btn-secondary" onclick="clearContent()" aria-label="Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü‰∏≠ÁöÑÊâÄÊúâÂÜÖÂÆπ">üóëÔ∏è Ê∏ÖÁ©∫ÂÜÖÂÆπ</button>
                        <button class="btn btn-secondary" onclick="showShortcuts()" aria-label="ÊòæÁ§∫ÈîÆÁõòÂø´Êç∑ÈîÆÂ∏ÆÂä©">‚å®Ô∏è Âø´Êç∑ÈîÆ</button>
                    </div>
                </div>

                <!-- AIÊô∫ËÉΩ‰øÆÂ§çÁªÑ -->
                <div class="control-group" id="aiFixGroup" style="display: none;">
                    <div class="control-group-title">
                        <span>ü§ñ</span>
                        <span>AIÊô∫ËÉΩ‰øÆÂ§ç</span>
                    </div>
                    <div class="control-group-desc">
                        ‰ΩøÁî®AIËá™Âä®‰øÆÂ§çMarkdownÊ†ºÂºèÈóÆÈ¢òÔºå‰ºòÂåñÊñáÊ°£ÁªìÊûÑ
                    </div>
                    <div class="control-buttons" role="group" aria-label="AI‰øÆÂ§çÊìç‰Ωú">
                        <button class="btn ai-fix-btn" onclick="performQuickAIFix()" aria-label="Âø´ÈÄü‰øÆÂ§çÊ†ºÂºèÈóÆÈ¢ò">‚ö° Âø´ÈÄü‰øÆÂ§ç</button>
                        <button class="btn btn-secondary" id="aiConfigBtn" onclick="showAIConfigModal()" aria-label="AI‰øÆÂ§çËÆæÁΩÆ">‚öôÔ∏è AIËÆæÁΩÆ</button>
                        <button class="btn btn-secondary" onclick="performAdvancedAIFix()" aria-label="Ê∑±Â∫¶‰ºòÂåñÂÜÖÂÆπ">üß† Ê∑±Â∫¶‰ºòÂåñ</button>
                    </div>
                    <div class="ai-usage-info" id="aiUsageInfo" style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
                        ‰ªäÊó•Ââ©‰Ωô: <span id="aiUsageCount">--</span> Ê¨°
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Áä∂ÊÄÅÊåáÁ§∫Âô® -->
        <div id="statusIndicator" class="status-indicator"></div>
        
        <!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ• -->
        <input type="file" id="fileInput" accept=".md,.markdown,.txt" style="display: none;" onchange="handleFileUpload(event)">
        
        <!-- ToastÈÄöÁü•ÂÆπÂô® -->
        <div class="toast-container" id="toastContainer"></div>
        
        <!-- Ëá™ÂÆö‰πâÁ°ÆËÆ§ÂØπËØùÊ°Ü -->
        <div class="custom-dialog" id="customDialog">
            <div class="dialog-content">
                <div class="dialog-icon" id="dialogIcon">‚ùì</div>
                <div class="dialog-title" id="dialogTitle">Á°ÆËÆ§Êìç‰Ωú</div>
                <div class="dialog-message" id="dialogMessage">ÊÇ®Á°ÆÂÆöË¶ÅÊâßË°åÊ≠§Êìç‰ΩúÂêóÔºü</div>
                <div class="dialog-buttons">
                    <button class="dialog-btn dialog-btn-secondary" id="dialogCancel">ÂèñÊ∂à</button>
                    <button class="dialog-btn dialog-btn-primary" id="dialogConfirm">Á°ÆËÆ§</button>
                </div>
            </div>
        </div>
        
        <!-- AIÈÖçÁΩÆÊ®°ÊÄÅÊ°Ü -->
        <div class="ai-config-modal" id="aiConfigModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; backdrop-filter: blur(5px);">
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; padding: 20px;">
                <div style="background: var(--container-bg); border-radius: 15px; padding: 30px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: var(--text-primary);">ü§ñ AIÊô∫ËÉΩ‰øÆÂ§çÈÖçÁΩÆ</h2>
                        <button onclick="closeAIConfigModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);" title="ÂÖ≥Èó≠">&times;</button>
                    </div>
                    
                    <div style="background: var(--preview-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin-top: 0; color: var(--text-primary);">üîß AIÊúçÂä°ÈÖçÁΩÆ</h3>
                        
                        <!-- AIÊúçÂä°ÂïÜÈÄâÊã© -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">AIÊúçÂä°ÂïÜÔºö</label>
                            <select id="aiProvider" onchange="updateAIModels()" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: white;">
                                <option value="kimi">Kimi (moonshot)</option>
                                <option value="glm">Êô∫Ë∞±GLM</option>
                                <option value="baichuan">ÁôæÂ∑ùAI</option>
                                <option value="deepseek">DeepSeek</option>
                                <option value="openai">OpenAI</option>
                            </select>
                        </div>
                        
                        <!-- Ê®°ÂûãÈÄâÊã© -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">AIÊ®°ÂûãÔºö</label>
                            <select id="aiModel" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: white;">
                                <option value="moonshot-v1-8k">moonshot-v1-8k</option>
                            </select>
                        </div>
                        
                        <!-- APIÂØÜÈí•ËæìÂÖ• -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">APIÂØÜÈí•Ôºö</label>
                            <div style="position: relative;">
                                <input type="password" id="aiApiKey" placeholder="ËæìÂÖ•ÊÇ®ÁöÑAPIÂØÜÈí•" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; padding-right: 40px;">
                                <button type="button" onclick="toggleAPIKeyVisibility()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 16px;" title="ÊòæÁ§∫/ÈöêËóèAPIÂØÜÈí•">üëÅÔ∏è</button>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                                ‚ö†Ô∏è APIÂØÜÈí•‰ªÖÂú®Êú¨Âú∞Â≠òÂÇ®Ôºå‰∏ç‰ºö‰∏ä‰º†Âà∞ÊúçÂä°Âô®
                            </div>
                        </div>
                        
                        <!-- ‰øÆÂ§çÈÄâÈ°π -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600;">‰øÆÂ§çÈÄâÈ°πÔºö</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px;">
                                    <input type="checkbox" id="fixFormat" checked> Ê†ºÂºèËßÑËåÉÂåñ
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px;">
                                    <input type="checkbox" id="fixSyntax" checked> ËØ≠Ê≥ï‰øÆÂ§ç
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px;">
                                    <input type="checkbox" id="optimizeContent"> ÂÜÖÂÆπ‰ºòÂåñ
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px;">
                                    <input type="checkbox" id="addStructure"> Ê∑ªÂä†Ê†áÈ¢òÂ±ÇÊ¨°
                                </label>
                            </div>
                        </div>
                        
                        <!-- Êìç‰ΩúÊåâÈíÆÁªÑ -->
                        <div style="display: flex; gap: 10px;">
                            <button onclick="testAIConnection()" style="background: var(--info); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; flex: 1;">üîó ÊµãËØïËøûÊé•</button>
                            <button onclick="showAIHelp()" style="background: var(--warning); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; flex: 1;">üìñ Â∏ÆÂä©</button>
                        </div>
                        <button onclick="saveAIConfig()" style="background: var(--accent-primary); color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 10px;">üíæ ‰øùÂ≠òÈÖçÁΩÆ</button>
                    </div>
                    
                    <!-- ‰ΩøÁî®ËØ¥Êòé -->
                    <div style="background: rgba(116, 185, 255, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--info);">
                        <h4 style="margin-top: 0; color: var(--text-primary);">üí° ‰ΩøÁî®ËØ¥Êòé</h4>
                        <ul style="margin: 0; padding-left: 20px; color: var(--text-secondary); font-size: 14px;">
                            <li><strong>Âø´ÈÄü‰øÆÂ§ç</strong>ÔºöËá™Âä®‰øÆÂ§çÂ∏∏ËßÅÁöÑMarkdownÊ†ºÂºèÈóÆÈ¢ò</li>
                            <li><strong>Ê∑±Â∫¶‰ºòÂåñ</strong>Ôºö‰ΩøÁî®AIÈáçÊñ∞ÁªÑÁªáÂíå‰ºòÂåñÊñáÊ°£ÁªìÊûÑ</li>
                            <li><strong>APIÂØÜÈí•</strong>ÔºöËé∑ÂèñÂØÜÈí•ËØ∑ËÆøÈóÆÂØπÂ∫îAIÊúçÂä°ÂïÜÂÆòÁΩë</li>
                            <li><strong>‰ΩøÁî®ÈôêÂà∂</strong>ÔºöÈ´òÁ∫ßÁî®Êà∑ÊØèÊó•10Ê¨°ÔºåË∂ÖÁ∫ßÁÆ°ÁêÜÂëòÊó†ÈôêÂà∂</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ÁÆ°ÁêÜÂëòÈù¢Êùø -->
        <div class="admin-panel" id="adminPanel" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; backdrop-filter: blur(5px);">
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; padding: 20px;">
                <div style="background: var(--container-bg); border-radius: 15px; padding: 30px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: var(--text-primary);">üëë Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢Êùø</h2>
                        <button onclick="closeAdminPanel()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);" title="ÂÖ≥Èó≠">&times;</button>
                    </div>
                    
                    <!-- Ê†áÁ≠æÈ°µÂØºËà™ -->
                    <div class="admin-tabs" style="display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 20px;">
                        <button class="admin-tab active" onclick="switchAdminTab('password')" data-tab="password" style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 2px solid var(--accent-primary); color: var(--accent-primary); font-weight: 600;">ÂØÜÁ†ÅÁÆ°ÁêÜ</button>
                    </div>
                    
                    
                    <!-- ÂØÜÁ†ÅÁÆ°ÁêÜÊ†áÁ≠æÈ°µ -->
                    <div id="passwordTab" class="admin-tab-content">
                        <h3 style="color: var(--text-primary); margin-bottom: 15px;">üîë ÂØÜÁ†ÅÁîüÊàêÂô®</h3>
                        <div style="background: var(--preview-bg); padding: 20px; border-radius: 8px;">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Áî®Êà∑Á±ªÂûãÔºö</label>
                                <select id="passwordUserType" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: white;">
                                    <option value="basic">Âü∫Á°ÄÁî®Êà∑</option>
                                    <option value="advanced">È´òÁ∫ßÁî®Êà∑</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">ÂØÜÁ†ÅÈïøÂ∫¶Ôºö</label>
                                <input type="number" id="passwordLength" value="8" min="6" max="20" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
                            </div>
                            <button onclick="generatePassword()" style="background: var(--accent-primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; margin-bottom: 15px;">ÁîüÊàêÂØÜÁ†Å</button>
                            <div id="generatedPassword" style="background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); font-family: monospace; font-size: 16px; text-align: center; display: none;">
                                <div style="margin-bottom: 8px; font-weight: 600;">üéâ ÂØÜÁ†ÅÁîüÊàêÊàêÂäüÔºÅ</div>
                                <div id="passwordValue" style="font-size: 18px; color: var(--accent-primary); letter-spacing: 2px; padding: 8px; background: var(--preview-bg); border-radius: 4px; margin-bottom: 15px;"></div>
                                
                                <!-- ÂàÜ‰∫´ÈÄâÈ°π -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px;">
                                    <button onclick="copyPassword()" style="background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">üìã Â§çÂà∂ÂØÜÁ†Å</button>
                                    <button onclick="copyShareText()" style="background: var(--accent-secondary); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">üì± Â§çÂà∂ÂàÜ‰∫´Á†Å</button>
                                </div>
                                
                                <!-- ÂàÜ‰∫´ÊñáÊú¨ÊòæÁ§∫ -->
                                <div id="shareTextArea" style="background: var(--preview-bg); padding: 10px; border-radius: 4px; margin-bottom: 10px; display: none;">
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">üì± ÂæÆ‰ø°/QQÂàÜ‰∫´ÊñáÊú¨ÔºàÁÇπÂáªÂèØÂ§çÂà∂ÔºâÔºö</div>
                                    <div id="shareTextValue" style="font-size: 11px; color: var(--text-primary); background: white; padding: 6px; border-radius: 3px; cursor: pointer; word-break: break-all;" onclick="copyShareTextDirect()"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ÂØÜÁ†ÅÁÆ°ÁêÜ -->
                        <div style="margin-top: 20px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                üìã Â∑≤ÁîüÊàêÁöÑÂØÜÁ†Å
                                <span style="background: var(--info); color: white; padding: 2px 6px; border-radius: 12px; font-size: 11px; font-weight: normal;" id="passwordCountDisplay">0</span>
                            </h4>
                            <div id="passwordList" style="background: var(--preview-bg); padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto;">
                                <div style="color: var(--text-secondary); text-align: center; font-style: italic;">ÊöÇÊó†ÁîüÊàêÁöÑÂØÜÁ†Å</div>
                            </div>
                            <div style="margin-top: 10px; text-align: center;">
                                <button onclick="clearAllPasswords()" style="background: var(--warning); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Ê∏ÖÈô§ÊâÄÊúâÂØÜÁ†Å</button>
                            </div>
                        </div>
                        
                        <!-- Êí§ÈîÄÂØÜÁ†ÅÁÆ°ÁêÜ -->
                        <div style="margin-top: 25px; border-top: 2px solid var(--border-color); padding-top: 20px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                üö´ Â∑≤Êí§ÈîÄÁöÑÂØÜÁ†Å
                                <span style="background: var(--warning); color: white; padding: 2px 6px; border-radius: 12px; font-size: 11px; font-weight: normal;" id="revokedCountDisplay">0</span>
                            </h4>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">
                                Êí§ÈîÄÁöÑÂØÜÁ†ÅÊó†Ê≥ïÈÄöËøáÂàÜ‰∫´Á†ÅÈáçÊñ∞ÊøÄÊ¥ªÔºåÁ°Æ‰øùÂ∑≤Âà†Èô§ÂØÜÁ†ÅÁöÑÂÆâÂÖ®ÊÄß
                            </div>
                            <div id="revokedPasswordList" style="background: var(--preview-bg); padding: 15px; border-radius: 8px; max-height: 150px; overflow-y: auto;">
                                <div style="color: var(--text-secondary); text-align: center; font-style: italic;">ÊöÇÊó†Êí§ÈîÄÁöÑÂØÜÁ†Å</div>
                            </div>
                            <div style="margin-top: 10px; text-align: center; display: flex; gap: 8px; justify-content: center;">
                                <button onclick="updateRevokedPasswordList()" style="background: var(--info); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">üîÑ Âà∑Êñ∞</button>
                                <button onclick="clearRevokedPasswords()" style="background: var(--warning); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">üóëÔ∏è Ê∏ÖÁ©∫Êí§ÈîÄÂàóË°®</button>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
        
        <!-- ‰∏ªÈ¢òÂàáÊç¢ËøáÊ∏°Â±Ç -->
        <div class="theme-transition" id="themeTransition"></div>
        </div>
    </div>

    <script>
        // ÂïÜ‰∏öÂåñÊùÉÈôêÁ≥ªÁªü - 3Á∫ßÁî®Êà∑ÂàÜÁ∫ß
        const userPermissions = {
            'basic123': {
                level: 'basic',
                name: 'Âü∫Á°ÄÁî®Êà∑',
                icon: 'üÜì',
                features: {
                    basicMarkdown: true,
                    mathFormulas: false,
                    batchProcess: false,
                    customExport: false,
                    aiFix: false,        // Âü∫Á°ÄÁî®Êà∑‰∏çÊîØÊåÅAI‰øÆÂ§ç
                    priority: 'low'
                }
            },
            '517517': {
                level: 'advanced',
                name: 'È´òÁ∫ßÁî®Êà∑',
                icon: '‚≠ê',
                features: {
                    basicMarkdown: true,
                    mathFormulas: true,
                    batchProcess: true,
                    customExport: true,
                    aiFix: true,         // È´òÁ∫ßÁî®Êà∑ÊîØÊåÅAI‰øÆÂ§ç
                    priority: 'high'
                }
            },
            'lingling': {
                level: 'super_admin',
                name: 'Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëò',
                icon: 'üëë',
                features: {
                    basicMarkdown: true,
                    mathFormulas: true,
                    batchProcess: true,
                    customExport: true,
                    aiFix: true,         // Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÊîØÊåÅAI‰øÆÂ§ç
                    priority: 'highest',
                    adminPanel: true,
                    passwordGenerator: true
                }
            }
        };
        
        // ÂΩìÂâçÁî®Êà∑ÊùÉÈôê
        let currentUser = null;
        let currentPassword = null; // ‰øùÂ≠òÂΩìÂâç‰ΩøÁî®ÁöÑÂØÜÁ†Å
        
        
        // Á§∫‰æãÂä†ËΩΩÊ†áÂøó
        let isLoadingExample = false;
        
        // Ëá™ÂÆö‰πâÂØÜÁ†ÅÁÆ°ÁêÜ
        const customPasswords = {
            // ‰ªélocalStorageÂä†ËΩΩËá™ÂÆö‰πâÂØÜÁ†Å
            load() {
                const stored = localStorage.getItem('customPasswords');
                return stored ? JSON.parse(stored) : {};
            },
            
            // ‰øùÂ≠òËá™ÂÆö‰πâÂØÜÁ†ÅÂà∞localStorage
            save(passwords) {
                localStorage.setItem('customPasswords', JSON.stringify(passwords));
            },
            
            // Ê∑ªÂä†Êñ∞ÂØÜÁ†Å
            add(password, userLevel) {
                const passwords = this.load();
                passwords[password] = {
                    level: userLevel,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser ? currentUser.level : 'admin'
                };
                this.save(passwords);
                return password;
            },
            
            // Âà†Èô§ÂØÜÁ†Å
            remove(password) {
                const passwords = this.load();
                delete passwords[password];
                this.save(passwords);
            },
            
            // Ëé∑ÂèñÊâÄÊúâÊúâÊïàÂØÜÁ†Å
            getAll() {
                return this.load();
            },
            
            // Ê£ÄÊü•ÂØÜÁ†ÅÊòØÂê¶Â≠òÂú®
            exists(password) {
                const passwords = this.load();
                return passwords.hasOwnProperty(password);
            },
            
            // Ëé∑ÂèñÂØÜÁ†ÅÂØπÂ∫îÁöÑÁî®Êà∑ÊùÉÈôê
            getPermissions(password) {
                const passwords = this.load();
                const customPassword = passwords[password];
                if (!customPassword) return null;
                
                // Âü∫‰∫éÁî®Êà∑Á≠âÁ∫ßËøîÂõûÊùÉÈôêÈÖçÁΩÆ
                const basePermissions = {
                    basic: {
                        level: 'basic',
                        name: 'Âü∫Á°ÄÁî®Êà∑',
                        icon: 'üÜì',
                        features: {
                            basicMarkdown: true,
                            mathFormulas: false,
                            batchProcess: false,
                            customExport: false,
                            priority: 'low'
                        }
                    },
                    advanced: {
                        level: 'advanced',
                        name: 'È´òÁ∫ßÁî®Êà∑',
                        icon: '‚≠ê',
                        features: {
                            basicMarkdown: true,
                            mathFormulas: true,
                            batchProcess: true,
                            customExport: true,
                            priority: 'high'
                        }
                    }
                };
                
                return basePermissions[customPassword.level] || null;
            }
        };
        
        // Êí§ÈîÄÂØÜÁ†ÅÁÆ°ÁêÜÂô® - Èò≤Ê≠¢Â∑≤Âà†Èô§ÁöÑÂØÜÁ†ÅÈÄöËøáÂàÜ‰∫´Á†ÅÈáçÊñ∞ÊøÄÊ¥ª
        const revokedPasswords = {
            // ‰ªé localStorage Âä†ËΩΩÊí§ÈîÄÂàóË°®
            load() {
                const stored = localStorage.getItem('revokedPasswords');
                return stored ? JSON.parse(stored) : {};
            },
            
            // ‰øùÂ≠òÊí§ÈîÄÂàóË°®Âà∞ localStorage
            save(revoked) {
                localStorage.setItem('revokedPasswords', JSON.stringify(revoked));
            },
            
            // Êí§ÈîÄÂØÜÁ†Å
            revoke(password, reason = 'ÁÆ°ÁêÜÂëòÂà†Èô§') {
                const revoked = this.load();
                revoked[password] = {
                    revokedAt: new Date().toISOString(),
                    revokedBy: currentUser ? currentUser.level : 'admin',
                    reason: reason
                };
                this.save(revoked);
            },
            
            // Ê£ÄÊü•ÂØÜÁ†ÅÊòØÂê¶Â∑≤Êí§ÈîÄ
            isRevoked(password) {
                const revoked = this.load();
                return revoked.hasOwnProperty(password);
            },
            
            // Ëé∑ÂèñÊâÄÊúâÊí§ÈîÄÂØÜÁ†Å
            getAll() {
                return this.load();
            },
            
            // Ê∏ÖÈô§ÊâÄÊúâÊí§ÈîÄËÆ∞ÂΩïÔºà‰ªÖÁÆ°ÁêÜÂëòÂèØÁî®Ôºâ
            clearAll() {
                localStorage.removeItem('revokedPasswords');
            },
            
            // ÊÅ¢Â§çÂØÜÁ†ÅÔºà‰ªéÊí§ÈîÄÂàóË°®‰∏≠ÁßªÈô§Ôºâ
            restore(password) {
                const revoked = this.load();
                delete revoked[password];
                this.save(revoked);
            }
        };
        
        let loginAttempts = 0;
        const maxAttempts = 5;
        let lockoutTime = 0;
        
        // ÂØÜÁ†ÅÊòæÁ§∫/ÈöêËóèÂàáÊç¢
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('passwordInput');
            const passwordToggle = document.getElementById('passwordToggle');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                passwordToggle.textContent = 'üôà';
                passwordToggle.setAttribute('aria-label', 'ÈöêËóèÂØÜÁ†Å');
                passwordToggle.setAttribute('title', 'ÈöêËóèÂØÜÁ†Å');
            } else {
                passwordInput.type = 'password';
                passwordToggle.textContent = 'üëÅÔ∏è';
                passwordToggle.setAttribute('aria-label', 'ÊòæÁ§∫ÂØÜÁ†Å');
                passwordToggle.setAttribute('title', 'ÊòæÁ§∫ÂØÜÁ†Å');
            }
        }
        
        // Ê£ÄÊü•ÊòØÂê¶Ë¢´ÈîÅÂÆö
        function checkLockout() {
            const now = Date.now();
            if (lockoutTime > now) {
                const remainingTime = Math.ceil((lockoutTime - now) / 1000);
                return remainingTime;
            }
            return 0;
        }
        
        // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
        function showPasswordError(message, shake = true) {
            const passwordError = document.getElementById('passwordError');
            passwordError.textContent = message;
            passwordError.style.display = 'block';
            
            if (shake) {
                passwordError.style.animation = 'none';
                setTimeout(() => {
                    passwordError.style.animation = 'errorShake 0.6s ease-out';
                }, 10);
            }
            
            // 5ÁßíÂêéÈöêËóèÈîôËØØ‰ø°ÊÅØ
            setTimeout(() => {
                passwordError.style.display = 'none';
            }, 5000);
        }
        
        function verifyPassword() {
            const passwordInput = document.getElementById('passwordInput');
            const password = passwordInput.value.trim();
            
            // Ê£ÄÊü•ÈîÅÂÆöÁä∂ÊÄÅ
            const lockoutRemaining = checkLockout();
            if (lockoutRemaining > 0) {
                showPasswordError(`Â∞ùËØïÊ¨°Êï∞ËøáÂ§öÔºåËØ∑Á≠âÂæÖ ${lockoutRemaining} ÁßíÂêéÈáçËØï`, false);
                return;
            }
            
            // Ê£ÄÊü•È¢ÑËÆæÂØÜÁ†ÅÊàñËá™ÂÆö‰πâÂØÜÁ†Å
            let userFound = false;
            
            if (userPermissions[password]) {
                // È¢ÑËÆæÂØÜÁ†Å
                currentUser = userPermissions[password];
                userFound = true;
            } else if (customPasswords.exists(password)) {
                // Ëá™ÂÆö‰πâÂØÜÁ†Å
                currentUser = customPasswords.getPermissions(password);
                userFound = true;
            }
            
            if (userFound && currentUser) {
                // ÂØÜÁ†ÅÊ≠£Á°ÆÔºåÈáçÁΩÆÂ∞ùËØïÊ¨°Êï∞
                loginAttempts = 0;
                
                // ‰øùÂ≠òÂΩìÂâç‰ΩøÁî®ÁöÑÂØÜÁ†Å
                currentPassword = password;
                
                // ÊòæÁ§∫ÊàêÂäüÂä®Áîª
                const modal = document.querySelector('.password-modal');
                modal.style.animation = 'fadeOut 0.5s ease-out forwards';
                
                setTimeout(() => {
                    // ÈöêËóèÈ™åËØÅÁïåÈù¢ÔºåÊòæÁ§∫‰∏ªÂ∫îÁî®
                    document.getElementById('passwordOverlay').style.display = 'none';
                    document.getElementById('mainApp').classList.add('authenticated');
                    
                    // ‰øùÂ≠òÈ™åËØÅÁä∂ÊÄÅÂíåÁî®Êà∑ÊùÉÈôêÂà∞sessionStorage
                    sessionStorage.setItem('authenticated', 'true');
                    sessionStorage.setItem('userLevel', currentUser.level);
                    sessionStorage.setItem('currentPassword', password); // ‰øùÂ≠òÂΩìÂâçÂØÜÁ†Å
                    sessionStorage.setItem('userPermissions', JSON.stringify(currentUser));
                    
                    // ÊòæÁ§∫Ê¨¢Ëøé‰ø°ÊÅØ
                    showWelcomeMessage();
                    
                    // ÂàùÂßãÂåñÂ∫îÁî®ÔºàÊ†πÊçÆÊùÉÈôêÔºâ
                    initializeApp();
                }, 500);
                
            } else {
                // ÂØÜÁ†ÅÈîôËØØÔºåÂ¢ûÂä†Â∞ùËØïÊ¨°Êï∞
                loginAttempts++;
                
                let errorMessage = `ÂØÜÁ†ÅÈîôËØØÔºåËØ∑ÈáçËØï (${loginAttempts}/${maxAttempts})`;
                
                if (loginAttempts >= maxAttempts) {
                    // ËææÂà∞ÊúÄÂ§ßÂ∞ùËØïÊ¨°Êï∞ÔºåÈîÅÂÆö5ÂàÜÈíü
                    lockoutTime = Date.now() + 5 * 60 * 1000;
                    errorMessage = 'Â∞ùËØïÊ¨°Êï∞ËøáÂ§öÔºåÂ∑≤ÈîÅÂÆö5ÂàÜÈíü';
                }
                
                showPasswordError(errorMessage);
                passwordInput.value = '';
                passwordInput.focus();
            }
        }
        
        // ÊòæÁ§∫Áî®Êà∑Ê¨¢Ëøé‰ø°ÊÅØ
        function showWelcomeMessage() {
            if (!currentUser) return;
            
            const welcomeMessage = `Ê¨¢ËøéÔºå${currentUser.icon} ${currentUser.name}ÔºÅ`;
            
            showToast('ÁôªÂΩïÊàêÂäü', welcomeMessage, 'success', 3000);
        }
        
        
        // Ê£ÄÊü•ÊñáÊ°£Â§ßÂ∞èÈôêÂà∂
        function checkDocumentSize(content) {
            // ÊâÄÊúâÁî®Êà∑ÈÉΩÊó†ÊñáÊ°£Â§ßÂ∞èÈôêÂà∂
            return { allowed: true, size: content.length };
        }
        
        // Ê£ÄÊü•ÂäüËÉΩÊùÉÈôê
        function hasFeature(featureName) {
            return currentUser && currentUser.features && currentUser.features[featureName];
        }
        
        // Êõ¥Êñ∞Áî®Êà∑Áä∂ÊÄÅÊòæÁ§∫
        function updateUserStatus() {
            if (!currentUser) return;
            
            const userStatus = document.getElementById('userStatus');
            const userIcon = document.getElementById('userIcon');
            const userName = document.getElementById('userName');
            const userLevel = document.getElementById('userLevel');
            const adminButton = document.getElementById('adminButton');
            
            if (userStatus && userIcon && userName && userLevel) {
                userStatus.style.display = 'block';
                userIcon.textContent = currentUser.icon;
                userName.textContent = currentUser.name;
                userLevel.textContent = currentUser.level.toUpperCase();
                
                // ÊòæÁ§∫ÊàñÈöêËóèÁÆ°ÁêÜÊåâÈíÆ
                if (adminButton) {
                    if (hasFeature('adminPanel')) {
                        adminButton.style.display = 'block';
                    } else {
                        adminButton.style.display = 'none';
                    }
                }
            }
        }
        
        // ÊòæÁ§∫Áî®Êà∑ÊùÉÈôêËØ¶ÊÉÖ
        function showUserPermissions() {
            if (!currentUser) return;
            
            const featuresList = Object.entries(currentUser.features)
                .filter(([key, value]) => key !== 'priority')
                .map(([key, value]) => {
                    const featureNames = {
                        basicMarkdown: 'Âü∫Á°ÄMarkdownËØ≠Ê≥ï',
                        mathFormulas: 'Êï∞Â≠¶ÂÖ¨ÂºèÊîØÊåÅ',
                        batchProcess: 'ÊâπÈáèÊñá‰ª∂Â§ÑÁêÜ',
                        customExport: 'Ëá™ÂÆö‰πâÂØºÂá∫Ê®°Êùø',
                        aiFix: 'AIÊô∫ËÉΩ‰øÆÂ§ç',
                        adminPanel: 'ÁÆ°ÁêÜÂëòÈù¢Êùø',
                        passwordGenerator: 'ÂØÜÁ†ÅÁîüÊàêÂô®'
                    };
                    const status = value ? '‚úÖ' : '‚ùå';
                    return `<div style="padding: 4px 0;">${status} ${featureNames[key] || key}</div>`;
                }).join('');
            
            showConfirm(
                `${currentUser.icon} ${currentUser.name} - ÊùÉÈôêËØ¶ÊÉÖ`,
                `
                <div style="text-align: left; max-width: 400px;">
                    <div style="background: var(--preview-bg); padding: 12px; border-radius: 6px;">
                        <strong>ÂäüËÉΩÊùÉÈôê</strong><br>
                        ${featuresList}
                    </div>
                    <div style="background: rgba(0, 184, 148, 0.1); padding: 12px; border-radius: 6px; margin-top: 12px; border-left: 4px solid var(--success);">
                        üéâ <strong>Êó†ÈôêÂà∂‰ΩøÁî®</strong><br>
                        ÊâÄÊúâÁî®Êà∑ÈÉΩÂèØ‰ª•Êó†ÈôêÂà∂‰ΩøÁî®ËΩ¨Êç¢ÂäüËÉΩÔºÅ
                    </div>
                </div>
                `,
                'üìä'
            );
        }
        
        // === ÁÆ°ÁêÜÂëòÈù¢ÊùøÂäüËÉΩ ===
        
        // ÊòæÁ§∫ÁÆ°ÁêÜÂëòÈù¢Êùø
        function showAdminPanel() {
            if (!hasFeature('adminPanel')) {
                showToast('ÊùÉÈôê‰∏çË∂≥', 'Âè™ÊúâË∂ÖÁ∫ßÁÆ°ÁêÜÂëòÂèØ‰ª•ËÆøÈóÆÁÆ°ÁêÜÈù¢Êùø', 'warning');
                return;
            }
            
            document.getElementById('adminPanel').style.display = 'block';
        }
        
        // ÂÖ≥Èó≠ÁÆ°ÁêÜÂëòÈù¢Êùø
        function closeAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
        }
        
        // ÂàáÊç¢ÁÆ°ÁêÜÊ†áÁ≠æÈ°µ
        function switchAdminTab(tabName) {
            // ÈöêËóèÊâÄÊúâÊ†áÁ≠æÈ°µÂÜÖÂÆπ
            document.querySelectorAll('.admin-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // ÁßªÈô§ÊâÄÊúâÊ†áÁ≠æÈ°µÊ¥ªÂä®Áä∂ÊÄÅ
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.style.borderBottom = '2px solid transparent';
                tab.style.color = 'var(--text-secondary)';
                tab.style.fontWeight = 'normal';
            });
            
            // ÊòæÁ§∫ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æÈ°µ
            document.getElementById(tabName + 'Tab').style.display = 'block';
            
            // ËÆæÁΩÆÈÄâ‰∏≠Ê†áÁ≠æÁöÑÊ¥ªÂä®Áä∂ÊÄÅ
            const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeTab) {
                activeTab.style.borderBottom = '2px solid var(--accent-primary)';
                activeTab.style.color = 'var(--accent-primary)';
                activeTab.style.fontWeight = '600';
            }
            
            // Ê†πÊçÆÊ†áÁ≠æÈ°µÊõ¥Êñ∞Êï∞ÊçÆ
            if (tabName === 'password') {
                updatePasswordList();
            }
        }
        
        // Êõ¥Êñ∞ÁÆ°ÁêÜÈù¢ÊùøÁªüËÆ°Êï∞ÊçÆ
        
        
        // ÁîüÊàêÂØÜÁ†Å
        function generatePassword() {
            const userType = document.getElementById('passwordUserType').value;
            const length = parseInt(document.getElementById('passwordLength').value);
            
            // ÁîüÊàêÂåÖÂê´Â≠óÊØçÂíåÊï∞Â≠óÁöÑÈöèÊú∫ÂØÜÁ†Å
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let password = '';
            
            for (let i = 0; i < length; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            // Á°Æ‰øùÂØÜÁ†ÅÂîØ‰∏ÄÊÄß
            while (userPermissions[password] || customPasswords.exists(password)) {
                password = '';
                for (let i = 0; i < length; i++) {
                    password += chars.charAt(Math.floor(Math.random() * chars.length));
                }
            }
            
            // Ê∑ªÂä†Âà∞Ëá™ÂÆö‰πâÂØÜÁ†ÅÁÆ°ÁêÜ‰∏≠
            customPasswords.add(password, userType);
            
            // ÊòæÁ§∫ÁîüÊàêÁöÑÂØÜÁ†Å
            const generatedPasswordDiv = document.getElementById('generatedPassword');
            const passwordValueDiv = document.getElementById('passwordValue');
            const shareTextValueDiv = document.getElementById('shareTextValue');
            
            if (generatedPasswordDiv && passwordValueDiv) {
                passwordValueDiv.textContent = password;
                generatedPasswordDiv.style.display = 'block';
                
                // Â≠òÂÇ®ÁîüÊàêÁöÑÂØÜÁ†Å‰æõÂ§çÂà∂‰ΩøÁî®
                window.lastGeneratedPassword = password;
                window.lastGeneratedUserType = userType;
                
                // ÁîüÊàêÂàÜ‰∫´ÊñáÊú¨
                const shareText = `PWD:${password}|${userType}|${new Date().toISOString().split('T')[0]}`;
                window.lastGeneratedShareText = shareText;
                
                // ÊòæÁ§∫ÂàÜ‰∫´ÊñáÊú¨
                if (shareTextValueDiv) {
                    shareTextValueDiv.textContent = shareText;
                }
            }
            
            // Êõ¥Êñ∞ÂØÜÁ†ÅÂàóË°®ÊòæÁ§∫
            updatePasswordList();
            
            showToast('ÂØÜÁ†ÅÁîüÊàê', `Â∑≤‰∏∫${userType === 'basic' ? 'Âü∫Á°ÄÁî®Êà∑' : 'È´òÁ∫ßÁî®Êà∑'}ÁîüÊàêÊñ∞ÂØÜÁ†Å: ${password}`, 'success', 4000);
        }
        
        // Â§çÂà∂ÂØÜÁ†Å
        function copyPassword() {
            if (window.lastGeneratedPassword) {
                navigator.clipboard.writeText(window.lastGeneratedPassword).then(() => {
                    showToast('Â§çÂà∂ÊàêÂäü', 'ÂØÜÁ†ÅÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
                }).catch(() => {
                    // ÂÖºÂÆπÊÄßÂõûÈÄÄ
                    const textarea = document.createElement('textarea');
                    textarea.value = window.lastGeneratedPassword;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showToast('Â§çÂà∂ÊàêÂäü', 'ÂØÜÁ†ÅÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
                });
            }
        }
        
        // Â§çÂà∂ÂàÜ‰∫´ÊñáÊú¨ÔºàÊòæÁ§∫ÂàÜ‰∫´Âå∫ÂüüÔºâ
        function copyShareText() {
            if (window.lastGeneratedShareText) {
                // ÊòæÁ§∫ÂàÜ‰∫´ÊñáÊú¨Âå∫Âüü
                const shareTextArea = document.getElementById('shareTextArea');
                if (shareTextArea) {
                    shareTextArea.style.display = 'block';
                }
                
                // Â§çÂà∂ÂàÜ‰∫´ÊñáÊú¨
                navigator.clipboard.writeText(window.lastGeneratedShareText).then(() => {
                    showToast('ÂàÜ‰∫´Á†ÅÂ§çÂà∂ÊàêÂäü', 'üì± Áé∞Âú®ÂèØ‰ª•ÈÄöËøáÂæÆ‰ø°/QQÂèëÈÄÅÁªôÊúãÂèã‰∫ÜÔºÅ\nÊúãÂèãÊî∂Âà∞ÂêéÂú®ÁôªÂΩïÁïåÈù¢ÁÇπÂáª"Á≤òË¥¥ÂàÜ‰∫´Á†Å"Âç≥ÂèØÂØºÂÖ•ÂØÜÁ†Å', 'success', 5000);
                }).catch(() => {
                    // ÂÖºÂÆπÊÄßÂõûÈÄÄ
                    const textarea = document.createElement('textarea');
                    textarea.value = window.lastGeneratedShareText;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showToast('ÂàÜ‰∫´Á†ÅÂ§çÂà∂ÊàêÂäü', 'üì± Áé∞Âú®ÂèØ‰ª•ÈÄöËøáÂæÆ‰ø°/QQÂèëÈÄÅÁªôÊúãÂèã‰∫ÜÔºÅ', 'success', 4000);
                });
            }
        }
        
        // Áõ¥Êé•Â§çÂà∂ÂàÜ‰∫´ÊñáÊú¨ÔºàÁÇπÂáªÊñáÊú¨Âå∫ÂüüÔºâ
        function copyShareTextDirect() {
            if (window.lastGeneratedShareText) {
                navigator.clipboard.writeText(window.lastGeneratedShareText).then(() => {
                    showToast('Â§çÂà∂ÊàêÂäü', 'ÂàÜ‰∫´Á†ÅÂ∑≤Â§çÂà∂', 'success');
                }).catch(() => {
                    showToast('Â§çÂà∂Â§±Ë¥•', 'ËØ∑ÊâãÂä®ÈÄâÊã©ÊñáÊú¨Â§çÂà∂', 'error');
                });
            }
        }
        
        // Êõ¥Êñ∞ÂØÜÁ†ÅÂàóË°®ÊòæÁ§∫
        function updatePasswordList() {
            const passwordListDiv = document.getElementById('passwordList');
            const passwordCountDisplay = document.getElementById('passwordCountDisplay');
            
            if (!passwordListDiv) return;
            
            const allPasswords = customPasswords.getAll();
            const passwordEntries = Object.entries(allPasswords);
            
            // Êõ¥Êñ∞ÂØÜÁ†ÅÊï∞ÈáèÊòæÁ§∫
            if (passwordCountDisplay) {
                passwordCountDisplay.textContent = passwordEntries.length;
            }
            
            if (passwordEntries.length === 0) {
                passwordListDiv.innerHTML = '<div style="color: var(--text-secondary); text-align: center; font-style: italic;">ÊöÇÊó†ÁîüÊàêÁöÑÂØÜÁ†Å</div>';
                return;
            }
            
            const passwordItems = passwordEntries.map(([password, info]) => {
                const levelNames = { basic: 'Âü∫Á°ÄÁî®Êà∑', advanced: 'È´òÁ∫ßÁî®Êà∑' };
                const levelIcons = { basic: 'üÜì', advanced: '‚≠ê' };
                const createdDate = new Date(info.createdAt).toLocaleDateString();
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>${levelIcons[info.level]}</span>
                                <code style="background: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">${password}</code>
                                <span style="color: var(--text-secondary); font-size: 12px;">${levelNames[info.level]}</span>
                            </div>
                            <div style="color: var(--text-muted); font-size: 11px; margin-top: 2px;">ÂàõÂª∫‰∫é: ${createdDate}</div>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button onclick="copyPasswordToClipboard('${password}')" style="background: var(--info); color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;" title="Â§çÂà∂ÂØÜÁ†Å">Â§çÂà∂</button>
                            <button onclick="deleteCustomPassword('${password}')" style="background: var(--warning); color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;" title="Âà†Èô§ÂØÜÁ†Å">Âà†Èô§</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            passwordListDiv.innerHTML = passwordItems;
            
            // ÂêåÊó∂Êõ¥Êñ∞Êí§ÈîÄÂàóË°®
            updateRevokedPasswordList();
        }
        
        // Êõ¥Êñ∞Êí§ÈîÄÂØÜÁ†ÅÂàóË°®ÊòæÁ§∫
        function updateRevokedPasswordList() {
            const revokedPasswordListDiv = document.getElementById('revokedPasswordList');
            const revokedCountDisplay = document.getElementById('revokedCountDisplay');
            
            if (!revokedPasswordListDiv || !revokedCountDisplay) return;
            
            const allRevokedPasswords = revokedPasswords.getAll();
            const revokedEntries = Object.entries(allRevokedPasswords);
            
            // Êõ¥Êñ∞Êí§ÈîÄÊï∞ÈáèÊòæÁ§∫
            revokedCountDisplay.textContent = revokedEntries.length;
            
            if (revokedEntries.length === 0) {
                revokedPasswordListDiv.innerHTML = '<div style="color: var(--text-secondary); text-align: center; font-style: italic;">ÊöÇÊó†Êí§ÈîÄÁöÑÂØÜÁ†Å</div>';
                return;
            }
            
            const revokedItems = revokedEntries.map(([password, info]) => {
                const revokedDate = new Date(info.revokedAt).toLocaleDateString();
                const revokedTime = new Date(info.revokedAt).toLocaleTimeString();
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>üö´</span>
                                <code style="background: #ffebee; padding: 2px 6px; border-radius: 4px; font-weight: 600; color: #c62828;">${password}</code>
                                <span style="color: var(--text-secondary); font-size: 12px;">${info.reason}</span>
                            </div>
                            <div style="color: var(--text-muted); font-size: 11px; margin-top: 2px;">Êí§ÈîÄ‰∫é: ${revokedDate} ${revokedTime}</div>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button onclick="restoreRevokedPassword('${password}')" style="background: var(--success); color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;" title="ÊÅ¢Â§çÂØÜÁ†Å">ÊÅ¢Â§ç</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            revokedPasswordListDiv.innerHTML = revokedItems;
        }
        
        // ÊÅ¢Â§çÊí§ÈîÄÁöÑÂØÜÁ†Å
        function restoreRevokedPassword(password) {
            if (confirm(`Á°ÆËÆ§ÊÅ¢Â§çÂØÜÁ†Å "${password}"Ôºü\nÊÅ¢Â§çÂêéËØ•ÂØÜÁ†ÅÁöÑÂàÜ‰∫´Á†ÅÂ∞ÜÂèØ‰ª•ÂÜçÊ¨°‰ΩøÁî®„ÄÇ`)) {
                revokedPasswords.restore(password);
                updateRevokedPasswordList();
                showToast('ÂØÜÁ†ÅÊÅ¢Â§ç', `ÂØÜÁ†Å ${password} Â∑≤‰ªéÊí§ÈîÄÂàóË°®‰∏≠ÁßªÈô§`, 'success');
            }
        }
        
        // Ê∏ÖÁ©∫ÊâÄÊúâÊí§ÈîÄÂØÜÁ†Å
        function clearRevokedPasswords() {
            const allRevokedPasswords = revokedPasswords.getAll();
            const revokedCount = Object.keys(allRevokedPasswords).length;
            
            if (revokedCount === 0) {
                showToast('ÊèêÁ§∫', 'ÂΩìÂâçÊ≤°ÊúâÊí§ÈîÄÁöÑÂØÜÁ†Å', 'info');
                return;
            }
            
            if (confirm(`Á°ÆËÆ§Ê∏ÖÁ©∫ÊâÄÊúâ ${revokedCount} ‰∏™Êí§ÈîÄËÆ∞ÂΩïÔºü\nÊ∏ÖÁ©∫ÂêéÔºåËøô‰∫õÂØÜÁ†ÅÁöÑÂàÜ‰∫´Á†ÅÂ∞ÜÂèØ‰ª•ÂÜçÊ¨°‰ΩøÁî®„ÄÇ`)) {
                revokedPasswords.clearAll();
                updateRevokedPasswordList();
                showToast('Êí§ÈîÄÊ∏ÖÁ©∫', `Â∑≤Ê∏ÖÁ©∫ÊâÄÊúâ ${revokedCount} ‰∏™Êí§ÈîÄËÆ∞ÂΩï`, 'success');
            }
        }
        
        // Â§çÂà∂ÂØÜÁ†ÅÂà∞Ââ™Ë¥¥Êùø
        function copyPasswordToClipboard(password) {
            navigator.clipboard.writeText(password).then(() => {
                showToast('Â§çÂà∂ÊàêÂäü', `ÂØÜÁ†Å ${password} Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø`, 'success');
            }).catch(() => {
                // ÂÖºÂÆπÊÄßÂõûÈÄÄ
                const textarea = document.createElement('textarea');
                textarea.value = password;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('Â§çÂà∂ÊàêÂäü', `ÂØÜÁ†Å ${password} Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø`, 'success');
            });
        }
        
        // Âà†Èô§Ëá™ÂÆö‰πâÂØÜÁ†Å
        function deleteCustomPassword(password) {
            if (confirm(`Á°ÆËÆ§Âà†Èô§ÂØÜÁ†Å "${password}"Ôºü\nÂà†Èô§ÂêéËØ•ÂØÜÁ†ÅÂ∞ÜÊó†Ê≥ïÂÜçÁî®‰∫éÁôªÂΩïÔºåÂåÖÊã¨‰ΩøÁî®ÂàÜ‰∫´Á†Å„ÄÇ`)) {
                // ÂÖàÂ∞ÜÂØÜÁ†ÅÂä†ÂÖ•Êí§ÈîÄÂàóË°®
                revokedPasswords.revoke(password, 'ÁÆ°ÁêÜÂëòÂà†Èô§');
                
                // ÂÜç‰ªéÂØÜÁ†ÅÂàóË°®‰∏≠ÁßªÈô§
                customPasswords.remove(password);
                
                updatePasswordList();
                showToast('ÂØÜÁ†ÅÂà†Èô§', `ÂØÜÁ†Å ${password} Â∑≤Âà†Èô§Âπ∂Êí§ÈîÄÔºåÁõ∏ÂÖ≥ÂàÜ‰∫´Á†ÅÂ∑≤Â§±Êïà`, 'success');
            }
        }
        
        // === Ê†∏ÂøÉÂàÜ‰∫´ÂäüËÉΩ ===
        
        // === ÂÖçÁôªÂΩïÂØÜÁ†ÅÂØºÂÖ•ÂäüËÉΩ ===
        
        // Á≤òË¥¥ÂàÜ‰∫´Á†ÅÔºàË∂ÖÁÆÄÂçïÂØºÂÖ•ÊñπÂºèÔºâ
        function pasteShareCode() {
            // Â∞ùËØï‰ªéÂâ™Ë¥¥ÊùøËØªÂèñ
            if (navigator.clipboard && navigator.clipboard.readText) {
                navigator.clipboard.readText().then(text => {
                    parseAndImportShareCode(text);
                }).catch(() => {
                    // Â¶ÇÊûúÊó†Ê≥ïËá™Âä®ËØªÂèñÂâ™Ë¥¥ÊùøÔºåËÆ©Áî®Êà∑ÊâãÂä®ËæìÂÖ•
                    showShareCodeInput();
                });
            } else {
                // ‰∏çÊîØÊåÅÂâ™Ë¥¥ÊùøAPIÔºåËÆ©Áî®Êà∑ÊâãÂä®ËæìÂÖ•
                showShareCodeInput();
            }
        }
        
        // ÊòæÁ§∫ÊâãÂä®ËæìÂÖ•ÂàÜ‰∫´Á†ÅÁöÑÂØπËØùÊ°Ü
        function showShareCodeInput() {
            const shareCode = prompt('üì± ËØ∑Á≤òË¥¥ÊúãÂèãÂèëÈÄÅÁöÑÂàÜ‰∫´Á†ÅÔºö\n\nÊ†ºÂºèÁ±ª‰ººÔºöPWD:abc123|advanced|2025-01-01');
            if (shareCode) {
                parseAndImportShareCode(shareCode);
            }
        }
        
        // Ëß£ÊûêÂπ∂ÂØºÂÖ•ÂàÜ‰∫´Á†Å
        function parseAndImportShareCode(shareCode) {
            try {
                // ÂéªÈô§Á©∫ÁôΩÂ≠óÁ¨¶
                shareCode = shareCode.trim();
                
                // Ê£ÄÊü•Ê†ºÂºèÔºöPWD:password|userType|date
                if (!shareCode.startsWith('PWD:')) {
                    throw new Error('ÂàÜ‰∫´Á†ÅÊ†ºÂºèÈîôËØØÔºöÂøÖÈ°ª‰ª•"PWD:"ÂºÄÂ§¥');
                }
                
                // Ëß£ÊûêÂàÜ‰∫´Á†Å
                const parts = shareCode.substring(4).split('|'); // ÂéªÊéâ"PWD:"ÂâçÁºÄ
                if (parts.length < 2) {
                    throw new Error('ÂàÜ‰∫´Á†ÅÊ†ºÂºèÈîôËØØÔºöÁº∫Â∞ëÂøÖË¶Å‰ø°ÊÅØ');
                }
                
                const password = parts[0];
                const userType = parts[1];
                const createDate = parts[2] || new Date().toISOString();
                
                // È™åËØÅÁî®Êà∑Á±ªÂûã
                if (!['basic', 'advanced'].includes(userType)) {
                    throw new Error('ÂàÜ‰∫´Á†ÅÊ†ºÂºèÈîôËØØÔºöÊó†ÊïàÁöÑÁî®Êà∑Á±ªÂûã');
                }
                
                // Ê£ÄÊü•ÂØÜÁ†ÅÊòØÂê¶Â∑≤Ë¢´Êí§ÈîÄ
                if (revokedPasswords.isRevoked(password)) {
                    throw new Error(`ÂØÜÁ†Å "${password}" Â∑≤Ë¢´Êí§ÈîÄÔºåÊó†Ê≥ï‰ΩøÁî®„ÄÇ\nËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëòËé∑ÂèñÊñ∞ÁöÑÂØÜÁ†Å„ÄÇ`);
                }
                
                // Ê£ÄÊü•ÂØÜÁ†ÅÊòØÂê¶Â∑≤Â≠òÂú®
                const existingPasswords = customPasswords.getAll();
                if (existingPasswords[password]) {
                    showPasswordError(`‚ÑπÔ∏è ÂØÜÁ†Å "${password}" Â∑≤Â≠òÂú®ÔºåÂèØ‰ª•Áõ¥Êé•‰ΩøÁî®`, false);
                    
                    // Ëá™Âä®Â°´ÂÖ•ÂØÜÁ†ÅÊ°Ü
                    const passwordInput = document.getElementById('passwordInput');
                    if (passwordInput) {
                        passwordInput.value = password;
                        passwordInput.focus();
                    }
                    return;
                }
                
                // ÂØºÂÖ•Êñ∞ÂØÜÁ†Å
                customPasswords.add(password, userType);
                
                // ÊòæÁ§∫ÊàêÂäü‰ø°ÊÅØ
                const userTypeName = userType === 'basic' ? 'Âü∫Á°ÄÁî®Êà∑' : 'È´òÁ∫ßÁî®Êà∑';
                showPasswordError(`‚úÖ ÂØºÂÖ•ÊàêÂäüÔºÅ\nÂ∑≤Ê∑ªÂä†${userTypeName}ÂØÜÁ†ÅÔºö${password}\nÁé∞Âú®ÂèØ‰ª•‰ΩøÁî®Ëøô‰∏™ÂØÜÁ†ÅÁôªÂΩï‰∫ÜÔºÅ`, false);
                
                // Ëá™Âä®Â°´ÂÖ•ÂØÜÁ†ÅÊ°Ü
                const passwordInput = document.getElementById('passwordInput');
                if (passwordInput) {
                    passwordInput.value = password;
                    passwordInput.placeholder = 'Â∑≤Ëá™Âä®Â°´ÂÖ•ÂØÜÁ†ÅÔºåÊåâÂõûËΩ¶ÁôªÂΩï';
                    setTimeout(() => {
                        passwordInput.focus();
                        passwordInput.select();
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Ëß£ÊûêÂàÜ‰∫´Á†ÅÂ§±Ë¥•:', error);
                showPasswordError(`‚ùå ÂàÜ‰∫´Á†ÅÊ†ºÂºèÈîôËØØÔºö${error.message}\n\nÊ≠£Á°ÆÊ†ºÂºèÁ§∫‰æãÔºöPWD:abc123|advanced|2025-01-01`, false);
            }
        }
        
        // ÂØÜÁ†ÅÂàÜ‰∫´ÂäüËÉΩÂ∑≤ÁÆÄÂåñÔºåÊñá‰ª∂ÂØºÂÖ•ÂäüËÉΩÂ∑≤ÁßªÈô§
        
        // Êõ¥Êñ∞ÈÖçÈ¢ùÁÆ°ÁêÜÊ†áÁ≠æÈ°µ‰∏≠ÁöÑÂØÜÁ†ÅÂàóË°®
        function updateQuotaPasswordList() {
            const quotaPasswordListDiv = document.getElementById('quotaPasswordList');
            const passwordCountSpan = document.getElementById('passwordCount');
            
            if (!quotaPasswordListDiv || !passwordCountSpan) return;
            
            const allPasswords = customPasswords.getAll();
            const passwordEntries = Object.entries(allPasswords);
            
            // Êõ¥Êñ∞ÂØÜÁ†ÅÊï∞Èáè
            passwordCountSpan.textContent = passwordEntries.length;
            
            if (passwordEntries.length === 0) {
                quotaPasswordListDiv.innerHTML = '<div style="color: var(--text-secondary); text-align: center; font-style: italic;">ÊöÇÊó†ÁîüÊàêÁöÑÂØÜÁ†Å</div>';
                return;
            }
            
            // ÊåâÁî®Êà∑Á±ªÂûãÂàÜÁªÑÊòæÁ§∫
            const basicPasswords = passwordEntries.filter(([_, info]) => info.level === 'basic');
            const advancedPasswords = passwordEntries.filter(([_, info]) => info.level === 'advanced');
            
            let html = '';
            
            if (basicPasswords.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                            üÜì Âü∫Á°ÄÁî®Êà∑ÂØÜÁ†Å (${basicPasswords.length})
                        </div>
                        ${basicPasswords.map(([password, info]) => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 8px; margin: 2px 0; background: white; border-radius: 4px; border-left: 3px solid var(--accent-primary);">
                                <code style="font-weight: 600; color: var(--accent-primary);">${password}</code>
                                <div style="display: flex; gap: 4px;">
                                    <button onclick="copyPasswordToClipboard('${password}')" style="background: var(--info); color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 10px;">Â§çÂà∂</button>
                                    <button onclick="deleteCustomPasswordFromQuota('${password}')" style="background: var(--warning); color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 10px;">Âà†Èô§</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            if (advancedPasswords.length > 0) {
                html += `
                    <div>
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                            ‚≠ê È´òÁ∫ßÁî®Êà∑ÂØÜÁ†Å (${advancedPasswords.length})
                        </div>
                        ${advancedPasswords.map(([password, info]) => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 8px; margin: 2px 0; background: white; border-radius: 4px; border-left: 3px solid var(--accent-secondary);">
                                <code style="font-weight: 600; color: var(--accent-secondary);">${password}</code>
                                <div style="display: flex; gap: 4px;">
                                    <button onclick="copyPasswordToClipboard('${password}')" style="background: var(--info); color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 10px;">Â§çÂà∂</button>
                                    <button onclick="deleteCustomPasswordFromQuota('${password}')" style="background: var(--warning); color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 10px;">Âà†Èô§</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            quotaPasswordListDiv.innerHTML = html;
        }
        
        // ‰ªéÈÖçÈ¢ùÁÆ°ÁêÜÁïåÈù¢Âà†Èô§ÂØÜÁ†Å
        function deleteCustomPasswordFromQuota(password) {
            if (confirm(`Á°ÆËÆ§Âà†Èô§ÂØÜÁ†Å "${password}"Ôºü\nÂà†Èô§ÂêéËØ•ÂØÜÁ†ÅÂ∞ÜÊó†Ê≥ïÂÜçÁî®‰∫éÁôªÂΩïÔºåÂåÖÊã¨‰ΩøÁî®ÂàÜ‰∫´Á†Å„ÄÇ`)) {
                // ÂÖàÂ∞ÜÂØÜÁ†ÅÂä†ÂÖ•Êí§ÈîÄÂàóË°®
                revokedPasswords.revoke(password, 'ÁÆ°ÁêÜÂëòÂà†Èô§');
                
                // ÂÜç‰ªéÂØÜÁ†ÅÂàóË°®‰∏≠ÁßªÈô§
                customPasswords.remove(password);
                
                updatePasswordList();
                showToast('ÂØÜÁ†ÅÂà†Èô§', `ÂØÜÁ†Å ${password} Â∑≤Âà†Èô§Âπ∂Êí§ÈîÄÔºåÁõ∏ÂÖ≥ÂàÜ‰∫´Á†ÅÂ∑≤Â§±Êïà`, 'success');
            }
        }
        
        // Ê∏ÖÈô§ÊâÄÊúâËá™ÂÆö‰πâÂØÜÁ†Å
        function clearAllPasswords() {
            const allPasswords = customPasswords.getAll();
            const passwordCount = Object.keys(allPasswords).length;
            
            if (passwordCount === 0) {
                showToast('ÊèêÁ§∫', 'ÂΩìÂâçÊ≤°ÊúâÁîüÊàêÁöÑÂØÜÁ†Å', 'info');
                return;
            }
            
            if (confirm(`Á°ÆËÆ§Ê∏ÖÈô§ÊâÄÊúâ ${passwordCount} ‰∏™ÁîüÊàêÁöÑÂØÜÁ†ÅÔºü\nÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºåÊâÄÊúâËá™ÂÆö‰πâÂØÜÁ†ÅÂ∞ÜÊó†Ê≥ïÂÜçÁî®‰∫éÁôªÂΩïÔºåÂåÖÊã¨‰ΩøÁî®ÂàÜ‰∫´Á†Å„ÄÇ`)) {
                // ÂÖàÂ∞ÜÊâÄÊúâÂØÜÁ†ÅÂä†ÂÖ•Êí§ÈîÄÂàóË°®
                Object.keys(allPasswords).forEach(password => {
                    revokedPasswords.revoke(password, 'ÊâπÈáèÊ∏ÖÈô§');
                });
                
                // Ê∏ÖÈô§ÊâÄÊúâËá™ÂÆö‰πâÂØÜÁ†Å
                localStorage.removeItem('customPasswords');
                
                // Êõ¥Êñ∞ÊâÄÊúâÁõ∏ÂÖ≥ÊòæÁ§∫
                updatePasswordList();
                
                showToast('ÂØÜÁ†ÅÊ∏ÖÈô§', `Â∑≤Ê∏ÖÈô§ÊâÄÊúâ ${passwordCount} ‰∏™Ëá™ÂÆö‰πâÂØÜÁ†ÅÂπ∂Êí§ÈîÄÔºåÁõ∏ÂÖ≥ÂàÜ‰∫´Á†ÅÂ∑≤Â§±Êïà`, 'success');
            }
        }
        
        
        // === ÈÄÄÂá∫ÁôªÂΩïÂäüËÉΩ ===
        
        // ÊòæÁ§∫ÈÄÄÂá∫Á°ÆËÆ§ÂØπËØùÊ°Ü
        async function showLogoutConfirm() {
            const confirmed = await showConfirm(
                'ÈÄÄÂá∫ÁôªÂΩï',
                `Á°ÆËÆ§ÈÄÄÂá∫ÂΩìÂâçË¥¶Âè∑ ${currentUser ? currentUser.icon + ' ' + currentUser.name : ''}Ôºü\n\nÈÄÄÂá∫ÂêéÈúÄË¶ÅÈáçÊñ∞ËæìÂÖ•ÂØÜÁ†ÅÊâçËÉΩ‰ΩøÁî®Á≥ªÁªü„ÄÇ`,
                'üö™'
            );
            
            if (confirmed) {
                logout();
            }
        }
        
        // ÊâßË°åÈÄÄÂá∫ÁôªÂΩï
        function logout() {
            // ÂÖ≥Èó≠ÁÆ°ÁêÜÈù¢ÊùøÔºàÂ¶ÇÊûúÊâìÂºÄÁöÑËØùÔºâ
            closeAdminPanel();
            
            // Ê∏ÖÈô§‰ºöËØùÁä∂ÊÄÅ
            sessionStorage.removeItem('authenticated');
            sessionStorage.removeItem('userLevel');
            sessionStorage.removeItem('userPermissions');
            sessionStorage.removeItem('currentPassword');
            
            // Ê∏ÖÈô§ÂΩìÂâçÁî®Êà∑‰ø°ÊÅØ
            currentUser = null;
            currentPassword = null;
            
            // ÈöêËóèÁî®Êà∑Áä∂ÊÄÅ
            const userStatus = document.getElementById('userStatus');
            if (userStatus) {
                userStatus.style.display = 'none';
            }
            
            // Á°Æ‰øùÂØÜÁ†ÅÁïåÈù¢ÂèØËßÅÔºå‰∏ªÂ∫îÁî®ÈöêËóè
            const mainApp = document.getElementById('mainApp');
            const passwordOverlay = document.getElementById('passwordOverlay');
            
            if (mainApp) {
                mainApp.classList.remove('authenticated');
                mainApp.style.display = 'none'; // Âº∫Âà∂ÈöêËóè
            }
            
            if (passwordOverlay) {
                passwordOverlay.style.display = 'block'; // Âº∫Âà∂ÊòæÁ§∫
            }
            
            // Ê∏ÖÁ©∫Âπ∂ËÅöÁÑ¶ÂØÜÁ†ÅËæìÂÖ•Ê°Ü
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.value = '';
                
                // Âº∫Âà∂Âà∑Êñ∞ÁïåÈù¢ÊòæÁ§∫
                setTimeout(() => {
                    passwordInput.focus();
                    // ÈáçÁΩÆ‰∏ªÂ∫îÁî®ÊòæÁ§∫
                    if (mainApp) {
                        mainApp.style.display = '';
                    }
                }, 50);
            }
            
            // Ê∏ÖÈô§ÂÜÖÂÆπÔºàÂèØÈÄâÔºâ
            const markdownInput = document.getElementById('markdownInput');
            if (markdownInput && markdownInput.value.trim()) {
                // Â¶ÇÊûúÊúâÂÜÖÂÆπÔºåËØ¢ÈóÆÊòØÂê¶‰øùÂ≠òËçâÁ®ø
                if (confirm('ÊòØÂê¶Â∞ÜÂΩìÂâçÂÜÖÂÆπ‰øùÂ≠ò‰∏∫ËçâÁ®øÔºü')) {
                    saveToLocal();
                }
                markdownInput.value = '';
            }
            
            // ÈáçÁΩÆÈ¢ÑËßà
            const preview = document.getElementById('preview');
            if (preview) {
                preview.innerHTML = `
                    <div class="preview-empty">
                        <div class="preview-empty-icon">üìù</div>
                        <div class="preview-empty-title">ÂºÄÂßãÂàõ‰ΩúÊÇ®ÁöÑÊñáÊ°£</div>
                        <div class="preview-empty-subtitle">
                            Âú®Â∑¶‰æßËæìÂÖ•Ê°Ü‰∏≠ËæìÂÖ•MarkdownÂÜÖÂÆπ<br>
                            ÊàñËÄÖ‰ΩøÁî®‰∏ãÊñπÁöÑÂø´ÈÄüÊìç‰Ωú
                        </div>
                        <div class="preview-quick-actions" role="group" aria-label="Âø´ÈÄüÊìç‰Ωú">
                            <button class="quick-action-btn" onclick="loadExample('simple')" aria-label="Âä†ËΩΩÁÆÄÂçïÁ§∫‰æã">üìÑ ÁÆÄÂçïÁ§∫‰æã</button>
                            <button class="quick-action-btn" onclick="loadExample('advanced')" aria-label="Âä†ËΩΩÈ´òÁ∫ßÁ§∫‰æã">üöÄ È´òÁ∫ßÁ§∫‰æã</button>
                            <button class="quick-action-btn" onclick="uploadFile()" aria-label="‰∏ä‰º†MarkdownÊñá‰ª∂">üìÅ ‰∏ä‰º†Êñá‰ª∂</button>
                            <button class="quick-action-btn" onclick="loadFromLocal()" aria-label="Âä†ËΩΩÊú¨Âú∞ËçâÁ®ø">üìÇ Âä†ËΩΩËçâÁ®ø</button>
                        </div>
                    </div>
                `;
            }
            
            // ÈáçÁΩÆÁªüËÆ°
            updateWordCount();
            
            showToast('ÈÄÄÂá∫ÊàêÂäü', 'Â∑≤ÈÄÄÂá∫ÁôªÂΩïÔºåËØ∑ÈáçÊñ∞ËæìÂÖ•ÂØÜÁ†Å', 'info', 2000);
        }
        
        // ÊòæÁ§∫ÂçáÁ∫ßÊèêÁ§∫ÁïåÈù¢
        function showUpgradePrompt(title, message, type) {
            // ÁÆÄÂåñÂçáÁ∫ßÈÄâÈ°πÔºåÂè™Êé®ËçêÈ´òÁ∫ßÁî®Êà∑
            const upgradeRecommendation = `
                <div style="padding: 12px; margin: 8px 0; background: var(--preview-bg); border-radius: 8px; border-left: 4px solid var(--accent-primary);">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                        <span style="font-size: 18px;">‚≠ê</span>
                        <strong style="color: var(--accent-primary);">È´òÁ∫ßÁî®Êà∑</strong>
                    </div>
                    <div style="color: var(--text-secondary); margin-bottom: 8px;">
                        ‚Ä¢ ÊØèÊó•50Ê¨°ËΩ¨Êç¢ (Âü∫Á°ÄÁâà15Ê¨°)<br>
                        ‚Ä¢ 50KÂ≠óÁ¨¶ÊñáÊ°£ (Âü∫Á°ÄÁâà10K)<br>
                        ‚Ä¢ ÊîØÊåÅÊï∞Â≠¶ÂÖ¨Âºè<br>
                        ‚Ä¢ ÊâπÈáèÂ§ÑÁêÜÂäüËÉΩ
                    </div>
                    <div style="background: var(--accent-primary); color: white; padding: 4px 8px; border-radius: 4px; display: inline-block; font-size: 12px; font-weight: 600;">
                        ËÅîÁ≥ªÁÆ°ÁêÜÂëòËé∑ÂèñÂØÜÁ†Å
                    </div>
                </div>
            `;
            
            showConfirm(
                title,
                `${message}<br><br><strong>Êé®ËçêÂçáÁ∫ßÊñπÊ°àÔºö</strong><br>${upgradeRecommendation}`,
                'üíé'
            );
        }
        
        // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÈ™åËØÅËøá
        function checkAuthentication() {
            if (sessionStorage.getItem('authenticated') === 'true') {
                // ÊÅ¢Â§çÁî®Êà∑ÊùÉÈôê‰ø°ÊÅØ
                const storedPermissions = sessionStorage.getItem('userPermissions');
                if (storedPermissions) {
                    currentUser = JSON.parse(storedPermissions);
                }
                
                // ÊÅ¢Â§çÂΩìÂâç‰ΩøÁî®ÁöÑÂØÜÁ†Å
                const storedPassword = sessionStorage.getItem('currentPassword');
                if (storedPassword) {
                    currentPassword = storedPassword;
                }
                
                document.getElementById('passwordOverlay').style.display = 'none';
                document.getElementById('mainApp').classList.add('authenticated');
                updateUserStatus(); // ÊÅ¢Â§çÊó∂Êõ¥Êñ∞Áä∂ÊÄÅ
                initializeApp();
            } else {
                // ËÅöÁÑ¶Âà∞ÂØÜÁ†ÅËæìÂÖ•Ê°Ü
                setTimeout(() => {
                    document.getElementById('passwordInput').focus();
                }, 100);
            }
        }
        
        // === AIÊô∫ËÉΩ‰øÆÂ§çÁ≥ªÁªü ===
        
        // AIÊúçÂä°ÂïÜÈÖçÁΩÆ
        const AI_CONFIGS = {
            kimi: {
                name: 'Kimi (moonshot)',
                endpoint: 'https://api.moonshot.cn/v1/chat/completions',
                models: [
                    { value: 'moonshot-v1-8k', label: 'moonshot-v1-8k (8K‰∏ä‰∏ãÊñá)' },
                    { value: 'moonshot-v1-32k', label: 'moonshot-v1-32k (32K‰∏ä‰∏ãÊñá)' },
                    { value: 'moonshot-v1-128k', label: 'moonshot-v1-128k (128K‰∏ä‰∏ãÊñá)' }
                ]
            },
            glm: {
                name: 'Êô∫Ë∞±GLM',
                endpoint: 'https://open.bigmodel.cn/api/paas/v4/chat/completions',
                models: [
                    { value: 'glm-4-plus', label: 'GLM-4-Plus (È´òÊÄßËÉΩÁâà)' },
                    { value: 'glm-4-flash', label: 'GLM-4-Flash (Âø´ÈÄüÁâà)' }
                ]
            },
            baichuan: {
                name: 'ÁôæÂ∑ùAI',
                endpoint: 'https://api.baichuan-ai.com/v1/chat/completions',
                models: [
                    { value: 'Baichuan3-Turbo-128k', label: 'Baichuan3-Turbo-128k' }
                ]
            },
            deepseek: {
                name: 'DeepSeek',
                endpoint: 'https://api.deepseek.com/v1/chat/completions',
                models: [
                    { value: 'deepseek-chat', label: 'deepseek-chat' }
                ]
            },
            openai: {
                name: 'OpenAI',
                endpoint: 'https://oapio.asia/v1/chat/completions',
                models: [
                    { value: 'gpt-4o-mini', label: 'GPT-4o-mini' },
                    { value: 'gpt-4o-2024-11-20', label: 'GPT-4o-2024-11-20' },
                    { value: 'claude-3-5-sonnet-20241022', label: 'Claude-3.5-Sonnet' },
                    { value: 'claude-sonnet-4-20250514', label: 'Claude-4.0-Sonnet' }
                ]
            }
        };
        
        // AI‰øÆÂ§çÁöÑÁ≥ªÁªüÊèêÁ§∫ËØç
        const AI_SYSTEM_PROMPTS = {
            quick_fix: `‰Ω†ÊòØ‰∏Ä‰∏™MarkdownÊ†ºÂºè‰øÆÂ§ç‰∏ìÂÆ∂„ÄÇËØ∑‰øÆÂ§çÁî®Êà∑Êèê‰æõÁöÑÊñáÊú¨Ôºå‰ΩøÂÖ∂Á¨¶ÂêàÊ†áÂáÜMarkdownËØ≠Ê≥ïÔºö

1. ‰øÆÂ§çÊ†áÈ¢òÊ†ºÂºè (Á°Æ‰øù # ÂêéÊúâÁ©∫Ê†º)
2. ‰øÆÂ§çÂàóË°®Ê†ºÂºè (Á°Æ‰øù - Êàñ 1. ÂêéÊúâÁ©∫Ê†º)  
3. ‰øÆÂ§ç‰ª£Á†ÅÂùóÊ†ºÂºè (Á°Æ‰øùÊ≠£Á°ÆÁöÑ\`\`\`ÂåÖÂõ¥)
4. ‰øÆÂ§çÈìæÊé•Ê†ºÂºè [text](url)
5. ‰øÆÂ§çË°®Ê†ºÊ†ºÂºè (Á°Æ‰øùÊ≠£Á°ÆÁöÑ|ÂàÜÈöî)
6. ‰øÆÂ§çÂºïÁî®Ê†ºÂºè (Á°Æ‰øù > ÂêéÊúâÁ©∫Ê†º)
7. ‰øùÊåÅÂéüÊúâÂÜÖÂÆπÂê´‰πâ‰∏çÂèò
8. Âè™ËøîÂõû‰øÆÂ§çÂêéÁöÑMarkdownÊñáÊú¨Ôºå‰∏çË¶ÅÊ∑ªÂä†Ëß£Èáä
9. ‰øÆÂ§çÂÖ¨ÂºèÊ†ºÂºèÔºàÊØè‰∏ÄÊù°ÂÖ¨ÂºèÁöÑlatex‰ª£Á†ÅË¶ÅÂÜôÂú®‰∏ÄË°åÈáåÔºåÊç¢Ë°åÁöÑËØùÂÆûÊó∂È¢ÑËßà‰ºöÂ§±ÊïàÔºâ
10. ‰øÆÂ§çÁ≤ó‰ΩìÂíåÊñú‰ΩìÁ≠âÁ≠âÔºàÁ≤ó‰ΩìÂíåÊñú‰ΩìÁ≠âÊúÄÂêé‰∏Ä‰∏™*Â≠óÁ¨¶‰πãÂêéÈúÄË¶ÅÁ©∫‰∏ÄÊ†ºÔºâ
ËØ∑‰øÆÂ§ç‰ª•‰∏ãÂÜÖÂÆπÔºö`,

            advanced_optimize: `‰Ω†ÊòØ‰∏Ä‰∏™ÊñáÊ°£‰ºòÂåñ‰∏ìÂÆ∂„ÄÇËØ∑‰ºòÂåñÁî®Êà∑ÁöÑMarkdownÊñáÊ°£Ôºö

1. ÂÆåÂñÑÊ†áÈ¢òÂ±ÇÊ¨°ÁªìÊûÑ
2. ‰ºòÂåñÊÆµËêΩÁªìÊûÑÂíåÈÄªËæë
3. Ê∑ªÂä†ÈÄÇÂΩìÁöÑÂàÜÂâ≤Á∫øÂíåÁ©∫Ë°å
4. ÊîπËøõË°®Ê†ºÂíåÂàóË°®ÁöÑÂèØËØªÊÄß
5. Ê∑ªÂä†ÂêàÈÄÇÁöÑÂºïÁî®ÂíåÂº∫Ë∞É
6. ‰øùÊåÅÂéüÊúâÊ†∏ÂøÉÂÜÖÂÆπ‰∏çÂèò
7. Á°Æ‰øùÂÖ¨ÂºèÊ†ºÂºèÔºàÊØè‰∏ÄÊù°ÂÖ¨ÂºèÁöÑlatex‰ª£Á†ÅË¶ÅÂÜôÂú®‰∏ÄË°åÈáåÔºåÊç¢Ë°åÁöÑËØùÂÆûÊó∂È¢ÑËßà‰ºöÂ§±ÊïàÔºâ
8. ‰øÆÂ§çÁ≤ó‰ΩìÂíåÊñú‰ΩìÁ≠âÁ≠âÔºàÁ≤ó‰ΩìÂíåÊñú‰ΩìÁ≠âÊúÄÂêé‰∏Ä‰∏™*Â≠óÁ¨¶‰πãÂêéÈúÄË¶ÅÁ©∫‰∏ÄÊ†ºÔºâ
9. ËøîÂõû‰ºòÂåñÂêéÁöÑMarkdownÊñáÊú¨


ËØ∑‰ºòÂåñ‰ª•‰∏ãÂÜÖÂÆπÔºö`
        };
        
        // AI‰ΩøÁî®ÈÖçÈ¢ùÁÆ°ÁêÜ
        const AI_USAGE_LIMITS = {
            basic: 0,        // Âü∫Á°ÄÁî®Êà∑Êó†Ê≥ï‰ΩøÁî®
            advanced: 10,    // È´òÁ∫ßÁî®Êà∑ÊØèÊó•10Ê¨°
            super_admin: -1  // Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÊó†ÈôêÂà∂
        };
        
        // È¢ÑÈÖçÁΩÆÁöÑAIÊúçÂä°ÔºàÈ´òÁ∫ßÁî®Êà∑‰∏ìÁî®Ôºâ
        const PRESET_AI_CONFIG = {
            provider: 'kimi',
            model: 'moonshot-v1-8k',
            apiKey: 'sk-gHkveDRADoUyhVOFxxN2oUBYft8A1sQ6Xc1czwaoVtySgKD2', // È¢ÑÈÖçÁΩÆÁöÑKimi APIÂØÜÈí•
            fixFormat: true,
            fixSyntax: true,
            optimizeContent: false,
            addStructure: false
        };
        
        // ÊòæÁ§∫AIÈÖçÁΩÆÊ®°ÊÄÅÊ°Ü
        function showAIConfigModal() {
            if (!canUseAIFix()) {
                showUpgradePrompt(
                    'AI‰øÆÂ§çÈúÄË¶ÅÂçáÁ∫ß',
                    'AIÊô∫ËÉΩ‰øÆÂ§çÂäüËÉΩ‰ªÖÂØπÈ´òÁ∫ßÁî®Êà∑ÂºÄÊîæ„ÄÇ\nÂçáÁ∫ßÂêéÂèØ‰∫´ÂèóÊØèÊó•10Ê¨°AI‰øÆÂ§çÊúçÂä°ÔºÅ',
                    'ai'
                );
                return;
            }
            
            // Ê†πÊçÆÁî®Êà∑Á∫ßÂà´ÊòæÁ§∫‰∏çÂêåÁöÑÈÖçÁΩÆÁïåÈù¢
            if (currentUser.level === 'super_admin') {
                // Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÔºöÊòæÁ§∫ÂÆåÊï¥ÈÖçÁΩÆÁïåÈù¢
                showFullAIConfig();
            } else {
                // È´òÁ∫ßÁî®Êà∑ÔºöÊòæÁ§∫ÁÆÄÂåñÈÖçÁΩÆÁïåÈù¢
                showSimpleAIConfig();
            }
        }
        
        // È´òÁ∫ßÁî®Êà∑ÁöÑÁÆÄÂåñAIÈÖçÁΩÆÁïåÈù¢
        function showSimpleAIConfig() {
            showConfirm(
                'ü§ñ AIÊô∫ËÉΩ‰øÆÂ§ç',
                `
                <div style="text-align: left; max-width: 450px;">
                    <div style="background: var(--preview-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin-top: 0; color: var(--accent-primary);">üéâ Âç≥ÂºÄÂç≥Áî®</h3>
                        <p style="margin: 10px 0; color: var(--text-secondary);">
                            Êàë‰ª¨Â∑≤‰∏∫ÊÇ®È¢ÑÈÖçÁΩÆÂ•Ω <strong>Kimi AI</strong> ÊúçÂä°ÔºåÊó†ÈúÄÈ¢ùÂ§ñËÆæÁΩÆÔºÅ
                        </p>
                        
                        <div style="background: rgba(255, 107, 107, 0.1); padding: 15px; border-radius: 6px; border-left: 3px solid #ff6b6b; margin: 15px 0;">
                            <div style="font-weight: 600; margin-bottom: 5px;">üìä ‰ΩøÁî®ÈÖçÈ¢ù</div>
                            <div style="font-size: 14px; color: var(--text-secondary);">
                                ‰ªäÊó•Ââ©‰Ωô: <strong id="simpleAiUsageCount" style="color: #ff6b6b;">--</strong> Ê¨°
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 10px;">‚ú® ‰ΩøÁî®ÊñπÊ≥ï</h4>
                            <ul style="margin: 0; padding-left: 20px; color: var(--text-secondary); font-size: 14px; line-height: 1.6;">
                                <li>Âú®ËæìÂÖ•Ê°Ü‰∏≠ÁºñÂÜôÊàñÁ≤òË¥¥MarkdownÂÜÖÂÆπ</li>
                                <li>ÁÇπÂáª <strong>‚ö° Âø´ÈÄü‰øÆÂ§ç</strong> Ëá™Âä®‰øÆÂ§çÊ†ºÂºèÈóÆÈ¢ò</li>
                                <li>ÁÇπÂáª <strong>üß† Ê∑±Â∫¶‰ºòÂåñ</strong> ÈáçÊñ∞ÁªÑÁªáÊñáÊ°£ÁªìÊûÑ</li>
                                <li>‰ΩøÁî®Âø´Êç∑ÈîÆ <strong>Ctrl+Alt+F</strong> Âø´ÈÄü‰øÆÂ§ç</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="background: rgba(116, 185, 255, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--info);">
                        <div style="font-weight: 600; margin-bottom: 5px;">üí° ÂçáÁ∫ßÊèêÁ§∫</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">
                            ÂçáÁ∫ßÂà∞Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÂèØËá™ÂÆö‰πâAIÊúçÂä°ÂïÜÔºå‰ΩøÁî®GLM„ÄÅÁôæÂ∑ù„ÄÅDeepSeekÁ≠âÊõ¥Â§öÊ®°ÂûãÔºÅ
                        </div>
                    </div>
                </div>
                `,
                'üöÄ'
            ).then(() => {
                // Ëá™Âä®‰∏∫È´òÁ∫ßÁî®Êà∑ËÆæÁΩÆÈ¢ÑÈÖçÁΩÆ
                ensurePresetConfig();
                // Êõ¥Êñ∞‰ΩøÁî®Ê¨°Êï∞ÊòæÁ§∫
                updateSimpleAIUsageDisplay();
            });
        }
        
        // Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÁöÑÂÆåÊï¥AIÈÖçÁΩÆÁïåÈù¢
        function showFullAIConfig() {
            // Âä†ËΩΩ‰øùÂ≠òÁöÑÈÖçÁΩÆ
            loadAIConfig();
            document.getElementById('aiConfigModal').style.display = 'block';
        }
        
        // Á°Æ‰øùÈ´òÁ∫ßÁî®Êà∑ÊúâÈ¢ÑÈÖçÁΩÆ
        function ensurePresetConfig() {
            const savedConfig = localStorage.getItem('aiConfig');
            if (!savedConfig) {
                // Â¶ÇÊûúÊ≤°ÊúâÈÖçÁΩÆÔºå‰ΩøÁî®È¢ÑËÆæÈÖçÁΩÆ
                localStorage.setItem('aiConfig', JSON.stringify(PRESET_AI_CONFIG));
            }
        }
        
        // Êõ¥Êñ∞ÁÆÄÂåñÁïåÈù¢ÁöÑ‰ΩøÁî®Ê¨°Êï∞ÊòæÁ§∫
        function updateSimpleAIUsageDisplay() {
            if (!currentUser || currentUser.level !== 'advanced') return;
            
            const today = new Date().toDateString();
            const usageKey = `ai_usage_${currentUser.level}_${today}`;
            const currentUsage = parseInt(localStorage.getItem(usageKey) || '0');
            const limit = AI_USAGE_LIMITS[currentUser.level];
            
            const usageCountElement = document.getElementById('simpleAiUsageCount');
            if (usageCountElement) {
                usageCountElement.textContent = `${limit - currentUsage}`;
            }
        }
        
        // ÂÖ≥Èó≠AIÈÖçÁΩÆÊ®°ÊÄÅÊ°Ü
        function closeAIConfigModal() {
            document.getElementById('aiConfigModal').style.display = 'none';
        }
        
        // Êõ¥Êñ∞AIÊ®°ÂûãÈÄâÊã©
        function updateAIModels() {
            const provider = document.getElementById('aiProvider').value;
            const modelSelect = document.getElementById('aiModel');
            const config = AI_CONFIGS[provider];
            
            // Ê∏ÖÁ©∫ÂΩìÂâçÈÄâÈ°π
            modelSelect.innerHTML = '';
            
            // Ê∑ªÂä†Êñ∞ÁöÑÊ®°ÂûãÈÄâÈ°π
            config.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.label;
                modelSelect.appendChild(option);
            });
        }
        
        // ÂàáÊç¢APIÂØÜÈí•ÂèØËßÅÊÄß
        function toggleAPIKeyVisibility() {
            const apiKeyInput = document.getElementById('aiApiKey');
            const toggleBtn = apiKeyInput.nextElementSibling;
            
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                toggleBtn.textContent = 'üôà';
                toggleBtn.title = 'ÈöêËóèAPIÂØÜÈí•';
            } else {
                apiKeyInput.type = 'password';
                toggleBtn.textContent = 'üëÅÔ∏è';
                toggleBtn.title = 'ÊòæÁ§∫APIÂØÜÈí•';
            }
        }
        
        // ‰øùÂ≠òAIÈÖçÁΩÆ
        function saveAIConfig() {
            const provider = document.getElementById('aiProvider').value;
            const model = document.getElementById('aiModel').value;
            const apiKey = document.getElementById('aiApiKey').value.trim();
            
            if (!apiKey) {
                showToast('ÈÖçÁΩÆÈîôËØØ', 'ËØ∑ËæìÂÖ•APIÂØÜÈí•', 'warning');
                return;
            }
            
            // ‰øùÂ≠òÈÖçÁΩÆÂà∞Êú¨Âú∞Â≠òÂÇ®
            const config = {
                provider: provider,
                model: model,
                apiKey: apiKey,
                fixFormat: document.getElementById('fixFormat').checked,
                fixSyntax: document.getElementById('fixSyntax').checked,
                optimizeContent: document.getElementById('optimizeContent').checked,
                addStructure: document.getElementById('addStructure').checked,
                timestamp: Date.now()
            };
            
            localStorage.setItem('aiConfig', JSON.stringify(config));
            
            showToast('ÈÖçÁΩÆ‰øùÂ≠ò', 'AI‰øÆÂ§çÈÖçÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
            closeAIConfigModal();
            
            // Êõ¥Êñ∞‰ΩøÁî®Ê¨°Êï∞ÊòæÁ§∫
            updateAIUsageDisplay();
        }
        
        // Âä†ËΩΩAIÈÖçÁΩÆ
        function loadAIConfig() {
            const savedConfig = localStorage.getItem('aiConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    
                    document.getElementById('aiProvider').value = config.provider || 'kimi';
                    updateAIModels();
                    document.getElementById('aiModel').value = config.model || AI_CONFIGS[config.provider].models[0].value;
                    document.getElementById('aiApiKey').value = config.apiKey || '';
                    document.getElementById('fixFormat').checked = config.fixFormat !== false;
                    document.getElementById('fixSyntax').checked = config.fixSyntax !== false;
                    document.getElementById('optimizeContent').checked = config.optimizeContent || false;
                    document.getElementById('addStructure').checked = config.addStructure || false;
                } catch (error) {
                    console.error('Âä†ËΩΩAIÈÖçÁΩÆÂ§±Ë¥•:', error);
                }
            } else {
                // ÈªòËÆ§ÈÖçÁΩÆ
                updateAIModels();
            }
        }
        
        // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•‰ΩøÁî®AI‰øÆÂ§çÂäüËÉΩ
        function canUseAIFix() {
            return currentUser && currentUser.features && currentUser.features.aiFix;
        }
        
        // Ê£ÄÊü•AI‰ΩøÁî®ÈÖçÈ¢ù
        function checkAIUsageLimit() {
            if (!currentUser) return false;
            
            const today = new Date().toDateString();
            const usageKey = `ai_usage_${currentUser.level}_${today}`;
            const currentUsage = parseInt(localStorage.getItem(usageKey) || '0');
            const limit = AI_USAGE_LIMITS[currentUser.level];
            
            return limit === -1 || currentUsage < limit;
        }
        
        // Â¢ûÂä†AI‰ΩøÁî®Ê¨°Êï∞
        function incrementAIUsage() {
            if (!currentUser) return;
            
            const today = new Date().toDateString();
            const usageKey = `ai_usage_${currentUser.level}_${today}`;
            const currentUsage = parseInt(localStorage.getItem(usageKey) || '0');
            
            localStorage.setItem(usageKey, (currentUsage + 1).toString());
            updateAIUsageDisplay();
        }
        
        // Êõ¥Êñ∞AI‰ΩøÁî®Ê¨°Êï∞ÊòæÁ§∫
        function updateAIUsageDisplay() {
            if (!currentUser || !canUseAIFix()) return;
            
            const today = new Date().toDateString();
            const usageKey = `ai_usage_${currentUser.level}_${today}`;
            const currentUsage = parseInt(localStorage.getItem(usageKey) || '0');
            const limit = AI_USAGE_LIMITS[currentUser.level];
            
            const usageCountElement = document.getElementById('aiUsageCount');
            if (usageCountElement) {
                if (limit === -1) {
                    usageCountElement.textContent = 'Êó†ÈôêÂà∂';
                } else {
                    usageCountElement.textContent = `${limit - currentUsage}`;
                }
            }
        }
        
        // Âø´ÈÄüAI‰øÆÂ§çÂäüËÉΩ
        async function performQuickAIFix() {
            if (!canUseAIFix()) {
                showUpgradePrompt(
                    'AI‰øÆÂ§çÈúÄË¶ÅÂçáÁ∫ß',
                    'AIÊô∫ËÉΩ‰øÆÂ§çÂäüËÉΩ‰ªÖÂØπÈ´òÁ∫ßÁî®Êà∑ÂºÄÊîæ„ÄÇ\nÂçáÁ∫ßÂêéÂèØ‰∫´ÂèóÊØèÊó•10Ê¨°AI‰øÆÂ§çÊúçÂä°ÔºÅ',
                    'ai'
                );
                return;
            }
            
            const markdownText = document.getElementById('markdownInput').value.trim();
            if (!markdownText) {
                showToast('ÊèêÁ§∫', 'ËØ∑ÂÖàËæìÂÖ•ÈúÄË¶Å‰øÆÂ§çÁöÑMarkdownÂÜÖÂÆπ', 'warning');
                return;
            }
            
            if (!checkAIUsageLimit()) {
                showToast('ÈÖçÈ¢ù‰∏çË∂≥', '‰ªäÊó•AI‰øÆÂ§çÊ¨°Êï∞Â∑≤Áî®ÂÆåÔºåËØ∑ÊòéÂ§©ÂÜçËØï', 'warning');
                return;
            }
            
            await performAIFix(markdownText, { type: 'quick_fix', mode: 'Âø´ÈÄü‰øÆÂ§ç' });
        }
        
        // Ê∑±Â∫¶AI‰ºòÂåñÂäüËÉΩ
        async function performAdvancedAIFix() {
            if (!canUseAIFix()) {
                showUpgradePrompt(
                    'AI‰øÆÂ§çÈúÄË¶ÅÂçáÁ∫ß',
                    'AIÊô∫ËÉΩ‰øÆÂ§çÂäüËÉΩ‰ªÖÂØπÈ´òÁ∫ßÁî®Êà∑ÂºÄÊîæ„ÄÇ\nÂçáÁ∫ßÂêéÂèØ‰∫´ÂèóÊØèÊó•10Ê¨°AI‰øÆÂ§çÊúçÂä°ÔºÅ',
                    'ai'
                );
                return;
            }
            
            const markdownText = document.getElementById('markdownInput').value.trim();
            if (!markdownText) {
                showToast('ÊèêÁ§∫', 'ËØ∑ÂÖàËæìÂÖ•ÈúÄË¶Å‰ºòÂåñÁöÑMarkdownÂÜÖÂÆπ', 'warning');
                return;
            }
            
            if (!checkAIUsageLimit()) {
                showToast('ÈÖçÈ¢ù‰∏çË∂≥', '‰ªäÊó•AI‰øÆÂ§çÊ¨°Êï∞Â∑≤Áî®ÂÆåÔºåËØ∑ÊòéÂ§©ÂÜçËØï', 'warning');
                return;
            }
            
            await performAIFix(markdownText, { type: 'advanced_optimize', mode: 'Ê∑±Â∫¶‰ºòÂåñ' });
        }
        
        // Ê†∏ÂøÉAI‰øÆÂ§çÂäüËÉΩ
        async function performAIFix(content, options = {}) {
            let config;
            
            // Ê†πÊçÆÁî®Êà∑Á∫ßÂà´Ëé∑ÂèñÈÖçÁΩÆ
            if (currentUser.level === 'advanced') {
                // È´òÁ∫ßÁî®Êà∑Ôºö‰ΩøÁî®È¢ÑÈÖçÁΩÆ
                ensurePresetConfig();
                config = PRESET_AI_CONFIG;
            } else {
                // Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÔºö‰ΩøÁî®Ëá™ÂÆö‰πâÈÖçÁΩÆ
                const savedConfig = localStorage.getItem('aiConfig');
                if (!savedConfig) {
                    showToast('ÈÖçÁΩÆÈîôËØØ', 'ËØ∑ÂÖàÈÖçÁΩÆAIÊúçÂä°', 'warning');
                    showAIConfigModal();
                    return;
                }
                
                try {
                    config = JSON.parse(savedConfig);
                } catch (error) {
                    showToast('ÈÖçÁΩÆÈîôËØØ', 'AIÈÖçÁΩÆÊñá‰ª∂ÊçüÂùèÔºåËØ∑ÈáçÊñ∞ÈÖçÁΩÆ', 'error');
                    showAIConfigModal();
                    return;
                }
            }
            
            const aiConfig = AI_CONFIGS[config.provider];
            if (!aiConfig) {
                showToast('ÈÖçÁΩÆÈîôËØØ', '‰∏çÊîØÊåÅÁöÑAIÊúçÂä°ÂïÜ', 'error');
                return;
            }
            
            const systemPrompt = AI_SYSTEM_PROMPTS[options.type] || AI_SYSTEM_PROMPTS.quick_fix;
            const mode = options.mode || '‰øÆÂ§ç';
            
            try {
                // ÊòæÁ§∫‰øÆÂ§çËøõÂ∫¶
                showToast('AI‰øÆÂ§ç‰∏≠', `Ê≠£Âú®‰ΩøÁî®${aiConfig.name}ËøõË°å${mode}...`, 'info', 0);
                
                const response = await fetch(aiConfig.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.apiKey}`
                    },
                    body: JSON.stringify({
                        model: config.model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: content }
                        ],
                        temperature: 0.3,
                        max_tokens: 4000,
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    let errorMessage = `APIË∞ÉÁî®Â§±Ë¥• (${response.status})`;
                    try {
                        const errorData = await response.json();
                        errorMessage += `: ${errorData.error?.message || errorData.message || 'Êú™Áü•ÈîôËØØ'}`;
                    } catch (e) {
                        errorMessage += `: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('AIËøîÂõûÁöÑÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°Æ');
                }
                
                const fixedContent = data.choices[0].message.content.trim();
                
                if (!fixedContent) {
                    throw new Error('AIËøîÂõû‰∫ÜÁ©∫ÁöÑ‰øÆÂ§çÁªìÊûú');
                }
                
                // Êõ¥Êñ∞ËæìÂÖ•Ê°ÜÂÜÖÂÆπ
                const markdownInput = document.getElementById('markdownInput');
                const originalContent = markdownInput.value;
                markdownInput.value = fixedContent;
                
                // Ëß¶ÂèëÈ¢ÑËßàÊõ¥Êñ∞
                debouncedUpdatePreview();
                debouncedUpdateWordCount();
                
                // Â¢ûÂä†‰ΩøÁî®Ê¨°Êï∞
                incrementAIUsage();
                
                // ÊòæÁ§∫ÊàêÂäü‰ø°ÊÅØ
                showToast('‰øÆÂ§çÂÆåÊàê', `AIÂ∑≤ÊàêÂäü${mode}ÊÇ®ÁöÑÊñáÊ°£`, 'success', 3000);
                
                // Êèê‰æõÊí§ÈîÄÂäüËÉΩ
                const undoBtn = document.createElement('button');
                undoBtn.textContent = 'Êí§ÈîÄ‰øÆÂ§ç';
                undoBtn.style.cssText = 'background: var(--warning); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-left: 10px; font-size: 12px;';
                undoBtn.onclick = () => {
                    markdownInput.value = originalContent;
                    debouncedUpdatePreview();
                    debouncedUpdateWordCount();
                    showToast('Â∑≤Êí§ÈîÄ', 'Â∑≤ÊÅ¢Â§çÂà∞‰øÆÂ§çÂâçÁöÑÂÜÖÂÆπ', 'info');
                };
                
                // ÂàõÂª∫Â∏¶ÊúâÊí§ÈîÄÊåâÈíÆÁöÑÊèêÁ§∫
                setTimeout(() => {
                    const lastToast = document.querySelector('.toast:last-child');
                    if (lastToast && lastToast.textContent.includes('‰øÆÂ§çÂÆåÊàê')) {
                        lastToast.appendChild(undoBtn);
                    }
                }, 100);
                
                return fixedContent;
                
            } catch (error) {
                console.error('AI‰øÆÂ§çÂ§±Ë¥•:', error);
                
                let userMessage = 'AI‰øÆÂ§çËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØ';
                if (error.message.includes('401')) {
                    userMessage = 'APIÂØÜÈí•Êó†ÊïàÔºåËØ∑Ê£ÄÊü•ÈÖçÁΩÆ';
                } else if (error.message.includes('403')) {
                    userMessage = 'APIËÆøÈóÆË¢´ÊãíÁªùÔºåËØ∑Ê£ÄÊü•ÊùÉÈôê';
                } else if (error.message.includes('429')) {
                    userMessage = 'APIË∞ÉÁî®È¢ëÁéáËøáÈ´òÔºåËØ∑Á®çÂêéÈáçËØï';
                } else if (error.message.includes('timeout')) {
                    userMessage = 'AIÊúçÂä°ÂìçÂ∫îË∂ÖÊó∂ÔºåËØ∑ÈáçËØï';
                } else if (error.message.includes('ÁΩëÁªú')) {
                    userMessage = 'ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªú';
                } else {
                    userMessage = `‰øÆÂ§çÂ§±Ë¥•: ${error.message}`;
                }
                
                showToast('‰øÆÂ§çÂ§±Ë¥•', userMessage, 'error', 5000);
                
                // Â¶ÇÊûúÊòØÈÖçÁΩÆÈóÆÈ¢òÔºåÂºïÂØºÁî®Êà∑ÈáçÊñ∞ÈÖçÁΩÆ
                if (error.message.includes('401') || error.message.includes('403') || error.message.includes('APIÂØÜÈí•')) {
                    setTimeout(() => {
                        showAIConfigModal();
                    }, 2000);
                }
                
                return null;
            }
        }
        
        // === AI‰øÆÂ§çÁî®Êà∑‰ΩìÈ™å‰ºòÂåñ ===
        
        // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠AIÈÖçÁΩÆÊ®°ÊÄÅÊ°Ü
        document.addEventListener('click', function(e) {
            const aiConfigModal = document.getElementById('aiConfigModal');
            if (e.target === aiConfigModal) {
                closeAIConfigModal();
            }
        });
        
        // ÈîÆÁõòÂø´Êç∑ÈîÆÊîØÊåÅ
        document.addEventListener('keydown', function(e) {
            // EscÈîÆÂÖ≥Èó≠AIÈÖçÁΩÆÊ®°ÊÄÅÊ°Ü
            if (e.key === 'Escape') {
                const aiConfigModal = document.getElementById('aiConfigModal');
                if (aiConfigModal && aiConfigModal.style.display === 'block') {
                    closeAIConfigModal();
                }
            }
            
            // Ctrl+Alt+F Âø´ÈÄüAI‰øÆÂ§ç
            if (e.ctrlKey && e.altKey && e.key === 'f' || e.key === 'F') {
                e.preventDefault();
                if (canUseAIFix()) {
                    performQuickAIFix();
                }
            }
            
            // Ctrl+Alt+O AIÊ∑±Â∫¶‰ºòÂåñ
            if (e.ctrlKey && e.altKey && e.key === 'o' || e.key === 'O') {
                e.preventDefault();
                if (canUseAIFix()) {
                    performAdvancedAIFix();
                }
            }
        });
        
        // APIÈÖçÁΩÆÈ™åËØÅÂäüËÉΩ
        async function validateAIConfig(config) {
            const aiConfig = AI_CONFIGS[config.provider];
            if (!aiConfig) {
                throw new Error('‰∏çÊîØÊåÅÁöÑAIÊúçÂä°ÂïÜ');
            }
            
            if (!config.apiKey || config.apiKey.trim().length < 10) {
                throw new Error('APIÂØÜÈí•Ê†ºÂºè‰∏çÊ≠£Á°Æ');
            }
            
            // ÁÆÄÂçïÁöÑAPIÂØÜÈí•Ê†ºÂºèÈ™åËØÅ
            const keyPatterns = {
                kimi: /^sk-[a-zA-Z0-9]{32,}$/,
                glm: /^[a-f0-9]{32}\.[a-zA-Z0-9]{16}$/,
                baichuan: /^sk-[a-f0-9]{32}$/,
                deepseek: /^sk-[a-f0-9]{32}$/,
                openai: /^sk-[a-zA-Z0-9]{32,}$/
            };
            
            const pattern = keyPatterns[config.provider];
            if (pattern && !pattern.test(config.apiKey)) {
                console.warn(`APIÂØÜÈí•Ê†ºÂºèÂèØËÉΩ‰∏çÊ≠£Á°Æ: ${config.provider}`);
            }
            
            return true;
        }
        
        // ÊµãËØïAIÈÖçÁΩÆËøûÊé•
        async function testAIConnection() {
            const savedConfig = localStorage.getItem('aiConfig');
            if (!savedConfig) {
                showToast('ÈÖçÁΩÆÈîôËØØ', 'ËØ∑ÂÖà‰øùÂ≠òAIÈÖçÁΩÆ', 'warning');
                return;
            }
            
            let config;
            try {
                config = JSON.parse(savedConfig);
                await validateAIConfig(config);
            } catch (error) {
                showToast('ÈÖçÁΩÆÈ™åËØÅÂ§±Ë¥•', error.message, 'error');
                return;
            }
            
            const aiConfig = AI_CONFIGS[config.provider];
            
            try {
                showToast('ËøûÊé•ÊµãËØï', 'Ê≠£Âú®ÊµãËØïAIÊúçÂä°ËøûÊé•...', 'info', 0);
                
                const response = await fetch(aiConfig.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.apiKey}`
                    },
                    body: JSON.stringify({
                        model: config.model,
                        messages: [
                            { role: 'user', content: 'ÊµãËØïËøûÊé•' }
                        ],
                        max_tokens: 10
                    })
                });
                
                if (response.ok) {
                    showToast('ËøûÊé•ÊàêÂäü', `${aiConfig.name} ËøûÊé•Ê≠£Â∏∏`, 'success');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMsg = errorData.error?.message || errorData.message || `HTTP ${response.status}`;
                    showToast('ËøûÊé•Â§±Ë¥•', `${aiConfig.name} ËøûÊé•Â§±Ë¥•: ${errorMsg}`, 'error');
                }
            } catch (error) {
                showToast('ËøûÊé•Â§±Ë¥•', `ÁΩëÁªúÈîôËØØ: ${error.message}`, 'error');
            }
        }
        
        // Â¢ûÂº∫ÁöÑÈîôËØØÂ§ÑÁêÜÂíåÁî®Êà∑ÂºïÂØº
        function showAIHelp() {
            const helpContent = `
                <div style="text-align: left; max-width: 500px;">
                    <h3 style="color: var(--accent-primary); margin-top: 0;">ü§ñ AIÊô∫ËÉΩ‰øÆÂ§çÂ∏ÆÂä©</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <h4>üìã ÂäüËÉΩËØ¥Êòé</h4>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li><strong>Âø´ÈÄü‰øÆÂ§ç</strong>ÔºöËá™Âä®‰øÆÂ§çMarkdownÊ†ºÂºèÈóÆÈ¢ò</li>
                            <li><strong>Ê∑±Â∫¶‰ºòÂåñ</strong>ÔºöAIÈáçÊñ∞ÁªÑÁªáÂíå‰ºòÂåñÊñáÊ°£ÁªìÊûÑ</li>
                            <li><strong>ÈÖçÁΩÆÁÆ°ÁêÜ</strong>ÔºöÊîØÊåÅÂ§ö‰∏™AIÊúçÂä°ÂïÜÂàáÊç¢</li>
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4>üîë APIÂØÜÈí•Ëé∑Âèñ</h4>
                        <ul style="margin: 10px 0; padding-left: 20px; font-size: 14px;">
                            <li><strong>Kimi</strong>: <a href="https://platform.moonshot.cn" target="_blank">platform.moonshot.cn</a></li>
                            <li><strong>Êô∫Ë∞±GLM</strong>: <a href="https://bigmodel.cn" target="_blank">bigmodel.cn</a></li>
                            <li><strong>ÁôæÂ∑ùAI</strong>: <a href="https://platform.baichuan-ai.com" target="_blank">platform.baichuan-ai.com</a></li>
                            <li><strong>DeepSeek</strong>: <a href="https://platform.deepseek.com" target="_blank">platform.deepseek.com</a></li>
                            <li><strong>OpenAI</strong>: ÈúÄË¶Å‰ª£ÁêÜÊúçÂä°</li>
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4>‚å®Ô∏è Âø´Êç∑ÈîÆ</h4>
                        <ul style="margin: 10px 0; padding-left: 20px; font-size: 14px;">
                            <li><strong>Ctrl+Alt+F</strong>: Âø´ÈÄü‰øÆÂ§ç</li>
                            <li><strong>Ctrl+Alt+O</strong>: Ê∑±Â∫¶‰ºòÂåñ</li>
                            <li><strong>Esc</strong>: ÂÖ≥Èó≠ÈÖçÁΩÆÈù¢Êùø</li>
                        </ul>
                    </div>
                    
                    <div style="background: rgba(255, 193, 7, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <h4 style="margin-top: 0;">üí° ‰ΩøÁî®Âª∫ËÆÆ</h4>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 14px;">
                            <li>È¶ñÊ¨°‰ΩøÁî®ËØ∑ÂÖàÈÖçÁΩÆAIÊúçÂä°</li>
                            <li>Âª∫ËÆÆÂÖàÊµãËØïËøûÊé•ÂÜç‰ΩøÁî®</li>
                            <li>APIÂØÜÈí•‰ªÖÂú®Êú¨Âú∞Â≠òÂÇ®Ôºå‰∏ç‰ºö‰∏ä‰º†</li>
                            <li>È´òÁ∫ßÁî®Êà∑ÊØèÊó•10Ê¨°ÔºåË∂ÖÁ∫ßÁÆ°ÁêÜÂëòÊó†ÈôêÂà∂</li>
                        </ul>
                    </div>
                </div>
            `;
            
            showConfirm('AIÊô∫ËÉΩ‰øÆÂ§çÂ∏ÆÂä©', helpContent, 'üí°');
        }
        
        // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.addEventListener('DOMContentLoaded', function() {
            // ÂØÜÁ†ÅÊòæÁ§∫/ÈöêËóèÂàáÊç¢
            const passwordToggle = document.getElementById('passwordToggle');
            if (passwordToggle) {
                passwordToggle.addEventListener('click', togglePasswordVisibility);
            }
            
            // ÊîØÊåÅÂõûËΩ¶ÈîÆÊèê‰∫§ÂØÜÁ†Å
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        verifyPassword();
                    }
                });
            }
        });
        
        // ÂàùÂßãÂåñÂ∫îÁî®ÔºàÂéüÊù•ÁöÑÂàùÂßãÂåñÈÄªËæëÔºâ
        function initializeApp() {
            // Ê∏ÖÈô§ÂèØËÉΩÂØºËá¥ÂºπÁ™óÁöÑËá™Âä®‰øùÂ≠òÊï∞ÊçÆ
            localStorage.removeItem('markdown-auto-save');
            localStorage.removeItem('markdown-auto-save-timestamp');
            
            // Êõ¥Êñ∞Áî®Êà∑Áä∂ÊÄÅÊòæÁ§∫
            updateUserStatus();
            
            // ÂàùÂßãÂåñAI‰øÆÂ§çÂäüËÉΩÁªÑÊòæÁ§∫
            initializeAIFixFeatures();
            
            // Á≠âÂæÖDOMÂÆåÂÖ®ÂèØËßÅÂêéÂàùÂßãÂåñ‰∫ã‰ª∂ÁªëÂÆö
            setTimeout(() => {
                initializeEventBindings();
            }, 100);
            
            // ÂàùÂßãÂåñÊãñÊãΩÂäüËÉΩ
            initializeDragAndDrop();
            
            // Áõ¥Êé•Âä†ËΩΩÁ§∫‰æãÔºå‰∏çÊ£ÄÊü•Ëá™Âä®‰øùÂ≠òÂÜÖÂÆπÈÅøÂÖçÂºπÁ™ó
            loadExample();
        }
        
        // ÂàùÂßãÂåñAI‰øÆÂ§çÂäüËÉΩ
        function initializeAIFixFeatures() {
            const aiFixGroup = document.getElementById('aiFixGroup');
            if (!aiFixGroup) return;
            
            // Ê†πÊçÆÁî®Êà∑ÊùÉÈôêÊòæÁ§∫ÊàñÈöêËóèAI‰øÆÂ§çÂäüËÉΩÁªÑ
            if (canUseAIFix()) {
                aiFixGroup.style.display = 'block';
                // Êõ¥Êñ∞‰ΩøÁî®Ê¨°Êï∞ÊòæÁ§∫
                updateAIUsageDisplay();
                // Ê†πÊçÆÁî®Êà∑Á∫ßÂà´ËÆæÁΩÆÊåâÈíÆÊñáÊú¨
                updateAIConfigButtonText();
            } else {
                aiFixGroup.style.display = 'none';
            }
        }
        
        // Ê†πÊçÆÁî®Êà∑Á∫ßÂà´Êõ¥Êñ∞AIÈÖçÁΩÆÊåâÈíÆÊñáÊú¨
        function updateAIConfigButtonText() {
            const aiConfigBtn = document.getElementById('aiConfigBtn');
            if (!aiConfigBtn || !currentUser) return;
            
            if (currentUser.level === 'super_admin') {
                aiConfigBtn.innerHTML = '‚öôÔ∏è AIÈÖçÁΩÆ';
                aiConfigBtn.setAttribute('aria-label', 'AI‰øÆÂ§çÈÖçÁΩÆ');
            } else {
                aiConfigBtn.innerHTML = '‚öôÔ∏è AIËÆæÁΩÆ';
                aiConfigBtn.setAttribute('aria-label', 'AI‰øÆÂ§çËÆæÁΩÆ');
            }
        }
        
        // ÂàùÂßãÂåñ‰∫ã‰ª∂ÁªëÂÆö - Á°Æ‰øùÂú®‰∏ªÁïåÈù¢ÊòæÁ§∫ÂêéÊâßË°å
        function initializeEventBindings() {
            try {
                // Ëé∑ÂèñDOMÂÖÉÁ¥†ÔºàÂú®‰∏ªÁïåÈù¢ÊòæÁ§∫ÂêéÈáçÊñ∞Ëé∑ÂèñÔºâ
                const markdownInput = document.getElementById('markdownInput');
                const preview = document.getElementById('preview');
                
                // È™åËØÅÂÖÉÁ¥†Â≠òÂú®‰∏îÂèØËßÅ
                if (!markdownInput || !preview) {
                    console.warn('ÂÖ≥ÈîÆDOMÂÖÉÁ¥†Êú™ÊâæÂà∞ÔºåÂª∂ËøüÈáçËØï...');
                    setTimeout(initializeEventBindings, 200);
                    return;
                }
                
                // Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶ÁúüÊ≠£ÂèØËßÅ
                const isVisible = markdownInput.offsetParent !== null && 
                                 markdownInput.style.display !== 'none' &&
                                 getComputedStyle(markdownInput).visibility !== 'hidden';
                
                if (!isVisible) {
                    console.warn('DOMÂÖÉÁ¥†Â∞öÊú™ÂÆåÂÖ®ÂèØËßÅÔºåÂª∂ËøüÈáçËØï...');
                    setTimeout(initializeEventBindings, 200);
                    return;
                }
                
                // ÁßªÈô§ÂèØËÉΩÁöÑÈáçÂ§çÁõëÂê¨Âô®ÔºàÈò≤Ê≠¢ÈáçÂ§çÁªëÂÆöÔºâ
                markdownInput.removeEventListener('input', handleInputChange);
                
                // ÁªëÂÆöÂÆûÊó∂È¢ÑËßà‰∫ã‰ª∂
                markdownInput.addEventListener('input', handleInputChange);
                
                console.log('‚úÖ ÂÆûÊó∂È¢ÑËßà‰∫ã‰ª∂ÁªëÂÆöÊàêÂäü');
                
                // Ëß¶Âèë‰∏ÄÊ¨°ÂàùÂßãÈ¢ÑËßàÊõ¥Êñ∞
                if (markdownInput.value.trim()) {
                    debouncedUpdatePreview();
                }
                
            } catch (error) {
                console.error('‰∫ã‰ª∂ÁªëÂÆöÂ§±Ë¥•:', error);
                // Â§±Ë¥•ÈáçËØïÊú∫Âà∂
                setTimeout(initializeEventBindings, 500);
            }
        }
        
        // ËæìÂÖ•ÂèòÂåñÂ§ÑÁêÜÂáΩÊï∞
        function handleInputChange() {
            try {
                debouncedUpdateWordCount(); // Â≠óÊï∞ÁªüËÆ°‰ΩøÁî®Èò≤Êäñ
                debouncedUpdatePreview();   // È¢ÑËßàÊõ¥Êñ∞‰ΩøÁî®Âä®ÊÄÅÈò≤Êäñ
                
                // Ë∞ÉËØï‰ø°ÊÅØÔºà‰ªÖÂú®ÂºÄÂèëÊ®°Âºè‰∏ãÊòæÁ§∫Ôºâ
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    console.log('üìù ÂÆûÊó∂È¢ÑËßàËß¶Âèë');
                }
            } catch (error) {
                console.error('ÂÆûÊó∂È¢ÑËßàÂ§ÑÁêÜÂ§±Ë¥•:', error);
                // Â∞ùËØïÈáçÊñ∞ÂàùÂßãÂåñ‰∫ã‰ª∂ÁªëÂÆö
                setTimeout(initializeEventBindings, 1000);
            }
        }
        
        // Ê£ÄÊü•ÂÆûÊó∂È¢ÑËßàÁä∂ÊÄÅÁöÑË∞ÉËØïÂáΩÊï∞
        function checkPreviewStatus() {
            const markdownInput = document.getElementById('markdownInput');
            const preview = document.getElementById('preview');
            
            const status = {
                markdownInputExists: !!markdownInput,
                previewExists: !!preview,
                markdownInputVisible: markdownInput ? markdownInput.offsetParent !== null : false,
                previewVisible: preview ? preview.offsetParent !== null : false,
                hasEventListeners: markdownInput ? getEventListeners(markdownInput).input?.length > 0 : false,
                currentValue: markdownInput ? markdownInput.value.length : 0
            };
            
            console.table(status);
            return status;
        }
        
        // ÂÖ®Â±ÄÊö¥Èú≤Ë∞ÉËØïÂáΩÊï∞Ôºà‰ªÖÂú®ÂºÄÂèëÁéØÂ¢ÉÔºâ
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            window.checkPreviewStatus = checkPreviewStatus;
            window.reinitializePreview = initializeEventBindings;
        }
        
        // ÈÖçÁΩÆmarkedÈÄâÈ°π
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        // DOMÂÖÉÁ¥†ÂºïÁî® - ÁßªÂä®Âà∞ÂáΩÊï∞‰∏≠ÊåâÈúÄËé∑ÂèñÔºåÈÅøÂÖçËøáÊó©ÂºïÁî®

        // Êï∞Â≠¶ÂÖ¨ÂºèÁºìÂ≠òÁ≥ªÁªü
        const mathCache = new Map();
        let lastMathHash = '';

        // ËÆ°ÁÆóÂÜÖÂÆπÂìàÂ∏åÔºàÁÆÄÂçïÂÆûÁé∞Ôºâ
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return hash.toString();
        }

        // ÊèêÂèñÊï∞Â≠¶ÂÖ¨Âºè
        function extractMathFormulas(text) {
            const formulas = [];
            const patterns = [
                /\$\$([^$]+)\$\$/g,     // Display math $$...$$
                /\$([^$\n]+)\$/g,       // Inline math $...$
                /\\\(([^)]+)\\\)/g,     // Inline math \(...\)
                /\\\[([^\]]+)\\\]/g     // Display math \[...\]
            ];
            
            patterns.forEach((pattern, index) => {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    formulas.push({
                        formula: match[0],
                        content: match[1],
                        display: index % 2 === 0,
                        hash: simpleHash(match[0])
                    });
                }
            });
            
            return formulas;
        }

        // ‰ºòÂåñÁöÑÊï∞Â≠¶ÂÖ¨ÂºèÊ∏≤ÊüìÂáΩÊï∞
        function renderMath(element) {
            if (!window.renderMathInElement) {
                return;
            }
            
            const mathIndicator = document.getElementById('mathIndicator');
            const markdownText = document.getElementById('markdownInput').value;
            
            // Âø´ÈÄüÊ£ÄÊü•ÊòØÂê¶ÂåÖÂê´Êï∞Â≠¶ÂÖ¨Âºè
            const hasMath = /\$.*?\$|\\\(.*?\\\)|\\\[.*?\\\]|\$\$.*?\$\$/s.test(markdownText);
            if (!hasMath) {
                if (mathIndicator) {
                    mathIndicator.classList.remove('show');
                }
                return;
            }

            // ËÆ°ÁÆóÂΩìÂâçÂÜÖÂÆπÁöÑÊï∞Â≠¶ÂÖ¨ÂºèÂìàÂ∏å
            const mathFormulas = extractMathFormulas(markdownText);
            const currentMathHash = simpleHash(mathFormulas.map(f => f.formula).join(''));
            
            // Â¶ÇÊûúÊï∞Â≠¶ÂÖ¨ÂºèÊ≤°ÊúâÂèòÂåñÔºåË∑≥ËøáÊ∏≤Êüì
            if (currentMathHash === lastMathHash) {
                return;
            }
            
            lastMathHash = currentMathHash;
            
            // ÊòæÁ§∫Ê∏≤ÊüìÊåáÁ§∫Âô®
            if (mathIndicator) {
                mathIndicator.classList.add('show');
            }
            
            // ‰ΩøÁî®RequestAnimationFrame‰ºòÂåñÊ∏≤ÊüìÊó∂Êú∫
            requestAnimationFrame(() => {
                try {
                    // ÂàõÂª∫DocumentFragmentËøõË°åÊâπÈáèDOMÊìç‰Ωú
                    const fragment = document.createDocumentFragment();
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = element.innerHTML;
                    fragment.appendChild(tempDiv);
                    
                    renderMathInElement(tempDiv, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false},
                            {left: '\\[', right: '\\]', display: true}
                        ],
                        throwOnError: false,
                        errorCallback: function(msg, err) {
                            console.warn('Êï∞Â≠¶ÂÖ¨ÂºèÊ∏≤ÊüìË≠¶Âëä:', msg, err);
                        }
                    });
                    
                    // ÊâπÈáèÊõ¥Êñ∞DOM
                    element.innerHTML = tempDiv.innerHTML;
                    
                    // Ê∏≤ÊüìÂÆåÊàêÂêéÈöêËóèÊåáÁ§∫Âô®
                    setTimeout(() => {
                        if (mathIndicator) {
                            mathIndicator.classList.remove('show');
                        }
                    }, 200);
                    
                } catch (error) {
                    console.error('Êï∞Â≠¶ÂÖ¨ÂºèÊ∏≤ÊüìÂ§±Ë¥•:', error);
                    if (mathIndicator) {
                        mathIndicator.classList.remove('show');
                    }
                    showToast('ÂÖ¨ÂºèÊ∏≤ÊüìÂ§±Ë¥•', 'ÈÉ®ÂàÜÊï∞Â≠¶ÂÖ¨ÂºèÂèØËÉΩÊó†Ê≥ïÊ≠£Á°ÆÊòæÁ§∫', 'warning', 2000);
                }
            });
        }

        // ËäÇÊµÅÁöÑÊï∞Â≠¶ÂÖ¨ÂºèÊ∏≤ÊüìÔºà1000msÈôêÂà∂Ôºâ
        const throttledRenderMath = throttle(renderMath, 1000);

        // ToastÈÄöÁü•Á≥ªÁªü
        function showToast(title, message, type = 'success', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    ${message ? `<div class="toast-message">${message}</div>` : ''}
                </div>
            `;
            
            container.appendChild(toast);
            
            // ÊòæÁ§∫Âä®Áîª
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Ëá™Âä®ÁßªÈô§
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        // Ëá™ÂÆö‰πâÁ°ÆËÆ§ÂØπËØùÊ°Ü
        function showConfirm(title, message, icon = '‚ùì') {
            return new Promise((resolve) => {
                const dialog = document.getElementById('customDialog');
                const dialogIcon = document.getElementById('dialogIcon');
                const dialogTitle = document.getElementById('dialogTitle');
                const dialogMessage = document.getElementById('dialogMessage');
                const confirmBtn = document.getElementById('dialogConfirm');
                const cancelBtn = document.getElementById('dialogCancel');
                
                dialogIcon.textContent = icon;
                dialogTitle.textContent = title;
                dialogMessage.innerHTML = message;
                
                dialog.classList.add('show');
                
                const handleConfirm = () => {
                    cleanup();
                    resolve(true);
                };
                
                const handleCancel = () => {
                    cleanup();
                    resolve(false);
                };
                
                const cleanup = () => {
                    dialog.classList.remove('show');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                };
                
                confirmBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);
                
                // ESCÈîÆÂèñÊ∂à
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        handleCancel();
                        document.removeEventListener('keydown', handleEsc);
                    }
                };
                document.addEventListener('keydown', handleEsc);
            });
        }

        // ÊòæÁ§∫Áä∂ÊÄÅÊ∂àÊÅØÔºà‰øùÁïôÂêëÂêéÂÖºÂÆπÔºâ
        function showStatus(message, type = 'success') {
            showToast('ÊèêÁ§∫', message, type);
        }

        // Êõ¥Êñ∞Â≠óÊï∞ÁªüËÆ°
        function updateWordCount() {
            const text = markdownInput.value;
            const charCount = text.length;
            const wordCount_val = text.trim() ? text.trim().split(/\s+/).length : 0;
            const lineCount = text.split('\n').length;
            
            // ‰º∞ÁÆóÈòÖËØªÊó∂Èó¥ÔºàÂÅáËÆæÊØèÂàÜÈíü200‰∏™ÂçïËØçÔºâ
            const readTime = Math.ceil(wordCount_val / 200);
            
            // Êõ¥Êñ∞ÂêÑ‰∏™ÁªüËÆ°È°π
            document.getElementById('charCount').textContent = charCount.toLocaleString();
            document.getElementById('wordCount').textContent = wordCount_val.toLocaleString();
            document.getElementById('lineCount').textContent = lineCount.toLocaleString();
            document.getElementById('readTime').textContent = readTime || '<1';
        }

        // Â¢ûÂº∫Èò≤ÊäñÂáΩÊï∞ - ÊîØÊåÅÂä®ÊÄÅÂª∂Ëøü
        function debounce(func, wait, dynamicWaitFunc = null) {
            let timeout;
            return function executedFunction(...args) {
                const actualWait = dynamicWaitFunc ? dynamicWaitFunc() : wait;
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, actualWait);
            };
        }

        // ËäÇÊµÅÂáΩÊï∞ - ÈôêÂà∂ÂáΩÊï∞ÊâßË°åÈ¢ëÁéá
        function throttle(func, limit) {
            let inThrottle;
            return function executedFunction(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // ÈïøÊñáÊ°£ÊÄßËÉΩ‰ºòÂåñÈÖçÁΩÆ
        const PERFORMANCE_CONFIG = {
            CHUNK_SIZE: 2000,           // ÊØè‰∏™ÂàÜÁâáÁöÑÂ≠óÁ¨¶Êï∞
            LARGE_DOC_THRESHOLD: 5000,  // ÈïøÊñáÊ°£ÈòàÂÄº
            HUGE_DOC_THRESHOLD: 15000,  // Ë∂ÖÈïøÊñáÊ°£ÈòàÂÄº
            MAX_PARSE_TIME: 100         // ÊúÄÂ§ßËß£ÊûêÊó∂Èó¥(ms)
        };

        // ÂÜÖÂÆπÂ∑ÆÂºÇÊ£ÄÊµã
        let lastContentHash = '';
        
        function getContentHash(content) {
            return simpleHash(content);
        }

        // ÂàÜÁâáËß£ÊûêÂáΩÊï∞
        function parseMarkdownInChunks(markdownText, onProgress = null) {
            return new Promise((resolve) => {
                const chunks = [];
                const chunkSize = PERFORMANCE_CONFIG.CHUNK_SIZE;
                
                // ÊåâË°åÂàÜÂâ≤Ôºå‰øùÊåÅÂÜÖÂÆπÂÆåÊï¥ÊÄß
                const lines = markdownText.split('\n');
                let currentChunk = '';
                let currentSize = 0;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i] + '\n';
                    
                    if (currentSize + line.length > chunkSize && currentChunk.trim()) {
                        chunks.push(currentChunk);
                        currentChunk = line;
                        currentSize = line.length;
                    } else {
                        currentChunk += line;
                        currentSize += line.length;
                    }
                }
                
                if (currentChunk.trim()) {
                    chunks.push(currentChunk);
                }
                
                // ÈÄêÊ≠•Ëß£ÊûêÂàÜÁâá
                let processedChunks = [];
                let currentIndex = 0;
                
                function processNextChunk() {
                    if (currentIndex >= chunks.length) {
                        resolve(processedChunks.join(''));
                        return;
                    }
                    
                    const chunk = chunks[currentIndex];
                    const startTime = performance.now();
                    
                    try {
                        const html = marked.parse(chunk);
                        processedChunks.push(html);
                        
                        if (onProgress) {
                            onProgress({
                                current: currentIndex + 1,
                                total: chunks.length,
                                percentage: Math.round(((currentIndex + 1) / chunks.length) * 100)
                            });
                        }
                        
                        currentIndex++;
                        
                        // Ê£ÄÊü•Ëß£ÊûêÊó∂Èó¥ÔºåÂ¶ÇÊûúÂ§™ÈïøÂàôÂª∂Ëøü‰∏ã‰∏Ä‰∏™ÂàÜÁâá
                        const parseTime = performance.now() - startTime;
                        if (parseTime > PERFORMANCE_CONFIG.MAX_PARSE_TIME) {
                            setTimeout(processNextChunk, 10);
                        } else {
                            processNextChunk();
                        }
                        
                    } catch (error) {
                        processedChunks.push(`<div class="parse-error">ÂàÜÁâáËß£ÊûêÈîôËØØ: ${error.message}</div>`);
                        currentIndex++;
                        setTimeout(processNextChunk, 5);
                    }
                }
                
                processNextChunk();
            });
        }

        // ÊòæÁ§∫Ëß£ÊûêËøõÂ∫¶
        function showParseProgress(show = true) {
            const indicator = document.getElementById('parseIndicator');
            if (indicator) {
                if (show) {
                    indicator.classList.add('show');
                } else {
                    indicator.classList.remove('show');
                }
            }
        }

        // Êõ¥Êñ∞Ëß£ÊûêËøõÂ∫¶
        function updateParseProgress(progress) {
            const progressBar = document.querySelector('#parseIndicator .progress-bar-fill');
            const progressText = document.querySelector('#parseIndicator .progress-text');
            
            if (progressBar) {
                progressBar.style.width = `${progress.percentage}%`;
            }
            
            if (progressText) {
                progressText.textContent = `Ëß£Êûê‰∏≠... ${progress.current}/${progress.total} (${progress.percentage}%)`;
            }
        }

        // ‰ºòÂåñÁöÑÈ¢ÑËßàÊõ¥Êñ∞ÂáΩÊï∞
        function updatePreview() {
            const markdownText = markdownInput.value;
            
            if (markdownText.trim() === '') {
                preview.innerHTML = `
                    <div class="preview-empty">
                        <div class="preview-empty-icon">üìù</div>
                        <div class="preview-empty-title">ÂºÄÂßãÂàõ‰ΩúÊÇ®ÁöÑÊñáÊ°£</div>
                        <div class="preview-empty-subtitle">
                            Âú®Â∑¶‰æßËæìÂÖ•Ê°Ü‰∏≠ËæìÂÖ•MarkdownÂÜÖÂÆπ<br>
                            ÊàñËÄÖ‰ΩøÁî®‰∏ãÊñπÁöÑÂø´ÈÄüÊìç‰Ωú
                        </div>
                        <div class="preview-quick-actions" role="group" aria-label="Âø´ÈÄüÊìç‰Ωú">
                            <button class="quick-action-btn" onclick="loadExample('simple')" aria-label="Âä†ËΩΩÁÆÄÂçïÁ§∫‰æã">üìÑ ÁÆÄÂçïÁ§∫‰æã</button>
                            <button class="quick-action-btn" onclick="loadExample('advanced')" aria-label="Âä†ËΩΩÈ´òÁ∫ßÁ§∫‰æã">üöÄ È´òÁ∫ßÁ§∫‰æã</button>
                            <button class="quick-action-btn" onclick="uploadFile()" aria-label="‰∏ä‰º†MarkdownÊñá‰ª∂">üìÅ ‰∏ä‰º†Êñá‰ª∂</button>
                            <button class="quick-action-btn" onclick="loadFromLocal()" aria-label="Âä†ËΩΩÊú¨Âú∞ËçâÁ®ø">üìÇ Âä†ËΩΩËçâÁ®ø</button>
                        </div>
                    </div>
                `;
                lastContentHash = '';
                return;
            }

            // ÂÜÖÂÆπÂ∑ÆÂºÇÊ£ÄÊµã
            const currentHash = getContentHash(markdownText);
            if (currentHash === lastContentHash) {
                return; // ÂÜÖÂÆπÊ≤°ÊúâÂèòÂåñÔºåË∑≥ËøáÊõ¥Êñ∞
            }
            lastContentHash = currentHash;
            
            
            const textLength = markdownText.length;
            
            try {
                // ÈïøÊñáÊ°£‰ΩøÁî®ÂàÜÁâáËß£Êûê
                if (textLength > PERFORMANCE_CONFIG.LARGE_DOC_THRESHOLD) {
                    
                    // Ë∂ÖÈïøÊñáÊ°£Ë≠¶Âëä
                    if (textLength > PERFORMANCE_CONFIG.HUGE_DOC_THRESHOLD) {
                        showToast('ÊÄßËÉΩÊèêÁ§∫', 'ÊñáÊ°£ËæÉÈïøÔºåËß£ÊûêÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊó∂Èó¥', 'info', 3000);
                    }
                    
                    showParseProgress(true);
                    
                    parseMarkdownInChunks(markdownText, updateParseProgress)
                        .then(html => {
                            preview.innerHTML = html;
                            throttledRenderMath(preview);
                            showParseProgress(false);
                        })
                        .catch(error => {
                            console.error('ÂàÜÁâáËß£ÊûêÂ§±Ë¥•:', error);
                            showParseProgress(false);
                            // ÈôçÁ∫ßÂà∞Ê†áÂáÜËß£Êûê
                            const html = marked.parse(markdownText);
                            preview.innerHTML = html;
                            throttledRenderMath(preview);
                        });
                    
                } else {
                    // Áü≠ÊñáÊ°£Áõ¥Êé•Ëß£Êûê
                    const html = marked.parse(markdownText);
                    preview.innerHTML = html;
                    throttledRenderMath(preview);
                }
                
            } catch (error) {
                preview.innerHTML = `
                    <div style="color: var(--warning); padding: 20px; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <div><strong>Ëß£ÊûêÈîôËØØ</strong></div>
                        <div style="font-size: 14px; margin-top: 8px; opacity: 0.8;">${error.message}</div>
                    </div>
                `;
                showParseProgress(false);
            }
        }

        // Âä®ÊÄÅËÆ°ÁÆóÈò≤ÊäñÂª∂Ëøü - Ê†πÊçÆÊñáÊ°£ÈïøÂ∫¶Ë∞ÉÊï¥
        function calculateDebounceDelay() {
            const textLength = markdownInput.value.length;
            if (textLength < 1000) return 300;        // Áü≠ÊñáÊ°£: 300ms
            if (textLength < 5000) return 500;        // ‰∏≠Á≠âÊñáÊ°£: 500ms
            if (textLength < 10000) return 800;       // ÈïøÊñáÊ°£: 800ms
            return 1200;                              // Ë∂ÖÈïøÊñáÊ°£: 1200ms
        }

        // Èò≤ÊäñÁöÑÈ¢ÑËßàÊõ¥Êñ∞ÔºàÂä®ÊÄÅÂª∂ËøüÔºâ
        const debouncedUpdatePreview = debounce(updatePreview, 300, calculateDebounceDelay);

        // Èò≤ÊäñÁöÑÂ≠óÊï∞ÁªüËÆ°Êõ¥Êñ∞Ôºà100msÂª∂ËøüÔºâ
        const debouncedUpdateWordCount = debounce(updateWordCount, 100);

        // ÂÆûÊó∂È¢ÑËßàÂäüËÉΩÂàùÂßãÂåñ - ÁßªÂä®Âà∞initializeApp‰∏≠ËøõË°åÁªëÂÆö

        // Á§∫‰æãÂÜÖÂÆπÂ∫ì
        const examples = {
            simple: {
                title: 'ÁÆÄÂçïÁ§∫‰æã',
                content: `# ÊàëÁöÑÁ¨¨‰∏Ä‰∏™ÊñáÊ°£

Ê¨¢Ëøé‰ΩøÁî® **MarkdownËΩ¨Word** ËΩ¨Êç¢Âô®ÔºÅ

## Âü∫Á°ÄÊ†ºÂºè

### ÊñáÊú¨Ê†∑Âºè
- **Á≤ó‰ΩìÊñáÊú¨**
- *Êñú‰ΩìÊñáÊú¨*  
- ~~Âà†Èô§Á∫ø~~
- \`Ë°åÂÜÖ‰ª£Á†Å\`

### ÂàóË°®
1. ÊúâÂ∫èÂàóË°®È°π‰∏Ä
2. ÊúâÂ∫èÂàóË°®È°π‰∫å
   - ÂµåÂ•óÊó†Â∫èÂàóË°®
   - Âè¶‰∏Ä‰∏™È°πÁõÆ

### ÂºïÁî®
> ËøôÊòØ‰∏Ä‰∏™ÁÆÄÂçïÁöÑÂºïÁî®Âùó„ÄÇ
> ÈùûÂ∏∏ÈÄÇÂêàÂº∫Ë∞ÉÈáçË¶ÅÂÜÖÂÆπ„ÄÇ

---
*ÊñáÊ°£ÂàõÂª∫‰∫é ${new Date().toLocaleDateString()}*`
            },
            
            advanced: {
                title: 'È´òÁ∫ßÁ§∫‰æã',
                content: `# üìù È´òÁ∫ßÊñáÊ°£Á§∫‰æã

## üöÄ ÂäüËÉΩÁâπËâ≤

Ëøô‰∏™ËΩ¨Êç¢Âô®ÊîØÊåÅ‰∏∞ÂØåÁöÑMarkdownËØ≠Ê≥ïÔºö

### ‰ª£Á†ÅÂùó
\`\`\`javascript
// ÂáΩÊï∞ÂÆö‰πâ
function convertMarkdown() {
    console.log("Ê≠£Âú®ËΩ¨Êç¢Markdown...");
    return "ËΩ¨Êç¢ÂÆåÊàêÔºÅ";
}

// Ë∞ÉÁî®ÂáΩÊï∞
convertMarkdown();
\`\`\`

### ‰ªªÂä°ÂàóË°®
- [x] ÊîØÊåÅÂü∫Á°ÄMarkdownËØ≠Ê≥ï
- [x] ÊîØÊåÅÊï∞Â≠¶ÂÖ¨ÂºèÊ∏≤Êüì
- [ ] Ê∑ªÂä†Êõ¥Â§öÂØºÂá∫Ê†ºÂºè
- [ ] ÊîØÊåÅÂõæÁâáÊèíÂÖ•

### ÈìæÊé•ÂíåÂõæÁâá
ËÆøÈóÆ [MarkdownÂÆòÊñπÊñáÊ°£](https://daringfireball.net/projects/markdown/) ‰∫ÜËß£Êõ¥Â§öËØ≠Ê≥ï„ÄÇ

### Ê∞¥Âπ≥ÂàÜÂâ≤Á∫ø
---

### Ë°®Ê†ºÂ¢ûÂº∫
| ÂäüËÉΩ | Áä∂ÊÄÅ | ‰ºòÂÖàÁ∫ß | Â§áÊ≥® |
|------|------|--------|------|
| Âü∫Á°ÄËΩ¨Êç¢ | ‚úÖ ÂÆåÊàê | È´ò | Ê†∏ÂøÉÂäüËÉΩ |
| Ê†∑Âºè‰ºòÂåñ | üîÑ ËøõË°å‰∏≠ | ‰∏≠ | ÊåÅÁª≠ÊîπËøõ |
| Êèí‰ª∂ÊîØÊåÅ | üìÖ ËÆ°Âàí‰∏≠ | ‰Ωé | Êú™Êù•ÁâàÊú¨ |

> üí° **ÊèêÁ§∫**: Ëøô‰∏™ËΩ¨Êç¢Âô®‰ºö‰øùÊåÅÂéüÊúâÁöÑÊ†ºÂºèÂíåÊ†∑ÂºèÔºÅ`
            },
            
            math: {
                title: 'Êï∞Â≠¶ÂÖ¨ÂºèÁ§∫‰æã',
                content: `# üìê Êï∞Â≠¶ÂÖ¨ÂºèÁ§∫‰æã

## Ë°åÂÜÖÂÖ¨Âºè
Ë¥®Èáè-ËÉΩÈáèÁ≠â‰ª∑ÊÄßÔºö$E = mc^2$

ÂúÜÁöÑÈù¢ÁßØÂÖ¨ÂºèÔºö$A = \\\\pi r^2$

## ÂùóÁ∫ßÂÖ¨Âºè

### ÁßØÂàÜ
$$\\\\int_{-\\\\infty}^{\\\\infty} e^{-x^2} dx = \\\\sqrt{\\\\pi}$$

### Áü©Èòµ
$$\\\\begin{pmatrix} a & b \\\\\\\\ c & d \\\\end{pmatrix}$$

### Ê±ÇÂíå
$$\\\\sum_{i=1}^{n} i = \\\\frac{n(n+1)}{2}$$

### ‰∫åÊ¨°ÊñπÁ®ãËß£
$$x = \\\\frac{-b \\\\pm \\\\sqrt{b^2 - 4ac}}{2a}$$

### ÊûÅÈôê
$$\\\\lim_{x \\\\to \\\\infty} \\\\frac{1}{x} = 0$$

> Ê≥®ÊÑèÔºöÊï∞Â≠¶ÂÖ¨Âºè‰ΩøÁî®KaTeXÊ∏≤ÊüìÔºåÊîØÊåÅÂ§ßÈÉ®ÂàÜLaTeXËØ≠Ê≥ï„ÄÇ`
            },
            
            table: {
                title: 'Ë°®Ê†ºÁ§∫‰æã',
                content: `# üìä Ë°®Ê†ºÂäüËÉΩÂ±ïÁ§∫

## Âü∫Á°ÄË°®Ê†º
| ‰∫ßÂìÅ | ‰ª∑Ê†º | Êï∞Èáè |
|------|------|------|
| ËãπÊûú | ¬•5 | 10‰∏™ |
| È¶ôËïâ | ¬•3 | 20‰∏™ |
| Ê©ôÂ≠ê | ¬•4 | 15‰∏™ |

## ÂØπÈΩêË°®Ê†º
| Â∑¶ÂØπÈΩê | Â±Ö‰∏≠ÂØπÈΩê | Âè≥ÂØπÈΩê |
|:-------|:-------:|-------:|
| ÊñáÊú¨ | Êï∞Â≠ó | ‰ª∑Ê†º |
| Apple | 100 | $50.00 |
| Banana | 200 | $30.00 |

## Â§çÊùÇË°®Ê†º
| ÂäüËÉΩÊ®°Âùó | ÂºÄÂèëÁä∂ÊÄÅ | ÂÆåÊàêÂ∫¶ | Ë¥üË¥£‰∫∫ | È¢ÑËÆ°Êó∂Èó¥ |
|----------|----------|--------|--------|----------|
| Áî®Êà∑ËÆ§ËØÅ | ‚úÖ Â∑≤ÂÆåÊàê | 100% | Âº†‰∏â | 2024-01 |
| Êñá‰ª∂‰∏ä‰º† | üîÑ ÂºÄÂèë‰∏≠ | 80% | ÊùéÂõõ | 2024-02 |
| Êï∞ÊçÆÂàÜÊûê | üìã ÂæÖÂºÄÂßã | 0% | Áéã‰∫î | 2024-03 |
| Á≥ªÁªü‰ºòÂåñ | üîÑ ÊµãËØï‰∏≠ | 90% | ËµµÂÖ≠ | 2024-01 |

## Êï∞ÊçÆÁªüËÆ°Ë°®
| Êúà‰ªΩ | Áî®Êà∑Êï∞ | Â¢ûÈïøÁéá | Êî∂ÂÖ• |
|------|--------|--------|------|
| 1Êúà | 1,000 | - | ¬•10,000 |
| 2Êúà | 1,200 | +20% | ¬•12,000 |
| 3Êúà | 1,500 | +25% | ¬•15,000 |
| **ÊÄªËÆ°** | **3,700** | **+50%** | **¬•37,000** |`
            }
        };

        // Âä†ËΩΩÁ§∫‰æãÂÜÖÂÆπ
        function loadExample(type = 'simple') {
            const example = examples[type];
            if (!example) {
                showToast('ÈîôËØØ', 'Á§∫‰æãÁ±ªÂûã‰∏çÂ≠òÂú®', 'error');
                return;
            }
            
            // ËÆæÁΩÆÁ§∫‰æãÂä†ËΩΩÊ†áÂøóÔºåÈÅøÂÖçËÆ°ÂÖ•ÈÖçÈ¢ù
            isLoadingExample = true;
            
            markdownInput.value = example.content;
            updateWordCount();
            updatePreview();
            showToast('Âä†ËΩΩÂÆåÊàê', `${example.title}Â∑≤Âä†ËΩΩ`);
            
            // Á°Æ‰øùÊï∞Â≠¶ÂÖ¨ÂºèÊ∏≤Êüì
            if (type === 'math') {
                setTimeout(() => renderMath(preview), 200);
            }
            
            // Á§∫‰æãÂä†ËΩΩÂÆåÊàêÂêéÈáçÁΩÆÊ†áÂøó
            setTimeout(() => {
                isLoadingExample = false;
            }, 100);
        }

        // Ê∏ÖÁ©∫ÂÜÖÂÆπ
        async function clearContent() {
            if (markdownInput.value.trim()) {
                const confirmed = await showConfirm(
                    'Ê∏ÖÁ©∫ÂÜÖÂÆπ',
                    'Á°ÆËÆ§Ê∏ÖÁ©∫ÊâÄÊúâÂÜÖÂÆπÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ',
                    'üóëÔ∏è'
                );
                if (!confirmed) return;
            }
            
            // ËÆæÁΩÆÁ§∫‰æãÂä†ËΩΩÊ†áÂøóÔºåÈÅøÂÖçÊ∏ÖÁ©∫Êìç‰ΩúËÆ°ÂÖ•ÈÖçÈ¢ù
            isLoadingExample = true;
            
            markdownInput.value = '';
            updatePreview();
            updateWordCount();
            showToast('Êìç‰ΩúÂÆåÊàê', 'ÂÜÖÂÆπÂ∑≤Ê∏ÖÁ©∫');
            
            // Ê∏ÖÁ©∫ÂÆåÊàêÂêéÈáçÁΩÆÊ†áÂøó
            setTimeout(() => {
                isLoadingExample = false;
            }, 100);
        }

        // Â§çÂà∂ÂØåÊñáÊú¨ÂÜÖÂÆπ
        function copyFormattedText() {
            const markdownText = markdownInput.value.trim();
            
            if (!markdownText) {
                showToast('ÊèêÁ§∫', 'ËØ∑ÂÖàËæìÂÖ•MarkdownÂÜÖÂÆπÔºÅ', 'warning');
                return;
            }
            
            // ÊùÉÈôêÊ£ÄÊü•ÔºöÊñáÊ°£Â§ßÂ∞èÈôêÂà∂ÔºàÂ§çÂà∂ÂäüËÉΩÁõ∏ÂØπÂÆΩÊùæÔºâ
            const sizeCheck = checkDocumentSize(markdownText);
            if (!sizeCheck.allowed) {
                showUpgradePrompt(
                    'ÊñáÊ°£Â§ßÂ∞èË∂ÖÈôê',
                    `${sizeCheck.message}\nÂçáÁ∫ßË¥¶Êà∑‰ª•Â§ÑÁêÜÊõ¥Â§ßÁöÑÊñáÊ°£ÔºÅ`,
                    'size'
                );
                return;
            }
            
            // ÊùÉÈôêÊ£ÄÊü•ÔºöÊï∞Â≠¶ÂÖ¨ÂºèÊùÉÈôê
            const hasMath = /\$.*?\$|\\\(.*?\\\)|\\\[.*?\\\]|\$\$.*?\$\$/.test(markdownText);
            if (hasMath && !hasFeature('mathFormulas')) {
                showToast('ÊùÉÈôê‰∏çË∂≥', `${currentUser.name} ‰∏çÊîØÊåÅÊï∞Â≠¶ÂÖ¨ÂºèÂäüËÉΩÔºåÂ∞ÜË∑≥ËøáÂÖ¨ÂºèÊ∏≤Êüì`, 'warning');
            }

            try {
                // Ëß£Êûêmarkdown‰∏∫HTML
                const html = marked.parse(markdownText);
                
                // ÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂divÊù•Â§ÑÁêÜHTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // ÈÄâÊã©È¢ÑËßàÂå∫ÂüüÁöÑÂÜÖÂÆπ
                const range = document.createRange();
                range.selectNodeContents(preview);
                
                // Ê∏ÖÈô§‰πãÂâçÁöÑÈÄâÊã©
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                
                // Â∞ùËØïÂ§çÂà∂
                try {
                    // Áé∞‰ª£ÊµèËßàÂô®‰ΩøÁî® Clipboard API
                    if (navigator.clipboard && navigator.clipboard.write) {
                        // ÂàõÂª∫ ClipboardItemÔºåÂêåÊó∂ÂåÖÂê´HTMLÂíåÁ∫ØÊñáÊú¨
                        const clipboardItems = new ClipboardItem({
                            'text/html': new Blob([html], { type: 'text/html' }),
                            'text/plain': new Blob([preview.textContent], { type: 'text/plain' })
                        });
                        
                        navigator.clipboard.write([clipboardItems]).then(() => {
                            showToast('Â§çÂà∂ÊàêÂäü', 'ÂØåÊñáÊú¨Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
                        }).catch(() => {
                            // Â¶ÇÊûúClipboard APIÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞‰º†ÁªüÊñπÊ≥ï
                            fallbackCopy();
                        });
                    } else {
                        // ÂõûÈÄÄÂà∞‰º†ÁªüÂ§çÂà∂ÊñπÊ≥ï
                        fallbackCopy();
                    }
                } catch (error) {
                    fallbackCopy();
                }
                
                function fallbackCopy() {
                    // ‰º†ÁªüÁöÑÂ§çÂà∂ÊñπÊ≥ï
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showToast('Â§çÂà∂ÊàêÂäü', 'ÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
                    } else {
                        showToast('Â§çÂà∂Â§±Ë¥•', 'ËØ∑ÊâãÂä®ÈÄâÊã©ÂÜÖÂÆπÂêéÂ§çÂà∂', 'error');
                    }
                }
                
                // Ê∏ÖÈô§ÈÄâÊã©
                selection.removeAllRanges();
                
            } catch (error) {
                console.error('Â§çÂà∂Â§±Ë¥•:', error);
                showToast('Â§çÂà∂Â§±Ë¥•', 'ËØ∑Ê£ÄÊü•ÊÇ®ÁöÑMarkdownÊ†ºÂºèÊòØÂê¶Ê≠£Á°Æ', 'error');
            }
        }

        // ÊèêÂèñÊñáÊ°£Ê†áÈ¢òÔºàÁî®‰∫éÊñá‰ª∂ÂëΩÂêçÂíåÊñáÊ°£Â±ûÊÄßÔºâ
        function extractDocumentTitle(markdownText) {
            const firstLine = markdownText.split('\n')[0].trim();
            if (firstLine.startsWith('#')) {
                return firstLine.replace(/^#+\s*/, '').trim() || 'Êó†Ê†áÈ¢òÊñáÊ°£';
            }
            return 'Êó†Ê†áÈ¢òÊñáÊ°£';
        }

        // ÂàÜÊûêÊñáÊ°£Â§çÊùÇÂ∫¶
        function analyzeDocumentComplexity(markdownText) {
            const size = markdownText.length;
            const lines = markdownText.split('\n').length;
            const hasTables = /\|/.test(markdownText);
            const hasCodeBlocks = /```/.test(markdownText);
            const hasMath = /\$.*?\$|\\\(.*?\\\)|\\\[.*?\\\]|\$\$.*?\$\$/.test(markdownText);
            
            return {
                size: size,
                lines: lines,
                isLarge: size > 10000 || lines > 500,
                hasTables: hasTables,
                hasCodeBlocks: hasCodeBlocks,
                hasMath: hasMath
            };
        }

        // ÊòæÁ§∫WordËΩ¨Êç¢ËøõÂ∫¶
        function showWordConversionProgress(show = true) {
            const indicator = document.getElementById('wordConversionIndicator');
            if (indicator) {
                if (show) {
                    indicator.classList.add('show');
                } else {
                    indicator.classList.remove('show');
                }
            }
        }

        // Êõ¥Êñ∞WordËΩ¨Êç¢ËøõÂ∫¶
        function updateWordConversionProgress({ step, progress }) {
            const progressBar = document.querySelector('#wordConversionIndicator .progress-bar-fill');
            const progressText = document.querySelector('#wordConversionIndicator .progress-text');
            
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }
            
            if (progressText) {
                progressText.textContent = `${step}... ${progress}%`;
            }
        }

        // ÂºÇÊ≠•ËΩ¨Êç¢WordÊñáÊ°£ - ‰ºòÂåñÁî®Êà∑‰ΩìÈ™å
        async function downloadWord() {
            const markdownText = markdownInput.value.trim();
            
            if (!markdownText) {
                showToast('ÊèêÁ§∫', 'ËØ∑ÂÖàËæìÂÖ•MarkdownÂÜÖÂÆπÔºÅ', 'warning');
                return;
            }
            
            // Ê≥®ÊÑèÔºöÈÖçÈ¢ùÊ£ÄÊü•Â∑≤Âú®È¢ÑËßàÁîüÊàêÊó∂ËøõË°åÔºåÊ≠§Â§ÑÊó†ÈúÄÈáçÂ§çÊ£ÄÊü•
            
            // ÊùÉÈôêÊ£ÄÊü•2ÔºöÊ£ÄÊü•ÊñáÊ°£Â§ßÂ∞è
            const sizeCheck = checkDocumentSize(markdownText);
            if (!sizeCheck.allowed) {
                showUpgradePrompt(
                    'ÊñáÊ°£Â§ßÂ∞èË∂ÖÈôê',
                    `${sizeCheck.message}\nÂçáÁ∫ßË¥¶Êà∑‰ª•Â§ÑÁêÜÊõ¥Â§ßÁöÑÊñáÊ°£ÔºÅ`,
                    'size'
                );
                return;
            }
            
            // ÊùÉÈôêÊ£ÄÊü•3ÔºöÊ£ÄÊü•Êï∞Â≠¶ÂÖ¨ÂºèÊùÉÈôê
            const hasMath = /\$.*?\$|\\\(.*?\\\)|\\\[.*?\\\]|\$\$.*?\$\$/.test(markdownText);
            if (hasMath && !hasFeature('mathFormulas')) {
                showUpgradePrompt(
                    'Êï∞Â≠¶ÂÖ¨ÂºèÈúÄË¶ÅÂçáÁ∫ß',
                    `Ê£ÄÊµãÂà∞Êï∞Â≠¶ÂÖ¨ÂºèÔºå‰ΩÜ ${currentUser.name} ‰∏çÊîØÊåÅÊï∞Â≠¶ÂÖ¨ÂºèÂäüËÉΩ„ÄÇ\nÂçáÁ∫ßÂà∞ VIP ÊàñÊõ¥È´òÁ≠âÁ∫ßÂç≥ÂèØ‰ΩøÁî®ÔºÅ`,
                    'math'
                );
                return;
            }

            // È¢ÑÊ£ÄÊü•ÔºöÊñáÊ°£Â§ßÂ∞èÂíåÂ§çÊùÇÂ∫¶
            const complexity = analyzeDocumentComplexity(markdownText);
            if (complexity.isLarge) {
                const proceed = await showConfirm(
                    'Â§ßÊñáÊ°£ÊèêÈÜí', 
                    `Ê£ÄÊµãÂà∞ËæÉÂ§ßÁöÑÊñáÊ°£Ôºà${complexity.size}Â≠óÁ¨¶ÔºâÔºåËΩ¨Êç¢ÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊó∂Èó¥„ÄÇÊòØÂê¶ÁªßÁª≠Ôºü`,
                    'üìÑ'
                );
                if (!proceed) return;
            }

            // ÊòæÁ§∫ËΩ¨Êç¢ËøõÂ∫¶
            showWordConversionProgress(true);
            updateWordConversionProgress({ step: 'Ëß£Êûê', progress: 10 });

            try {
                // ÊèêÂèñÊñáÊ°£Ê†áÈ¢ò
                const documentTitle = extractDocumentTitle(markdownText);
                
                // ÂºÇÊ≠•Ëß£Êûêmarkdown‰∏∫HTML
                await new Promise(resolve => setTimeout(resolve, 50)); // ÁªôUI‰∏ÄÁÇπÊó∂Èó¥Êõ¥Êñ∞
                updateWordConversionProgress({ step: 'Ëß£ÊûêMarkdown', progress: 20 });
                
                const html = marked.parse(markdownText);
                
                // Â∞ÜHTMLËΩ¨Êç¢‰∏∫Á∫ØÊñáÊú¨Âπ∂‰øùÊåÅÂü∫Êú¨Ê†ºÂºè
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                updateWordConversionProgress({ step: 'Â§ÑÁêÜÊñáÊ°£ÁªìÊûÑ', progress: 40 });
                
                // ÊèêÂèñÊñáÊ°£ÂÜÖÂÆπ
                const children = [];
                
                // Â§ÑÁêÜÂêÑÁßçÂÖÉÁ¥†
                Array.from(tempDiv.children).forEach(element => {
                    const tagName = element.tagName.toLowerCase();
                    const text = element.textContent.trim();
                    
                    if (!text) return;
                    
                    switch(tagName) {
                        case 'h1':
                            children.push(new docx.Paragraph({
                                text: text,
                                heading: docx.HeadingLevel.HEADING_1,
                                spacing: { after: 200 }
                            }));
                            break;
                        case 'h2':
                            children.push(new docx.Paragraph({
                                text: text,
                                heading: docx.HeadingLevel.HEADING_2,
                                spacing: { after: 200 }
                            }));
                            break;
                        case 'h3':
                            children.push(new docx.Paragraph({
                                text: text,
                                heading: docx.HeadingLevel.HEADING_3,
                                spacing: { after: 200 }
                            }));
                            break;
                        case 'h4':
                            children.push(new docx.Paragraph({
                                text: text,
                                heading: docx.HeadingLevel.HEADING_4,
                                spacing: { after: 200 }
                            }));
                            break;
                        case 'p':
                            // Â§ÑÁêÜÊÆµËêΩ‰∏≠ÁöÑÊ†ºÂºèÔºàÈÄíÂΩíÂ§ÑÁêÜÊ∑∑ÂêàÊ†ºÂºèÔºâ
                            const runs = [];
                            
                            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´Êï∞Â≠¶ÂÖ¨Âºè
                            const mathFormulas = /\$([^$]+)\$|\\\(([^)]+)\\\)|\\\[([^\]]+)\\\]|\$\$([^$]+)\$\$/g;
                            const hasMath = mathFormulas.test(element.innerHTML);
                            if (hasMath) {
                                // Ê∑ªÂä†Êï∞Â≠¶ÂÖ¨ÂºèÊèêÁ§∫
                                runs.push(new docx.TextRun({
                                    text: "[Ê≠§ÊÆµËêΩÂåÖÂê´Êï∞Â≠¶ÂÖ¨ÂºèÔºåËØ∑Âú®Word‰∏≠ÊâãÂä®Ê∑ªÂä†ÂÖ¨Âºè] ",
                                    color: "FF6600",
                                    italics: true
                                }));
                            }
                            
                            const processNode = (node) => {
                                if (node.nodeType === Node.TEXT_NODE) {
                                    const textContent = node.textContent;
                                    if (textContent) {
                                        runs.push(new docx.TextRun(textContent));
                                    }
                                } else if (node.nodeType === Node.ELEMENT_NODE) {
                                    const tag = node.tagName.toLowerCase();
                                    
                                    // ÁâπÊÆäÂ§ÑÁêÜÈìæÊé•
                                    if (tag === 'a') {
                                        const href = node.getAttribute('href');
                                        const linkText = node.textContent;
                                        const displayText = href ? `${linkText} (${href})` : linkText;
                                        runs.push(new docx.TextRun({
                                            text: displayText,
                                            color: "0066CC",
                                            underline: {}
                                        }));
                                        return;
                                    }
                                    
                                    // ÁâπÊÆäÂ§ÑÁêÜÂõæÁâá
                                    if (tag === 'img') {
                                        const alt = node.getAttribute('alt') || 'ÂõæÁâá';
                                        const src = node.getAttribute('src') || '';
                                        runs.push(new docx.TextRun({
                                            text: `[ÂõæÁâá: ${alt}${src ? ` - ${src}` : ''}] `,
                                            color: "666666",
                                            italics: true
                                        }));
                                        return;
                                    }
                                    
                                    // ÈÄíÂΩíÂ§ÑÁêÜÂµåÂ•óÊ†áÁ≠æ
                                    if (node.childNodes.length > 0) {
                                        Array.from(node.childNodes).forEach(childNode => {
                                            if (childNode.nodeType === Node.TEXT_NODE) {
                                                const textContent = childNode.textContent;
                                                if (textContent) {
                                                    const runProps = {};
                                                    
                                                    // Ê†πÊçÆÁà∂Ê†áÁ≠æËÆæÁΩÆÊ†ºÂºè
                                                    switch(tag) {
                                                        case 'strong':
                                                        case 'b':
                                                            runProps.bold = true;
                                                            break;
                                                        case 'em':
                                                        case 'i':
                                                            runProps.italics = true;
                                                            break;
                                                        case 'code':
                                                            runProps.font = "Courier New";
                                                            runProps.highlight = "yellow";
                                                            break;
                                                        case 'u':
                                                            runProps.underline = {};
                                                            break;
                                                        case 's':
                                                        case 'del':
                                                            runProps.strike = true;
                                                            break;
                                                    }
                                                    
                                                    runs.push(new docx.TextRun({
                                                        text: textContent,
                                                        ...runProps
                                                    }));
                                                }
                                            } else if (childNode.nodeType === Node.ELEMENT_NODE) {
                                                // Â§ÑÁêÜÂµåÂ•óÊ†ºÂºèÔºàÂ¶ÇÁ≤ó‰Ωì+Êñú‰ΩìÔºâ
                                                const childTag = childNode.tagName.toLowerCase();
                                                const childText = childNode.textContent;
                                                if (childText) {
                                                    const runProps = {};
                                                    
                                                    // ÁªßÊâøÁà∂Ê†áÁ≠æÊ†ºÂºè
                                                    if (tag === 'strong' || tag === 'b') runProps.bold = true;
                                                    if (tag === 'em' || tag === 'i') runProps.italics = true;
                                                    if (tag === 'code') {
                                                        runProps.font = "Courier New";
                                                        runProps.highlight = "yellow";
                                                    }
                                                    
                                                    // Ê∑ªÂä†Â≠êÊ†áÁ≠æÊ†ºÂºè
                                                    if (childTag === 'strong' || childTag === 'b') runProps.bold = true;
                                                    if (childTag === 'em' || childTag === 'i') runProps.italics = true;
                                                    if (childTag === 'code') {
                                                        runProps.font = "Courier New";
                                                        runProps.highlight = "yellow";
                                                    }
                                                    if (childTag === 'u') runProps.underline = {};
                                                    if (childTag === 's' || childTag === 'del') runProps.strike = true;
                                                    
                                                    runs.push(new docx.TextRun({
                                                        text: childText,
                                                        ...runProps
                                                    }));
                                                }
                                            }
                                        });
                                    } else {
                                        // Ê≤°ÊúâÂ≠êËäÇÁÇπÁöÑÂÖÉÁ¥†
                                        const content = node.textContent;
                                        if (content) {
                                            const runProps = {};
                                            switch(tag) {
                                                case 'strong':
                                                case 'b':
                                                    runProps.bold = true;
                                                    break;
                                                case 'em':
                                                case 'i':
                                                    runProps.italics = true;
                                                    break;
                                                case 'code':
                                                    runProps.font = "Courier New";
                                                    runProps.highlight = "yellow";
                                                    break;
                                                case 'u':
                                                    runProps.underline = {};
                                                    break;
                                                case 's':
                                                case 'del':
                                                    runProps.strike = true;
                                                    break;
                                            }
                                            runs.push(new docx.TextRun({
                                                text: content,
                                                ...runProps
                                            }));
                                        }
                                    }
                                }
                            };
                            
                            // Â§ÑÁêÜÊâÄÊúâÂ≠êËäÇÁÇπ
                            Array.from(element.childNodes).forEach(processNode);
                            
                            // Â¶ÇÊûúÊ≤°ÊúârunsÔºå‰ΩøÁî®Á∫ØÊñáÊú¨
                            if (runs.length === 0 && text) {
                                runs.push(new docx.TextRun(text));
                            }
                            
                            if (runs.length > 0) {
                                children.push(new docx.Paragraph({
                                    children: runs,
                                    spacing: { after: 120 }
                                }));
                            }
                            break;
                        case 'ul':
                            // ÊîπËøõÁöÑÊó†Â∫èÂàóË°®Â§ÑÁêÜÔºåÊîØÊåÅÂµåÂ•ó
                            const processULItems = (listElement, level = 0) => {
                                Array.from(listElement.children).forEach(li => {
                                    if (li.tagName.toLowerCase() === 'li') {
                                        // Ëé∑ÂèñÂΩìÂâçÈ°πÁöÑÁõ¥Êé•ÊñáÊú¨ÂÜÖÂÆπ
                                        const directText = Array.from(li.childNodes)
                                            .filter(node => node.nodeType === Node.TEXT_NODE || 
                                                   (node.nodeType === Node.ELEMENT_NODE && 
                                                    !['ul', 'ol'].includes(node.tagName.toLowerCase())))
                                            .map(node => node.textContent)
                                            .join('').trim();
                                        
                                        if (directText) {
                                            children.push(new docx.Paragraph({
                                                text: directText,
                                                bullet: {
                                                    level: level
                                                },
                                                spacing: { after: 80 }
                                            }));
                                        }
                                        
                                        // Â§ÑÁêÜÂµåÂ•óÂàóË°®
                                        const nestedLists = li.querySelectorAll(':scope > ul, :scope > ol');
                                        nestedLists.forEach(nestedList => {
                                            if (nestedList.tagName.toLowerCase() === 'ul') {
                                                processULItems(nestedList, level + 1);
                                            } else {
                                                processOLItems(nestedList, level + 1);
                                            }
                                        });
                                    }
                                });
                            };
                            processULItems(element);
                            break;
                        case 'ol':
                            // ÊîπËøõÁöÑÊúâÂ∫èÂàóË°®Â§ÑÁêÜÔºåÊîØÊåÅÂµåÂ•ó
                            const processOLItems = (listElement, level = 0) => {
                                Array.from(listElement.children).forEach(li => {
                                    if (li.tagName.toLowerCase() === 'li') {
                                        // Ëé∑ÂèñÂΩìÂâçÈ°πÁöÑÁõ¥Êé•ÊñáÊú¨ÂÜÖÂÆπ
                                        const directText = Array.from(li.childNodes)
                                            .filter(node => node.nodeType === Node.TEXT_NODE || 
                                                   (node.nodeType === Node.ELEMENT_NODE && 
                                                    !['ul', 'ol'].includes(node.tagName.toLowerCase())))
                                            .map(node => node.textContent)
                                            .join('').trim();
                                        
                                        if (directText) {
                                            children.push(new docx.Paragraph({
                                                text: directText,
                                                numbering: {
                                                    reference: "default-numbering",
                                                    level: level
                                                },
                                                spacing: { after: 80 }
                                            }));
                                        }
                                        
                                        // Â§ÑÁêÜÂµåÂ•óÂàóË°®
                                        const nestedLists = li.querySelectorAll(':scope > ul, :scope > ol');
                                        nestedLists.forEach(nestedList => {
                                            if (nestedList.tagName.toLowerCase() === 'ul') {
                                                processULItems(nestedList, level + 1);
                                            } else {
                                                processOLItems(nestedList, level + 1);
                                            }
                                        });
                                    }
                                });
                            };
                            processOLItems(element);
                            break;
                        case 'blockquote':
                            children.push(new docx.Paragraph({
                                text: text,
                                indent: {
                                    left: 720
                                },
                                spacing: { after: 120 }
                            }));
                            break;
                        case 'pre':
                            // Â§ÑÁêÜ‰ª£Á†ÅÂùó
                            const codeElement = element.querySelector('code');
                            const codeText = codeElement ? codeElement.textContent : text;
                            const codeLines = codeText.split('\n');
                            
                            // Ê∑ªÂä†‰ª£Á†ÅÂùóÊ†áÈ¢ò
                            children.push(new docx.Paragraph({
                                text: "‰ª£Á†ÅÂùó:",
                                spacing: { before: 120, after: 80 },
                                run: {
                                    bold: true,
                                    color: "666666"
                                }
                            }));
                            
                            // ‰∏∫ÊØèË°å‰ª£Á†ÅÂàõÂª∫ÊÆµËêΩ
                            codeLines.forEach((line, index) => {
                                children.push(new docx.Paragraph({
                                    text: line || " ", // Á©∫Ë°åÁî®Á©∫Ê†ºÂç†‰Ωç
                                    spacing: { after: 0, before: 0 },
                                    run: {
                                        font: "Consolas",
                                        size: 18
                                    },
                                    shading: {
                                        type: docx.ShadingType.SOLID,
                                        color: "f8f8f8"
                                    },
                                    border: {
                                        left: {
                                            color: "cccccc",
                                            size: 1,
                                            type: docx.BorderStyle.SINGLE
                                        }
                                    },
                                    indent: {
                                        left: 360
                                    }
                                }));
                            });
                            
                            // ‰ª£Á†ÅÂùóÂêéÁ©∫Ë°å
                            children.push(new docx.Paragraph({
                                text: "",
                                spacing: { after: 120 }
                            }));
                            break;
                        case 'table':
                            // Â¢ûÂº∫Ë°®Ê†ºÂ§ÑÁêÜ
                            const rows = Array.from(element.querySelectorAll('tr'));
                            if (rows.length > 0) {
                                const tableRows = rows.map((row, rowIndex) => {
                                    const cells = Array.from(row.querySelectorAll('td, th'));
                                    const isHeader = row.querySelector('th') !== null || rowIndex === 0;
                                    
                                    return new docx.TableRow({
                                        children: cells.map(cell => new docx.TableCell({
                                            children: [new docx.Paragraph({
                                                text: cell.textContent.trim(),
                                                run: isHeader ? {
                                                    bold: true,
                                                    color: "2F5597"
                                                } : {}
                                            })],
                                            shading: isHeader ? {
                                                type: docx.ShadingType.SOLID,
                                                color: "F2F5FF"
                                            } : undefined,
                                            margins: {
                                                top: 120,
                                                bottom: 120,
                                                left: 120,
                                                right: 120
                                            }
                                        }))
                                    });
                                });
                                
                                children.push(new docx.Table({
                                    rows: tableRows,
                                    width: {
                                        size: 100,
                                        type: docx.WidthType.PERCENTAGE
                                    },
                                    borders: {
                                        top: { style: docx.BorderStyle.SINGLE, size: 1, color: "CCCCCC" },
                                        bottom: { style: docx.BorderStyle.SINGLE, size: 1, color: "CCCCCC" },
                                        left: { style: docx.BorderStyle.SINGLE, size: 1, color: "CCCCCC" },
                                        right: { style: docx.BorderStyle.SINGLE, size: 1, color: "CCCCCC" },
                                        insideHorizontal: { style: docx.BorderStyle.SINGLE, size: 1, color: "CCCCCC" },
                                        insideVertical: { style: docx.BorderStyle.SINGLE, size: 1, color: "CCCCCC" }
                                    }
                                }));
                                
                                // Ë°®Ê†ºÂêéÊ∑ªÂä†Á©∫Ë°å
                                children.push(new docx.Paragraph({
                                    text: "",
                                    spacing: { after: 200 }
                                }));
                            }
                            break;
                        default:
                            children.push(new docx.Paragraph({
                                text: text,
                                spacing: { after: 120 }
                            }));
                    }
                });

                // Â¶ÇÊûúÊ≤°ÊúâÂÜÖÂÆπÔºåÂàõÂª∫‰∏Ä‰∏™ÈªòËÆ§ÊÆµËêΩ
                if (children.length === 0) {
                    children.push(new docx.Paragraph("ÊñáÊ°£ÂÜÖÂÆπ"));
                }

                updateWordConversionProgress({ step: 'ÊûÑÂª∫ÊñáÊ°£', progress: 70 });
                await new Promise(resolve => setTimeout(resolve, 100)); // ÂºÇÊ≠•Èó¥Èöî

                // ÂàõÂª∫WordÊñáÊ°£
                const doc = new docx.Document({
                    creator: "MarkdownËΩ¨WordËΩ¨Êç¢Âô®",
                    title: documentTitle,
                    description: "Áî±MarkdownËΩ¨WordËΩ¨Êç¢Âô®ÁîüÊàê",
                    styles: {
                        paragraphStyles: [
                            {
                                id: "Heading1",
                                name: "Ê†áÈ¢ò 1",
                                basedOn: "Normal",
                                next: "Normal",
                                quickFormat: true,
                                run: {
                                    size: 32,
                                    bold: true,
                                    color: "2F5597"
                                },
                                paragraph: {
                                    spacing: {
                                        after: 240,
                                        before: 240
                                    }
                                }
                            },
                            {
                                id: "Heading2", 
                                name: "Ê†áÈ¢ò 2",
                                basedOn: "Normal",
                                next: "Normal",
                                quickFormat: true,
                                run: {
                                    size: 28,
                                    bold: true,
                                    color: "2F5597"
                                },
                                paragraph: {
                                    spacing: {
                                        after: 200,
                                        before: 200
                                    }
                                }
                            },
                            {
                                id: "CodeBlock",
                                name: "‰ª£Á†ÅÂùó",
                                basedOn: "Normal",
                                run: {
                                    font: "Consolas",
                                    size: 18
                                },
                                paragraph: {
                                    shading: {
                                        type: docx.ShadingType.SOLID,
                                        color: "F8F8F8"
                                    },
                                    indent: {
                                        left: 360
                                    },
                                    spacing: {
                                        after: 120
                                    }
                                }
                            }
                        ]
                    },
                    numbering: {
                        config: [
                            {
                                reference: "default-numbering",
                                levels: [
                                    {
                                        level: 0,
                                        format: docx.LevelFormat.DECIMAL,
                                        text: "%1.",
                                        alignment: docx.AlignmentType.START,
                                        style: {
                                            paragraph: {
                                                indent: { left: 720, hanging: 360 }
                                            }
                                        }
                                    },
                                    {
                                        level: 1,
                                        format: docx.LevelFormat.DECIMAL,
                                        text: "%1.%2.",
                                        alignment: docx.AlignmentType.START,
                                        style: {
                                            paragraph: {
                                                indent: { left: 1080, hanging: 360 }
                                            }
                                        }
                                    }
                                ]
                            }
                        ]
                    },
                    sections: [{
                        properties: {
                            page: {
                                margin: {
                                    top: 1440,    // 1 inch = 1440 twips
                                    right: 1440,
                                    bottom: 1440,
                                    left: 1440
                                }
                            }
                        },
                        children: children
                    }]
                });

                updateWordConversionProgress({ step: 'ÁîüÊàêÊñáÊ°£', progress: 90 });
                
                // ÂºÇÊ≠•ÁîüÊàêÂπ∂‰∏ãËΩΩÊñá‰ª∂
                try {
                    const blob = await docx.Packer.toBlob(doc);
                    
                    updateWordConversionProgress({ step: 'ÂáÜÂ§á‰∏ãËΩΩ', progress: 95 });
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    // Êô∫ËÉΩÊñá‰ª∂ÂëΩÂêç
                    const currentDate = new Date().toISOString().slice(0, 10);
                    const safeTitle = documentTitle
                        .replace(/[<>:"/\\|?*]/g, '-')  // ÊõøÊç¢ÈùûÊ≥ïÂ≠óÁ¨¶
                        .substring(0, 50);              // ÈôêÂà∂ÈïøÂ∫¶
                    const fileName = `${safeTitle}-${currentDate}.docx`;
                    
                    saveAs(blob, fileName);
                    
                    updateWordConversionProgress({ step: 'ÂÆåÊàê', progress: 100 });
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    showWordConversionProgress(false);
                    showToast('‰∏ãËΩΩÂÆåÊàê', `WordÊñáÊ°£"${safeTitle}"Â∑≤ÊàêÂäüÁîüÊàêÂπ∂‰∏ãËΩΩ`, 'success', 3000);
                    
                } catch (packError) {
                    console.error('WordÁîüÊàêÂ§±Ë¥•:', packError);
                    showWordConversionProgress(false);
                    showToast('ÁîüÊàêÂ§±Ë¥•', `WordÊñáÊ°£ÁîüÊàêËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØ: ${packError.message}`, 'error', 5000);
                }

            } catch (error) {
                console.error('ËΩ¨Êç¢Â§±Ë¥•:', error);
                showWordConversionProgress(false);
                rollbackUsage(); // ÂõûÊªöÈÖçÈ¢ù
                
                // Â¢ûÂº∫ÈîôËØØÂ§ÑÁêÜ
                let errorMessage = 'ËØ∑Ê£ÄÊü•ÊÇ®ÁöÑMarkdownÊ†ºÂºèÊòØÂê¶Ê≠£Á°Æ';
                if (error.message.includes('marked')) {
                    errorMessage = 'MarkdownËß£ÊûêÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ËØ≠Ê≥ïÊ†ºÂºè';
                } else if (error.message.includes('docx')) {
                    errorMessage = 'WordÊñáÊ°£ÁîüÊàêÂ§±Ë¥•ÔºåËØ∑ÈáçËØï';
                } else if (error.name === 'TypeError') {
                    errorMessage = 'ÊñáÊ°£ÁªìÊûÑÂºÇÂ∏∏ÔºåËØ∑ÁÆÄÂåñÂÜÖÂÆπÂêéÈáçËØï';
                }
                
                showToast('ËΩ¨Êç¢Â§±Ë¥•', errorMessage, 'error', 5000);
            }
        }

        // ‰∏ä‰º†MarkdownÊñá‰ª∂
        function uploadFile() {
            document.getElementById('fileInput').click();
        }

        // Â§ÑÁêÜÂçï‰∏™Êñá‰ª∂ÁöÑÈÄöÁî®ÂáΩÊï∞
        function processFile(file, uploadType = '‰∏ä‰º†') {
            if (!file) return;

            // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
            const allowedTypes = ['.md', '.markdown', '.txt'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedTypes.includes(fileExtension)) {
                showToast('Êñá‰ª∂Á±ªÂûãÈîôËØØ', `ËØ∑${uploadType} .md, .markdown Êàñ .txt Ê†ºÂºèÁöÑÊñá‰ª∂`, 'error');
                return;
            }

            // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞è (ÈôêÂà∂5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('Êñá‰ª∂ËøáÂ§ß', 'Êñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá5MB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // ËÆæÁΩÆÁ§∫‰æãÂä†ËΩΩÊ†áÂøóÔºåÈÅøÂÖçÊñá‰ª∂‰∏ä‰º†ËÆ°ÂÖ•ÈÖçÈ¢ù
                    isLoadingExample = true;
                    
                    markdownInput.value = e.target.result;
                    updateWordCount();
                    updatePreview();
                    showToast('‰∏ä‰º†ÊàêÂäü', `Êñá‰ª∂ ${file.name} ${uploadType}ÊàêÂäü`);
                    
                    // ‰∏ä‰º†ÂÆåÊàêÂêéÈáçÁΩÆÊ†áÂøó
                    setTimeout(() => {
                        isLoadingExample = false;
                    }, 100);
                } catch (error) {
                    console.error('Êñá‰ª∂Â§ÑÁêÜÈîôËØØ:', error);
                    showToast('Â§ÑÁêÜÂ§±Ë¥•', 'Êñá‰ª∂ÂÜÖÂÆπÂ§ÑÁêÜÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êñá‰ª∂Ê†ºÂºè', 'error');
                }
            };
            reader.onerror = function() {
                showToast('ËØªÂèñÂ§±Ë¥•', 'Êñá‰ª∂ËØªÂèñÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
            };
            reader.readAsText(file, 'UTF-8');
        }

        // Â§ÑÁêÜÊñá‰ª∂‰∏ä‰º†
        function handleFileUpload(event) {
            const file = event.target.files[0];
            processFile(file, '‰∏ä‰º†');
        }

        // ‰øùÂ≠òËçâÁ®øÂà∞Êú¨Âú∞Â≠òÂÇ®
        function saveToLocal() {
            const content = markdownInput.value;
            if (!content.trim()) {
                showToast('ÊèêÁ§∫', 'Ê≤°ÊúâÂÜÖÂÆπÂèØ‰øùÂ≠òÔºÅ', 'warning');
                return;
            }
            
            const timestamp = new Date().toLocaleString();
            localStorage.setItem('markdown-draft', content);
            localStorage.setItem('markdown-draft-timestamp', timestamp);
            showToast('‰øùÂ≠òÊàêÂäü', `ËçâÁ®øÂ∑≤‰øùÂ≠ò (${timestamp})`);
        }

        // ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩËçâÁ®ø
        async function loadFromLocal() {
            const savedContent = localStorage.getItem('markdown-draft');
            const timestamp = localStorage.getItem('markdown-draft-timestamp');
            
            if (!savedContent) {
                showToast('ÊèêÁ§∫', 'Ê≤°ÊúâÊâæÂà∞‰øùÂ≠òÁöÑËçâÁ®øÔºÅ', 'info');
                return;
            }
            
            if (markdownInput.value.trim()) {
                const confirmed = await showConfirm(
                    'Âä†ËΩΩËçâÁ®ø',
                    'ÂΩìÂâçÊúâÂÜÖÂÆπÔºåÊòØÂê¶Á°ÆËÆ§Âä†ËΩΩËçâÁ®øÔºüËøôÂ∞ÜË¶ÜÁõñÂΩìÂâçÂÜÖÂÆπ„ÄÇ',
                    'üìÇ'
                );
                if (!confirmed) return;
            }
            
            // ËÆæÁΩÆÁ§∫‰æãÂä†ËΩΩÊ†áÂøóÔºåÈÅøÂÖçËçâÁ®øÂä†ËΩΩËÆ°ÂÖ•ÈÖçÈ¢ù
            isLoadingExample = true;
            
            markdownInput.value = savedContent;
            updateWordCount();
            updatePreview();
            showToast('Âä†ËΩΩÂÆåÊàê', `ËçâÁ®øÂä†ËΩΩÊàêÂäü (${timestamp || 'Êú™Áü•'})`);
            
            // ËçâÁ®øÂä†ËΩΩÂÆåÊàêÂêéÈáçÁΩÆÊ†áÂøó
            setTimeout(() => {
                isLoadingExample = false;
            }, 100);
        }

        // Ëá™Âä®‰øùÂ≠òÂäüËÉΩÂ∑≤ÁßªÈô§ÔºåÈÅøÂÖçÂºπÁ™óÈóÆÈ¢ò

        // Ê∑ªÂä†ÊãñÊãΩ‰∏ä‰º†ÊîØÊåÅÔºàÂè™ÊúâÂú®ËÆ§ËØÅÂêéÊâçÊ∑ªÂä†Ôºâ
        function initializeDragAndDrop() {
            const markdownInput = document.getElementById('markdownInput');
            const dragOverlay = document.getElementById('dragOverlay');
            if (!markdownInput || !dragOverlay) return;

            // ÊãñÊãΩËøõÂÖ•
            markdownInput.addEventListener('dragenter', function(e) {
                e.preventDefault();
                dragOverlay.classList.add('show');
            });

            // ÊãñÊãΩÊÇ¨ÂÅú
            markdownInput.addEventListener('dragover', function(e) {
                e.preventDefault();
                dragOverlay.classList.add('show');
            });

            // ÊãñÊãΩÁ¶ªÂºÄ
            markdownInput.addEventListener('dragleave', function(e) {
                e.preventDefault();
                // Ê£ÄÊü•ÊòØÂê¶ÁúüÁöÑÁ¶ªÂºÄ‰∫ÜÊãñÊãΩÂå∫Âüü
                const rect = this.getBoundingClientRect();
                if (e.clientX < rect.left || e.clientX > rect.right || 
                    e.clientY < rect.top || e.clientY > rect.bottom) {
                    dragOverlay.classList.remove('show');
                }
            });

            // Êñá‰ª∂ÊîæÁΩÆ
            markdownInput.addEventListener('drop', function(e) {
                e.preventDefault();
                dragOverlay.classList.remove('show');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    // ÊòæÁ§∫‰∏ä‰º†ÂºÄÂßãÊèêÁ§∫
                    showToast('ÂºÄÂßã‰∏ä‰º†', `Ê≠£Âú®ËØªÂèñÊñá‰ª∂ ${file.name}...`, 'info', 1000);
                    processFile(file, 'ÊãñÊãΩ‰∏ä‰º†');
                }
            });

            // ÂÖ®Â±ÄÊãñÊãΩ‰∫ã‰ª∂Â§ÑÁêÜÔºåÈò≤Ê≠¢È°µÈù¢Âà∑Êñ∞
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                document.addEventListener(eventName, function(e) {
                    e.preventDefault();
                }, false);
            });
        }

        // Ëá™Âä®‰øùÂ≠òÂäüËÉΩÂ∑≤ÁßªÈô§

        // Ê∑ªÂä†Âø´Êç∑ÈîÆÊîØÊåÅ
        document.addEventListener('keydown', function(e) {
            // Ctrl+S ‰øùÂ≠òËçâÁ®ø
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveToLocal();
            }
            // Ctrl+O ÊâìÂºÄÊñá‰ª∂
            if (e.ctrlKey && e.key === 'o') {
                e.preventDefault();
                uploadFile();
            }
            // Ctrl+D ‰∏ãËΩΩWord
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                downloadWord();
            }
            // Ctrl+Enter Â§çÂà∂ÂØåÊñáÊú¨
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                copyFormattedText();
            }
            // Ctrl+/ ÊòæÁ§∫Âø´Êç∑ÈîÆ
            if (e.ctrlKey && e.key === '/') {
                e.preventDefault();
                showShortcuts();
            }
            // Ctrl+Q ÈÄÄÂá∫ÁôªÂΩï
            if (e.ctrlKey && e.key === 'q') {
                e.preventDefault();
                showLogoutConfirm();
            }
        });

        // ÊòæÁ§∫Âø´Êç∑ÈîÆÂ∏ÆÂä©
        function showShortcuts() {
            const shortcuts = [
                { key: 'Ctrl + S', desc: '‰øùÂ≠òËçâÁ®øÂà∞Êú¨Âú∞Â≠òÂÇ®' },
                { key: 'Ctrl + O', desc: 'ÊâìÂºÄÂπ∂‰∏ä‰º†Êñá‰ª∂' },
                { key: 'Ctrl + D', desc: '‰∏ãËΩΩWordÊñáÊ°£' },
                { key: 'Ctrl + Enter', desc: 'Â§çÂà∂ÂØåÊñáÊú¨ÂÜÖÂÆπ' },
                { key: 'Ctrl + Q', desc: 'ÈÄÄÂá∫ÁôªÂΩï' },
                { key: 'Ctrl + /', desc: 'ÊòæÁ§∫Âø´Êç∑ÈîÆÂ∏ÆÂä©' },
                { key: 'Esc', desc: 'ÂÖ≥Èó≠ÂØπËØùÊ°Ü' }
            ];
            
            const shortcutsList = shortcuts.map(item => 
                `<div style="display: flex; justify-content: space-between; margin: 8px 0; padding: 6px 0; border-bottom: 1px solid var(--border-color);">
                    <code style="background: var(--preview-bg); padding: 2px 6px; border-radius: 4px; font-weight: 600;">${item.key}</code>
                    <span style="color: var(--text-secondary);">${item.desc}</span>
                </div>`
            ).join('');
            
            showConfirm(
                '‚å®Ô∏è ÈîÆÁõòÂø´Êç∑ÈîÆ',
                `<div style="text-align: left; max-width: 400px;">${shortcutsList}</div>`,
                'üí°'
            );
        }

        // ‰∏ªÈ¢òÁÆ°ÁêÜÂäüËÉΩ
        let currentTheme = 'amber'; // ÈªòËÆ§Ê∏©ÊöñÁê•ÁèÄ‰∏ªÈ¢ò
        
        function toggleTheme(event) {
            const themes = [
                { name: 'amber', text: 'Ê∏©ÊöñÁê•ÁèÄ', dataTheme: null, bg: '#ffeaa7' },
                { name: 'classic', text: 'ÁªèÂÖ∏ÁªøËâ≤', dataTheme: 'classic', bg: '#667eea' }
            ];
            
            const currentIndex = themes.findIndex(theme => theme.name === currentTheme);
            const nextIndex = (currentIndex + 1) % themes.length;
            const nextTheme = themes[nextIndex];
            
            // Ëé∑ÂèñÈº†Ê†á‰ΩçÁΩÆ
            const rect = event.target.getBoundingClientRect();
            const x = ((rect.left + rect.width / 2) / window.innerWidth) * 100;
            const y = ((rect.top + rect.height / 2) / window.innerHeight) * 100;
            
            // ËÆæÁΩÆËøáÊ∏°ÊïàÊûúÁöÑËµ∑Âßã‰ΩçÁΩÆÂíåÈ¢úËâ≤
            const transition = document.getElementById('themeTransition');
            const themeToggle = event.target.closest('.theme-toggle');
            
            transition.style.setProperty('--mouse-x', x + '%');
            transition.style.setProperty('--mouse-y', y + '%');
            transition.style.setProperty('--new-bg', nextTheme.bg);
            
            // Ê∑ªÂä†ÂàáÊç¢Âä®ÁîªÁ±ª
            themeToggle.classList.add('switching');
            
            // ÂºÄÂßãËøáÊ∏°Âä®Áîª
            transition.classList.add('active');
            
            // Âª∂ËøüÂàáÊç¢‰∏ªÈ¢òÔºåËÆ©ËøáÊ∏°Âä®ÁîªÂÖàÂºÄÂßã
            setTimeout(() => {
                currentTheme = nextTheme.name;
                
                // Êõ¥Êñ∞bodyÁöÑdata-themeÂ±ûÊÄß
                if (nextTheme.dataTheme) {
                    document.body.setAttribute('data-theme', nextTheme.dataTheme);
                } else {
                    document.body.removeAttribute('data-theme');
                }
                
                // Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨
                document.getElementById('themeText').textContent = nextTheme.text;
                
                // ‰øùÂ≠òÂà∞localStorage
                localStorage.setItem('selectedTheme', currentTheme);
            }, 200);
            
            // ÁªìÊùüËøáÊ∏°Âä®Áîª
            setTimeout(() => {
                transition.classList.remove('active');
                themeToggle.classList.remove('switching');
                showToast('‰∏ªÈ¢òÂ∑≤ÂàáÊç¢', `Â∑≤ÂàáÊç¢Âà∞${nextTheme.text}‰∏ªÈ¢ò`);
            }, 600);
        }
        
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('selectedTheme');
            if (savedTheme && savedTheme !== 'amber') {
                currentTheme = savedTheme;
                const themes = [
                    { name: 'amber', text: 'Ê∏©ÊöñÁê•ÁèÄ', dataTheme: null },
                    { name: 'classic', text: 'ÁªèÂÖ∏ÁªøËâ≤', dataTheme: 'classic' }
                ];
                
                const theme = themes.find(t => t.name === savedTheme);
                if (theme) {
                    if (theme.dataTheme) {
                        document.body.setAttribute('data-theme', theme.dataTheme);
                    }
                    document.getElementById('themeText').textContent = theme.text;
                }
            }
        }

        // È°µÈù¢Âä†ËΩΩÊó∂Ê£ÄÊü•ËÆ§ËØÅÁä∂ÊÄÅ
        window.addEventListener('load', function() {
            checkAuthentication();
            // Âä†ËΩΩ‰øùÂ≠òÁöÑ‰∏ªÈ¢òÔºàÂú®ËÆ§ËØÅÂêéÔºâ
            setTimeout(() => {
                loadSavedTheme();
            }, 100);
            
            // È¢ùÂ§ñÁöÑÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùÂÆûÊó∂È¢ÑËßàÂäüËÉΩÊ≠£Â∏∏Â∑•‰Ωú
            setTimeout(() => {
                ensurePreviewFunctionality();
            }, 2000);
        });
        
        // Á°Æ‰øùÂÆûÊó∂È¢ÑËßàÂäüËÉΩÊ≠£Â∏∏Â∑•‰ΩúÁöÑÂÆâÂÖ®Ê£ÄÊü•
        function ensurePreviewFunctionality() {
            // Âè™ÊúâÂú®Áî®Êà∑Â∑≤ÁôªÂΩïÊó∂ÊâçËøõË°åÊ£ÄÊü•
            const isAuthenticated = sessionStorage.getItem('authenticated') === 'true';
            if (!isAuthenticated) return;
            
            const markdownInput = document.getElementById('markdownInput');
            if (!markdownInput) return;
            
            // Ê£ÄÊü•‰∫ã‰ª∂ÁªëÂÆöÊòØÂê¶ÊàêÂäü
            let hasInputListener = false;
            try {
                // ÁÆÄÂçïÁöÑÊµãËØïÔºöÊ£ÄÊü•ÊòØÂê¶Êúâinput‰∫ã‰ª∂ÁõëÂê¨Âô®
                const listeners = getEventListeners && getEventListeners(markdownInput);
                hasInputListener = listeners && listeners.input && listeners.input.length > 0;
            } catch (error) {
                // Âú®Êüê‰∫õÊµèËßàÂô®‰∏≠getEventListenersÂèØËÉΩ‰∏çÂèØÁî®ÔºåÊîπÁî®ÂÖ∂‰ªñÊñπÊ≥ïÊ£ÄÊü•
                hasInputListener = false;
            }
            
            // Â¶ÇÊûúÊ≤°ÊúâÁõëÂê¨Âô®Êàñ‰∏çÁ°ÆÂÆöÔºåÂ∞ùËØïÈáçÊñ∞ÂàùÂßãÂåñ
            if (!hasInputListener) {
                console.warn('üîß Ê£ÄÊµãÂà∞ÂÆûÊó∂È¢ÑËßàÂèØËÉΩÊú™Ê≠£Á°ÆÂàùÂßãÂåñÔºåÂ∞ùËØï‰øÆÂ§ç...');
                initializeEventBindings();
                
                // ÊòæÁ§∫Áî®Êà∑ÂèãÂ•ΩÁöÑÊèêÁ§∫
                setTimeout(() => {
                    showToast('Á≥ªÁªüÊ£ÄÊü•', 'Â∑≤Ëá™Âä®‰ºòÂåñÂÆûÊó∂È¢ÑËßàÂäüËÉΩ', 'info', 2000);
                }, 500);
            } else {
                console.log('‚úÖ ÂÆûÊó∂È¢ÑËßàÂäüËÉΩËøêË°åÊ≠£Â∏∏');
            }
        }
    </script>
</body>
</html>
